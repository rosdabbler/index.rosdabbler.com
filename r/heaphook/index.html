<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>ROS Index</title>
    <meta name="description" content="a community-maintained index of robotics software
">

    
    <link rel="canonical" href="http://index.rosdabbler.com/r/heaphook/">
    
    
    <link rel="icon" sizes="any" type="image/svg+xml" href="/assets/rosindex_logo.svg">

    

    <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/css/main.css">
    

    

    <script type="text/javascript" src=/js/jquery.js></script>
    <script src=/bootstrap/js/bootstrap.min.js type="text/javascript"></script>
    <script src=/js/jquery-cookie.js type="text/javascript"></script>
    
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EVD5Z6G6NH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EVD5Z6G6NH');
</script>

    <script type="text/javascript" src=/js/toc.js></script>

    <script src=/js/distro_switch.js></script>
  </head>

  <body>

    <header class="site-header">

  <div class="wrapper">
    <div class="container-fluid" style="margin-bottom: 10px">
      <div class="row">
        <!-- title -->
        <div class="col-xs-3" style="white-space:nowrap">
          <a class="site-title" href="/">
            <img src="/assets/rosindex_logo.svg" width="26" height="26" alt="ROS index logo" style="padding-bottom: 3px"/>
            ROS Index</a>
        </div>
        <!-- main internal links -->
        <div class="col-xs-6 text-center" style="padding:0px">
          <div class="btn-group hidden-xs" role="group" aria-label="..." style="padding: 6px">
            <div class="btn-group" role="group">
              <a href="/?search_packages=true" class="btn btn-default" role="button">Package List</a>
            </div>
            <div class="btn-group" role="group">
              <a href="/?search_repos=true" class="btn btn-default" role="button">Repository List</a>
            </div>
            <div class="btn-group" role="group">
              <a href="/search_deps" class="btn btn-default" role="button">System Dependencies</a>
            </div>
          </div>
          <div class="hidden-lg hidden-md hidden-sm">
            <button id="hLabel" class="btn btn-link dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Lists <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" aria-labelledby="hLabel">
              <li><a href="/?search_packages=true">Package List</a></li>
              <li><a href="/?search_repos=true">Repository List</a></li>
              <li><a href="/search_deps">System Dependencies</a></li>
            </ul>
          </div>
        </div>
        <!-- additional links -->
        <div class="col-xs-3 text-right" style="white-space:nowrap; padding:0px">
          <ul class="list-inline" style="margin-bottom:0px;">
            <li class="dropdown hidden-xs hidden-sm">
              <button id="rLabel" class="btn btn-link" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                ROS Resources <span class="caret"></span>
              </button>
              <ul class="dropdown-menu" role="menu" aria-labelledby="rLabel">
                <li><a href="http://docs.ros.org/">Documentation</a></li>
                <li><a href="http://wiki.ros.org/Support">Support</a></li>
                <li><a href="http://discourse.ros.org/">Discussion Forum</a></li>
                <li><a href="http://status.ros.org/">Service Status</a></li>
                <li><a href="https://robotics.stackexchange.com/questions/tagged/ros">ros @ Robotics Stack Exchange</a></li>
                <li><a href="https://docs.ros.org/en/ros2_packages/">Package API</a></li>
              </ul>
            </li>
            <li class="dropdown hidden-xs hidden-sm">
              <button id="aLabel" class="btn btn-link" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                About <span class="caret"></span>
              </button>
              <ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="aLabel">
                <li><a href="/about">About </a></li>
                <li><a href="/contribute">Contribute</a></li>
                <li><a href="/help">Help</a></li>
                <li><a href="/stats">Stats</a></li>
              </ul>
            </li>
            <li class="dropdown hidden-md hidden-lg">
              <button id="qLabel" class="btn btn-link" type="button"
                      data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Resources <span class="caret"></span>
              </button>
              <ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="qLabel">
                <li><a href="/about">About </a></li>
                <li><a href="/contribute">Contribute</a></li>
                <li><a href="/help">Help</a></li>
                <li><a href="/stats">Stats</a></li>
                <hr style="margin:7px" />
                <li><a href="http://docs.ros.org/">Documentation</a></li>
                <li><a href="http://wiki.ros.org/Support">Support</a></li>
                <li><a href="http://discourse.ros.org/">Discussion Forum</a></li>
                <li><a href="http://status.ros.org/">Service Status</a></li>
                <li><a href="https://robotics.stackexchange.com/questions/tagged/ros">ros @ Robotics Stack Exchange</a></li>
                <li><a href="https://docs.ros.org/en/ros2_packages/">Package API</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="container-fluid" style="margin-top:20px">
  <div class="container-fluid">
    <div class="row">
      <ol class="breadcrumb">
        <li><a href="/">Home</a></li>
        <li><a href="/repos">Repos</a></li>
        <li class="active">heaphook</li>
        <!--<li class="active">heaphook</li>-->
      </ol>
    </div>
    <div class="row">
      

<div id="distro-switch" class="btn-group btn-group-justified" data-toggle="buttons">
  
    <label id="humble-option" class="distro-button btn btn-xs btn-primary" href="#humble" data="humble">
      <input type="radio" name="options" id="humble-radio" autocomplete="off"> humble
    </label>
  
    <label id="jazzy-option" class="distro-button btn btn-xs btn-primary" href="#jazzy" data="jazzy">
      <input type="radio" name="options" id="jazzy-radio" autocomplete="off"> jazzy
    </label>
  
    <label id="kilted-option" class="distro-button btn btn-xs btn-primary" href="#kilted" data="kilted">
      <input type="radio" name="options" id="kilted-radio" autocomplete="off"> kilted
    </label>
  
    <label id="rolling-option" class="distro-button btn btn-xs btn-primary" href="#rolling" data="rolling">
      <input type="radio" name="options" id="rolling-radio" autocomplete="off"> rolling
    </label>
  
    <label id="github-option" class="distro-button btn btn-xs btn-default" href="#github" data="github">
      <input type="radio" name="options" id="github-radio" autocomplete="off"> github
    </label>
  
    <label id="noetic-option" class="distro-button btn btn-xs btn-default" href="#noetic" data="noetic">
      <input type="radio" name="options" id="noetic-radio" autocomplete="off"> noetic
    </label>
  

  <!-- Older distros -->
  <div class="btn-group dropdown">
    <label type="button" class="btn btn-xs dropdown-toggle btn-primary" data-toggle="dropdown" id="older-distro-button">
        <input type="radio" name="options" autocomplete="off">
      <span id="older-label">Older</span>
      <span class="caret"></span>
    </label>
    <ul class="dropdown-menu" role="menu">
      
        <li data="galactic" id="galactic-option" class="disabled older-distro-option"  href="#galactic">
          <a href="#galactic" data="galactic" id="galactic-button">galactic</a>
        </li>
      
        <li data="iron" id="iron-option" class=" older-distro-option"  href="#iron">
          <a href="#iron" data="iron" id="iron-button">iron</a>
        </li>
      
        <li data="melodic" id="melodic-option" class="disabled older-distro-option"  href="#melodic">
          <a href="#melodic" data="melodic" id="melodic-button">melodic</a>
        </li>
      
    </ul>
  </div>
</div>

    </div>
    <div class="row">
      &nbsp;
    </div>
  </div>
</div>


  <div class="distro distro-humble">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/heaphook">heaphook</a> <small>repository</small></h3>
        <span class="label label-default">ldpreload</span> <span class="label label-default">malloc</span> <span class="label label-default">ros2</span> 
        
        <a class="label label-primary pkg-label" href="/p/heaphook">heaphook</a>
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-tier4-heaphook
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-tier4-heaphook" role="menuitem" tabindex="-1" href="/r/heaphook/github-tier4-heaphook" data="github-tier4-heaphook">
                    <span class="glyphicon glyphicon-star"></span>
                    github-tier4-heaphook
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        
        <div class="panel panel-default">
          
          <div class="panel-heading"><h3 class="panel-title">Repository Summary</h3></div>
          <div class="panel-body" style="overflow-x: auto">
            
  <link rel="stylesheet" href="/css/ci-status.css">
  <table class="table table-condensed">
    <tr>
      <td class="text-right"><b>Description</b></td>
      <td><span class="label label-default">Replace all the dynamic heap allocation functions by LD_PRELOAD.</span></td>
    </tr>
    <tr>
      <td style="width:100px;" class="text-right"><b>Checkout URI</b></td>
      <td><a class="label label-default" href="https://github.com/tier4/heaphook.git">https://github.com/tier4/heaphook.git</a></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Type</b></td>
      <td><span class="label label-default">git</span></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Version</b></td>
      <td><span class="label label-default">main</span></td>
    </tr>
    <tr>
      <td style="white-space: nowrap;" class="text-right"><b>Last Updated</b></div>
      <td>
        
          <span class="label label-default"><span class="glyphicon glyphicon-time"></span> 2024-06-04
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Dev Status</b></td>
      <td>
        
          
            <span class="label label-primary">
          
          MAINTAINED
        </span>
      </td>
    </tr>
              <tr>
                <td class="text-right"><b>CI status</b></td>
                <td class="ci-status">
                  
                  
                    <span class="label label-default" title="">No Continuous Integration</span>
                  
                </td>
              </tr>
    <tr>
      <td class="text-right"><b>Released</b></td>
      <td>
        
          <span class="label label-primary"><span class="glyphicon glyphicon-flash"></span> RELEASED
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Tags</b></td>
      <td>
        
        
          <span class="label label-default">ldpreload</span> <span class="label label-default">malloc</span> <span class="label label-default">ros2</span> 
        
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Contributing</b></td>
      <td>
        <a class="label label-primary" href="/r/heaphook/#humble-contribute-lists-help-wanted">
          Help Wanted (<span class="contribute-lists-help-wanted-count">0</span>)
        </a>
        <br>
        <a class="label label-primary" href="/r/heaphook/#humble-contribute-lists-good-first-issue">
          Good First Issues (<span class="contribute-lists-good-first-issue-count">0</span>)
        </a>
        <br>
        <a class="label label-primary" href="/r/heaphook/#humble-contribute-lists-pull-requests">
          Pull Requests to Review (<span class="contribute-lists-pull-requests-count">0</span>)
        </a>
      </td>
    </tr>
  </table>

          </div>
        </div>
        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">Packages</h3></div>
          <div class="panel-body">
            
            
              <table class="table table-condensed table-hover table-striped">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Version</th>
                  </tr>
                </thead>
                <tbody>
                
                  <tr>
                    <td><a href="/p/heaphook">heaphook</a></td>
                    <td>0.1.1</td>
                  </tr>
                
                </tbody>
              </table>
            
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">README</h3></div>
          <div class="panel-body">
            
              <div class="rendered-markdown">
<h1 id="heaphook">heaphook</h1>
<p>Replace all the dynamic heap allocation functions by LD_PRELOAD.</p>

<h2 id="build-and-install">Build and Install</h2>
<p>This library <code class="language-plaintext highlighter-rouge">heaphook</code> is prepared as a <code class="language-plaintext highlighter-rouge">ament_cmake</code> package.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mkdir -p /path/to/heaphook_ws &amp;&amp; cd /path/to/heaphook_ws
$ mkdir src &amp; git clone git@github.com:tier4/heaphook.git src
$ colcon build

</code></pre></div></div>
<p>The shared libraries that will be specified in <code class="language-plaintext highlighter-rouge">LD_PRELOAD</code> are generated under <code class="language-plaintext highlighter-rouge">install/heaphook/lib</code>.
This path is added to <code class="language-plaintext highlighter-rouge">LD_LIBRARY_PATH</code> by the setup script.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ source install/setup.bash

</code></pre></div></div>

<h2 id="how-to-use">How to use</h2>
<p>For now, We provide two kinds of the heaphook libraries.</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">libpreloaded_heaptrack.so</code>: Records all the heap allocation/deallocation function calls and generate a log file for visualizing the history of heap consumption.</li>
  <li>
<code class="language-plaintext highlighter-rouge">libpreloaded_tlsf.so</code>: Replaces all the heap allocation/deallocation with TLSF (Tow-Level Segregated Fit) memory allocator.</li>
  <li>
<code class="language-plaintext highlighter-rouge">libpreloaded_backtrace.so</code>: Records all malloc/new function calls with their backtraces where the memory allocations take place.</li>
</ul>

<p>A typical use case is to utilize <code class="language-plaintext highlighter-rouge">libpreloaded_heaptrack</code> to grasp the transition and maximum value of heap consumtion of the target process
and to determine the initial allocated memory pool size for <code class="language-plaintext highlighter-rouge">libpreloaded_tlsf</code>.
Of cource, it is also useful to utilize <code class="language-plaintext highlighter-rouge">libpreloaded_heaptrack</code> just to know the heap consumption of the target process.</p>

<h3 id="libpreloaded_heaptrack">libpreloaded_heaptrack</h3>
<p>You can track the heap consumption of the specified process.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ LD_PRELOAD=libpreloaded_heaptrack.so executable

</code></pre></div></div>
<p>A log file is generated under the current working directory in the format <code class="language-plaintext highlighter-rouge">heaplog.{%pid}.log</code>.
You can visualize heap consumption transitions in PDF format based on the generated log file.
The parser depends on <code class="language-plaintext highlighter-rouge">progressbar</code> python library, so install it before.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ pip install progressbar
$ python3 heaplog_parser.py heaplog.{%pid}.log // Generates heaplog.{%pid}.pdf

</code></pre></div></div>

<h3 id="libpreloaded_tlsf">libpreloaded_tlsf</h3>
<p>You need to specify the initial allocaton size for the memory pool and the size of additional memory to be allocated
when the initial memory pool size is not sufficient.
The initial size of the memory pool should be set to a value with a margin greater than the peak heap usage of the target process.
Extending the memory pool size during the runtime should be avoided, as it leads to overhead in the allocation functions.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ LD_PRELOAD=libpreloaded_tlsf.so INITIAL_MEMPOOL_SIZE=1000000 ADDITIONAL_MEMPOOL_SIZE=1000000 executable

</code></pre></div></div>

<p>When the initial size of the memory pool is insufficient, it first allocates the additional size specified by <code class="language-plaintext highlighter-rouge">ADDITIONAL_MEMPOOL_SIZE</code>,
and if it is still insufficient, it allocates double the value of the previous allocation until it is sufficient.</p>

<p>As an example, here is what happens when <code class="language-plaintext highlighter-rouge">malloc(1000)</code> is called when the existing memory pool is exhausted and <code class="language-plaintext highlighter-rouge">ADDITIONAL_MEMPOOL_SIZE=100</code>.</p>
<ol>
  <li>100 bytes added to the memory pool (still not sufficient)</li>
  <li>200 bytes added to the memory pool (still not sufficient)</li>
  <li>400 bytes added to the memory pool (still not sufficient)</li>
  <li>800 bytes added to the memory pool (still not sufficient)</li>
  <li>1600 bytes added to the memory pool (finally sufficient)</li>
</ol>

<p>The added memory pool areas are not contiguous with each other in the virual address space,
so it is not necessarily enough even if the total size of the added memory pools exceeds the size of the memory allocation request.</p>

<h3 id="libpreloaded_backtraceso">libpreloaded_backtrace.so</h3>
<p>Use the following command to trace the callers:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ LD_PRELOAD=libpreloaded_backtrace.so executable

</code></pre></div></div>
<p>Two log files are genearted under the working directory in the format of <code class="language-plaintext highlighter-rouge">top_alloc_bytes_bt.{%pid}.{%tid}.log</code> and <code class="language-plaintext highlighter-rouge">top_num_calls_bt.{%pid}.{%tid}.log</code>. By default, top 10 callers are logged. The environment variable <code class="language-plaintext highlighter-rouge">NUM_TOPS</code> can control the number of callers. In addition, callers that just make one malloc/new are not logged as they are not the major source of page faults. To disable it, just set environment variable <code class="language-plaintext highlighter-rouge">SHOW_NON_RECURRENT_CALLERS=1</code>.</p>

<p>To show the source code file name and the line numbers, run the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ python3 backtrace_analyzer.py -i top_alloc_bytes_bt.{%pid}.{%tid}.log
or
$ python3 backtrace_analyzer.py -i top_alloc_bytes_bt.{%pid}.{%tid}.log | c++filt  // demangle C++ function names

</code></pre></div></div>

<p>The result will be more user-friendly if the executables are linked with <code class="language-plaintext highlighter-rouge">-rdynamic -no-pie -fno-pie</code> options. Or even aggressive, build your code with <code class="language-plaintext highlighter-rouge">CMAKE_BUILD_TYPE=RelWithDebInfo</code>.</p>

<h2 id="integrate-with-ros2-launch">Integrate with ROS2 launch</h2>
<p>You can easily integrate <code class="language-plaintext highlighter-rouge">heaphook</code> with ROS2 launch systems.
From the launch file, you can replace all heap allocations of the process corresponding to the targeted <code class="language-plaintext highlighter-rouge">Node</code> and <code class="language-plaintext highlighter-rouge">ComposableNodeContainer</code>.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;node</span> <span class="na">pkg=</span><span class="s">"..."</span> <span class="na">exec=</span><span class="s">"..."</span> <span class="na">name=</span><span class="s">"..."</span><span class="nt">&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"LD_PRELOAD"</span> <span class="na">value=</span><span class="s">"libpreloaded_heaptrack.so"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/node&gt;</span>

</code></pre></div></div>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;node</span> <span class="na">pkg=</span><span class="s">"..."</span> <span class="na">exec=</span><span class="s">"..."</span> <span class="na">name=</span><span class="s">"..."</span><span class="nt">&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"LD_PRELOAD"</span> <span class="na">value=</span><span class="s">"libpreloaded_tlsf.so"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"INITIAL_MEMPOOL_SIZE"</span> <span class="na">value=</span><span class="s">"100000000"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"ADDITIONAL_MEMPOOL_SIZE"</span> <span class="na">value=</span><span class="s">"100000000"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/node&gt;</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">container</span> <span class="o">=</span> <span class="nc">ComposableNodeContainer</span><span class="p">(</span>
  <span class="p">...,</span>
  <span class="n">additional_env</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">LD_PRELOAD</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">libpreloaded_heaptrack.so</span><span class="sh">"</span><span class="p">},</span>
<span class="p">)</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">container</span> <span class="o">=</span> <span class="nc">ComposableNodeContainer</span><span class="p">(</span>
  <span class="p">...,</span>
  <span class="n">additional_env</span><span class="o">=</span><span class="p">{</span>
    <span class="sh">"</span><span class="s">LD_PRELOAD</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">libpreloaded_tlsf.so</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">INITIAL_MEMPOOL_SIZE</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">100000000</span><span class="sh">"</span><span class="p">,</span> <span class="c1"># 100MB
</span>    <span class="sh">"</span><span class="s">ADDITIONAL_MEMPOOL_SIZE</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">100000000</span><span class="sh">"</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">)</span>

</code></pre></div></div>

<h2 id="how-to-add-a-new-memory-allocator">How to add a new memory allocator</h2>
<p>If you want to implement an allocator to replace the GLIBC memory allcator, you can easily do so by using this heaphook library.</p>

<p>The steps you will take are as follows.</p>
<h3 id="1-create-source-file">1. Create source file</h3>
<p>What you have to implement are</p>
<ul>
  <li>Include <code class="language-plaintext highlighter-rouge">heaphook/heaphook.hpp</code> header file.</li>
  <li>Implement your own allocator class that inherits the abstract base class <code class="language-plaintext highlighter-rouge">GlobalAllocator</code> defined in <code class="language-plaintext highlighter-rouge">heaphook/heaphook.hpp</code>.
    <ul>
      <li>This base class has 5 virtual functions: <code class="language-plaintext highlighter-rouge">do_alloc</code>, <code class="language-plaintext highlighter-rouge">do_dealloc</code>, <code class="language-plaintext highlighter-rouge">do_alloc_zeroed</code>, <code class="language-plaintext highlighter-rouge">do_realloc</code> and <code class="language-plaintext highlighter-rouge">do_get_block_size</code>.</li>
      <li>
<code class="language-plaintext highlighter-rouge">do_alloc_zeroed</code> and <code class="language-plaintext highlighter-rouge">do_realloc</code> has default implementation, so you don’t have to implement them.</li>
      <li>For more information on the GlobalAllocagor API, see here.</li>
    </ul>
  </li>
  <li>Implement static member function named <code class="language-plaintext highlighter-rouge">get_instance</code> in <code class="language-plaintext highlighter-rouge">GlobalAllocator</code>.
    <ul>
      <li>The implementation of this static member function is almost a fixed form. It defines its own allocator as a static local variable and returns a reference to its instance.</li>
      <li>See the following example for a concrete implementation.</li>
    </ul>
  </li>
</ul>

<p>The minimum implementation required is as follows.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"heaphook/heaphook.hpp"</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">heaphook</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyAllocator</span> <span class="o">:</span> <span class="k">public</span> <span class="n">GlobalAllocator</span> <span class="p">{</span>
  <span class="kt">void</span><span class="o">*</span> <span class="n">do_alloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">align</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">do_dealloc</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>

  <span class="kt">size_t</span> <span class="n">do_get_block_size</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">ptr</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="n">GlobalAllocator</span> <span class="o">&amp;</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">get_instance</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">static</span> <span class="n">MyAllocator</span> <span class="n">allocator</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">allocator</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>Save the above implementation in src/my_allocator.cpp.</p>

<h3 id="2-edit-cmakeliststxt">2. Edit CMakeLists.txt</h3>
<p>To build the implemented allocator, you must edit CMakeLists.txt.
You can use build_library cmake function to add build target.</p>

<p>build_library takes a library name as its first argument and a set of required source files as the second and subsequent arguments.</p>

<p>For example,</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">build_library</span><span class="p">(</span>my_allocator
  src/my_allocator.cpp<span class="p">)</span>

</code></pre></div></div>

<h3 id="3-build">3. Build</h3>
<p>Go to the top directory and execute the following command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>colcon build

</code></pre></div></div>
<p>If the build is successful, a file named <code class="language-plaintext highlighter-rouge">lib&lt;libname&gt;.so</code> should be created.
You can use it as follows.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source install</span>/setup.bash
<span class="nv">$ LD_PRELOAD</span><span class="o">=</span>libmy_allocator.so executable

</code></pre></div></div>

<h2 id="heaphook-api">heaphook API</h2>
<p>This section describes the <code class="language-plaintext highlighter-rouge">GlobalAllocator</code> class, which is required when creating an allocator.</p>

<p>The <code class="language-plaintext highlighter-rouge">GlobalAllocator</code> class has 5 virtual member functions.</p>
<h3 id="do_alloc">do_alloc</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_alloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">align</span><span class="p">);</span>

</code></pre></div></div>
<p>This function allocates a memory area that is larger than <code class="language-plaintext highlighter-rouge">size</code> byte and aligned with <code class="language-plaintext highlighter-rouge">align</code> and returns its address. When implementing this function, the following conditions can be assumed. (heaphook will filter out those that do not meet these conditions.)</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">size</code> &gt; 0</li>
  <li>
<code class="language-plaintext highlighter-rouge">align</code> is either
    <ul>
      <li>1, which means there are no alignment constraints.</li>
      <li>a power of 2 and multiple of <code class="language-plaintext highlighter-rouge">sizeof(void *)</code>, such as 8, 16, 32, …, 4096, …</li>
    </ul>
  </li>
</ul>

<p>If memory allocation fails due to various factors, <code class="language-plaintext highlighter-rouge">nullptr</code> should be returned.</p>

<p>This function hooks the GLIBC allocation functions <code class="language-plaintext highlighter-rouge">malloc</code>, <code class="language-plaintext highlighter-rouge">posix_memalign</code>, <code class="language-plaintext highlighter-rouge">memalign</code>, <code class="language-plaintext highlighter-rouge">aligned_alloc</code>, <code class="language-plaintext highlighter-rouge">valloc</code> and <code class="language-plaintext highlighter-rouge">pvalloc</code>.</p>

<h3 id="do_dealloc">do_dealloc</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_dealloc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

</code></pre></div></div>
<p>This function deallocates a memory area pointed to by ptr, which must have been allocated by other allocation functions <code class="language-plaintext highlighter-rouge">do_alloc</code>, <code class="language-plaintext highlighter-rouge">do_alloc_zeroed</code> or <code class="language-plaintext highlighter-rouge">do_realloc</code>. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> is the value previously returned from these allocation functions. (If not, the program may be killed.)</li>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> != <code class="language-plaintext highlighter-rouge">nullptr</code>
</li>
</ul>

<p>This function hooks the <code class="language-plaintext highlighter-rouge">free</code> function in GLIBC.</p>

<h3 id="do_alloc_zeroed">do_alloc_zeroed</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_alloc_zeroed</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>

</code></pre></div></div>
<p>This function allocates a memory area that is larger than <code class="language-plaintext highlighter-rouge">size</code> byte. The memory is set to zero. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">size</code> &gt; 0</li>
</ul>

<p>If memory allocation fails due to various factors, <code class="language-plaintext highlighter-rouge">nullptr</code> should be returned.</p>

<p>This function hooks the <code class="language-plaintext highlighter-rouge">calloc</code> function in GLIBC.</p>

<p>A default implementation is provided that calls <code class="language-plaintext highlighter-rouge">do_alloc</code> and initializes the allocated memory area with zeros using <code class="language-plaintext highlighter-rouge">memset</code>.</p>

<h3 id="do_realloc">do_realloc</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_realloc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">new_size</span><span class="p">);</span>

</code></pre></div></div>
<p>This function changes the size of the memory block pointed to by <code class="language-plaintext highlighter-rouge">ptr</code> to <code class="language-plaintext highlighter-rouge">new_size</code> bytes and return a pointer to the new memory area. The contents of the memory area must remain unchanged. When expanging the memory, the added memory does not need to be initialized. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> is the value previously returned from these allocation functions. (If not, the program may be killed.)</li>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> != <code class="language-plaintext highlighter-rouge">nullptr</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">new_size</code> &gt; 0</li>
</ul>

<p>If memory allocation fails due to various factors, <code class="language-plaintext highlighter-rouge">nullptr</code> should be returned.</p>

<p>This function hooks the <code class="language-plaintext highlighter-rouge">realloc</code> function in GLIBC.</p>

<p>A default implementation is provided that performs <code class="language-plaintext highlighter-rouge">do_alloc(new_size, 1)</code>, copies contents, and then deallocates the original pointer using <code class="language-plaintext highlighter-rouge">dealloc(ptr)</code>.</p>

<h3 id="do_get_block_size">do_get_block_size</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_get_block_size</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

</code></pre></div></div>
<p>This function returns the size of the memory block pointed to by <code class="language-plaintext highlighter-rouge">ptr</code>. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> is the value previously returned from these allocation functions. (If not, the program may be killed.)</li>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> != <code class="language-plaintext highlighter-rouge">nullptr</code>
</li>
</ul>

<p>This function is called internally when calling the GLIBC’s <code class="language-plaintext highlighter-rouge">malloc_usable_size</code>.</p>

<h2 id="trace-function">Trace function</h2>
<p>heaphook has a trace function for debugging the allocator and analyzing its performance.</p>

<p>In the CMakeList.txt file, after declaring a new allocator building rule with <code class="language-plaintext highlighter-rouge">build_library</code>, you can specify <code class="language-plaintext highlighter-rouge">target_compile_options(&lt;libname&gt; PRIVATE "-DTRACE")</code> to build library that traces the allocator’s behavior.</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">build_library</span><span class="p">(</span>my_allocator ...<span class="p">)</span>
<span class="nb">target_compile_options</span><span class="p">(</span>my_allocator PRIVATE <span class="s2">"-DTRACE"</span><span class="p">)</span>

</code></pre></div></div>
<p>If configured in this way, the library will generate a log file named <code class="language-plaintext highlighter-rouge">heaplog.&lt;pid&gt;.log</code> in the current directory. You can visualize heap consumption transitions and performance of each GlobalAllocator member functions in png format based on the generated log file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>misc/heaptrace_analyzer.py heaplog.&lt;pid&gt;.log 

</code></pre></div></div>

<h2 id="test-allocator">Test allocator</h2>
<p>To test the new memory allocator, add the following statement in CMakeLists.txt. <code class="language-plaintext highlighter-rouge">test_library(&lt;target name&gt; &lt;sources&gt;..)</code> is a cmake function which builds a test program based on Google Test.</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">test_library</span><span class="p">(</span>test_my_allocator
  src/original_allocator.cpp<span class="p">)</span>

</code></pre></div></div>
<p>After describing the above, colcon build will create a test program in build/heaphook/test_my_allocator. The source of this test program is in the file test/test_allocator.cpp, so please refer to it if necessary.</p>
</div>
            
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">CONTRIBUTING</h3></div>
          <div class="panel-body">
            
              <em>No CONTRIBUTING.md found.</em>
            
          </div>
        </div>

        
        
      
    </div>
  </div>

  <div class="distro distro-jazzy">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/heaphook">heaphook</a> <small>repository</small></h3>
        <span class="label label-default">ldpreload</span> <span class="label label-default">malloc</span> <span class="label label-default">ros2</span> 
        
        <a class="label label-primary pkg-label" href="/p/heaphook">heaphook</a>
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-tier4-heaphook
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-tier4-heaphook" role="menuitem" tabindex="-1" href="/r/heaphook/github-tier4-heaphook" data="github-tier4-heaphook">
                    <span class="glyphicon glyphicon-star"></span>
                    github-tier4-heaphook
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        
        <div class="panel panel-default">
          
          <div class="panel-heading"><h3 class="panel-title">Repository Summary</h3></div>
          <div class="panel-body" style="overflow-x: auto">
            
  <link rel="stylesheet" href="/css/ci-status.css">
  <table class="table table-condensed">
    <tr>
      <td class="text-right"><b>Description</b></td>
      <td><span class="label label-default">Replace all the dynamic heap allocation functions by LD_PRELOAD.</span></td>
    </tr>
    <tr>
      <td style="width:100px;" class="text-right"><b>Checkout URI</b></td>
      <td><a class="label label-default" href="https://github.com/tier4/heaphook.git">https://github.com/tier4/heaphook.git</a></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Type</b></td>
      <td><span class="label label-default">git</span></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Version</b></td>
      <td><span class="label label-default">main</span></td>
    </tr>
    <tr>
      <td style="white-space: nowrap;" class="text-right"><b>Last Updated</b></div>
      <td>
        
          <span class="label label-default"><span class="glyphicon glyphicon-time"></span> 2024-06-04
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Dev Status</b></td>
      <td>
        
          
            <span class="label label-primary">
          
          MAINTAINED
        </span>
      </td>
    </tr>
              <tr>
                <td class="text-right"><b>CI status</b></td>
                <td class="ci-status">
                  
                  
                    <span class="label label-default" title="">No Continuous Integration</span>
                  
                </td>
              </tr>
    <tr>
      <td class="text-right"><b>Released</b></td>
      <td>
        
          <span class="label label-primary"><span class="glyphicon glyphicon-flash"></span> RELEASED
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Tags</b></td>
      <td>
        
        
          <span class="label label-default">ldpreload</span> <span class="label label-default">malloc</span> <span class="label label-default">ros2</span> 
        
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Contributing</b></td>
      <td>
        <a class="label label-primary" href="/r/heaphook/#jazzy-contribute-lists-help-wanted">
          Help Wanted (<span class="contribute-lists-help-wanted-count">0</span>)
        </a>
        <br>
        <a class="label label-primary" href="/r/heaphook/#jazzy-contribute-lists-good-first-issue">
          Good First Issues (<span class="contribute-lists-good-first-issue-count">0</span>)
        </a>
        <br>
        <a class="label label-primary" href="/r/heaphook/#jazzy-contribute-lists-pull-requests">
          Pull Requests to Review (<span class="contribute-lists-pull-requests-count">0</span>)
        </a>
      </td>
    </tr>
  </table>

          </div>
        </div>
        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">Packages</h3></div>
          <div class="panel-body">
            
            
              <table class="table table-condensed table-hover table-striped">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Version</th>
                  </tr>
                </thead>
                <tbody>
                
                  <tr>
                    <td><a href="/p/heaphook">heaphook</a></td>
                    <td>0.1.1</td>
                  </tr>
                
                </tbody>
              </table>
            
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">README</h3></div>
          <div class="panel-body">
            
              <div class="rendered-markdown">
<h1 id="heaphook">heaphook</h1>
<p>Replace all the dynamic heap allocation functions by LD_PRELOAD.</p>

<h2 id="build-and-install">Build and Install</h2>
<p>This library <code class="language-plaintext highlighter-rouge">heaphook</code> is prepared as a <code class="language-plaintext highlighter-rouge">ament_cmake</code> package.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mkdir -p /path/to/heaphook_ws &amp;&amp; cd /path/to/heaphook_ws
$ mkdir src &amp; git clone git@github.com:tier4/heaphook.git src
$ colcon build

</code></pre></div></div>
<p>The shared libraries that will be specified in <code class="language-plaintext highlighter-rouge">LD_PRELOAD</code> are generated under <code class="language-plaintext highlighter-rouge">install/heaphook/lib</code>.
This path is added to <code class="language-plaintext highlighter-rouge">LD_LIBRARY_PATH</code> by the setup script.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ source install/setup.bash

</code></pre></div></div>

<h2 id="how-to-use">How to use</h2>
<p>For now, We provide two kinds of the heaphook libraries.</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">libpreloaded_heaptrack.so</code>: Records all the heap allocation/deallocation function calls and generate a log file for visualizing the history of heap consumption.</li>
  <li>
<code class="language-plaintext highlighter-rouge">libpreloaded_tlsf.so</code>: Replaces all the heap allocation/deallocation with TLSF (Tow-Level Segregated Fit) memory allocator.</li>
  <li>
<code class="language-plaintext highlighter-rouge">libpreloaded_backtrace.so</code>: Records all malloc/new function calls with their backtraces where the memory allocations take place.</li>
</ul>

<p>A typical use case is to utilize <code class="language-plaintext highlighter-rouge">libpreloaded_heaptrack</code> to grasp the transition and maximum value of heap consumtion of the target process
and to determine the initial allocated memory pool size for <code class="language-plaintext highlighter-rouge">libpreloaded_tlsf</code>.
Of cource, it is also useful to utilize <code class="language-plaintext highlighter-rouge">libpreloaded_heaptrack</code> just to know the heap consumption of the target process.</p>

<h3 id="libpreloaded_heaptrack">libpreloaded_heaptrack</h3>
<p>You can track the heap consumption of the specified process.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ LD_PRELOAD=libpreloaded_heaptrack.so executable

</code></pre></div></div>
<p>A log file is generated under the current working directory in the format <code class="language-plaintext highlighter-rouge">heaplog.{%pid}.log</code>.
You can visualize heap consumption transitions in PDF format based on the generated log file.
The parser depends on <code class="language-plaintext highlighter-rouge">progressbar</code> python library, so install it before.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ pip install progressbar
$ python3 heaplog_parser.py heaplog.{%pid}.log // Generates heaplog.{%pid}.pdf

</code></pre></div></div>

<h3 id="libpreloaded_tlsf">libpreloaded_tlsf</h3>
<p>You need to specify the initial allocaton size for the memory pool and the size of additional memory to be allocated
when the initial memory pool size is not sufficient.
The initial size of the memory pool should be set to a value with a margin greater than the peak heap usage of the target process.
Extending the memory pool size during the runtime should be avoided, as it leads to overhead in the allocation functions.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ LD_PRELOAD=libpreloaded_tlsf.so INITIAL_MEMPOOL_SIZE=1000000 ADDITIONAL_MEMPOOL_SIZE=1000000 executable

</code></pre></div></div>

<p>When the initial size of the memory pool is insufficient, it first allocates the additional size specified by <code class="language-plaintext highlighter-rouge">ADDITIONAL_MEMPOOL_SIZE</code>,
and if it is still insufficient, it allocates double the value of the previous allocation until it is sufficient.</p>

<p>As an example, here is what happens when <code class="language-plaintext highlighter-rouge">malloc(1000)</code> is called when the existing memory pool is exhausted and <code class="language-plaintext highlighter-rouge">ADDITIONAL_MEMPOOL_SIZE=100</code>.</p>
<ol>
  <li>100 bytes added to the memory pool (still not sufficient)</li>
  <li>200 bytes added to the memory pool (still not sufficient)</li>
  <li>400 bytes added to the memory pool (still not sufficient)</li>
  <li>800 bytes added to the memory pool (still not sufficient)</li>
  <li>1600 bytes added to the memory pool (finally sufficient)</li>
</ol>

<p>The added memory pool areas are not contiguous with each other in the virual address space,
so it is not necessarily enough even if the total size of the added memory pools exceeds the size of the memory allocation request.</p>

<h3 id="libpreloaded_backtraceso">libpreloaded_backtrace.so</h3>
<p>Use the following command to trace the callers:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ LD_PRELOAD=libpreloaded_backtrace.so executable

</code></pre></div></div>
<p>Two log files are genearted under the working directory in the format of <code class="language-plaintext highlighter-rouge">top_alloc_bytes_bt.{%pid}.{%tid}.log</code> and <code class="language-plaintext highlighter-rouge">top_num_calls_bt.{%pid}.{%tid}.log</code>. By default, top 10 callers are logged. The environment variable <code class="language-plaintext highlighter-rouge">NUM_TOPS</code> can control the number of callers. In addition, callers that just make one malloc/new are not logged as they are not the major source of page faults. To disable it, just set environment variable <code class="language-plaintext highlighter-rouge">SHOW_NON_RECURRENT_CALLERS=1</code>.</p>

<p>To show the source code file name and the line numbers, run the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ python3 backtrace_analyzer.py -i top_alloc_bytes_bt.{%pid}.{%tid}.log
or
$ python3 backtrace_analyzer.py -i top_alloc_bytes_bt.{%pid}.{%tid}.log | c++filt  // demangle C++ function names

</code></pre></div></div>

<p>The result will be more user-friendly if the executables are linked with <code class="language-plaintext highlighter-rouge">-rdynamic -no-pie -fno-pie</code> options. Or even aggressive, build your code with <code class="language-plaintext highlighter-rouge">CMAKE_BUILD_TYPE=RelWithDebInfo</code>.</p>

<h2 id="integrate-with-ros2-launch">Integrate with ROS2 launch</h2>
<p>You can easily integrate <code class="language-plaintext highlighter-rouge">heaphook</code> with ROS2 launch systems.
From the launch file, you can replace all heap allocations of the process corresponding to the targeted <code class="language-plaintext highlighter-rouge">Node</code> and <code class="language-plaintext highlighter-rouge">ComposableNodeContainer</code>.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;node</span> <span class="na">pkg=</span><span class="s">"..."</span> <span class="na">exec=</span><span class="s">"..."</span> <span class="na">name=</span><span class="s">"..."</span><span class="nt">&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"LD_PRELOAD"</span> <span class="na">value=</span><span class="s">"libpreloaded_heaptrack.so"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/node&gt;</span>

</code></pre></div></div>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;node</span> <span class="na">pkg=</span><span class="s">"..."</span> <span class="na">exec=</span><span class="s">"..."</span> <span class="na">name=</span><span class="s">"..."</span><span class="nt">&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"LD_PRELOAD"</span> <span class="na">value=</span><span class="s">"libpreloaded_tlsf.so"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"INITIAL_MEMPOOL_SIZE"</span> <span class="na">value=</span><span class="s">"100000000"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"ADDITIONAL_MEMPOOL_SIZE"</span> <span class="na">value=</span><span class="s">"100000000"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/node&gt;</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">container</span> <span class="o">=</span> <span class="nc">ComposableNodeContainer</span><span class="p">(</span>
  <span class="p">...,</span>
  <span class="n">additional_env</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">LD_PRELOAD</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">libpreloaded_heaptrack.so</span><span class="sh">"</span><span class="p">},</span>
<span class="p">)</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">container</span> <span class="o">=</span> <span class="nc">ComposableNodeContainer</span><span class="p">(</span>
  <span class="p">...,</span>
  <span class="n">additional_env</span><span class="o">=</span><span class="p">{</span>
    <span class="sh">"</span><span class="s">LD_PRELOAD</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">libpreloaded_tlsf.so</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">INITIAL_MEMPOOL_SIZE</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">100000000</span><span class="sh">"</span><span class="p">,</span> <span class="c1"># 100MB
</span>    <span class="sh">"</span><span class="s">ADDITIONAL_MEMPOOL_SIZE</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">100000000</span><span class="sh">"</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">)</span>

</code></pre></div></div>

<h2 id="how-to-add-a-new-memory-allocator">How to add a new memory allocator</h2>
<p>If you want to implement an allocator to replace the GLIBC memory allcator, you can easily do so by using this heaphook library.</p>

<p>The steps you will take are as follows.</p>
<h3 id="1-create-source-file">1. Create source file</h3>
<p>What you have to implement are</p>
<ul>
  <li>Include <code class="language-plaintext highlighter-rouge">heaphook/heaphook.hpp</code> header file.</li>
  <li>Implement your own allocator class that inherits the abstract base class <code class="language-plaintext highlighter-rouge">GlobalAllocator</code> defined in <code class="language-plaintext highlighter-rouge">heaphook/heaphook.hpp</code>.
    <ul>
      <li>This base class has 5 virtual functions: <code class="language-plaintext highlighter-rouge">do_alloc</code>, <code class="language-plaintext highlighter-rouge">do_dealloc</code>, <code class="language-plaintext highlighter-rouge">do_alloc_zeroed</code>, <code class="language-plaintext highlighter-rouge">do_realloc</code> and <code class="language-plaintext highlighter-rouge">do_get_block_size</code>.</li>
      <li>
<code class="language-plaintext highlighter-rouge">do_alloc_zeroed</code> and <code class="language-plaintext highlighter-rouge">do_realloc</code> has default implementation, so you don’t have to implement them.</li>
      <li>For more information on the GlobalAllocagor API, see here.</li>
    </ul>
  </li>
  <li>Implement static member function named <code class="language-plaintext highlighter-rouge">get_instance</code> in <code class="language-plaintext highlighter-rouge">GlobalAllocator</code>.
    <ul>
      <li>The implementation of this static member function is almost a fixed form. It defines its own allocator as a static local variable and returns a reference to its instance.</li>
      <li>See the following example for a concrete implementation.</li>
    </ul>
  </li>
</ul>

<p>The minimum implementation required is as follows.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"heaphook/heaphook.hpp"</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">heaphook</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyAllocator</span> <span class="o">:</span> <span class="k">public</span> <span class="n">GlobalAllocator</span> <span class="p">{</span>
  <span class="kt">void</span><span class="o">*</span> <span class="n">do_alloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">align</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">do_dealloc</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>

  <span class="kt">size_t</span> <span class="n">do_get_block_size</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">ptr</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="n">GlobalAllocator</span> <span class="o">&amp;</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">get_instance</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">static</span> <span class="n">MyAllocator</span> <span class="n">allocator</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">allocator</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>Save the above implementation in src/my_allocator.cpp.</p>

<h3 id="2-edit-cmakeliststxt">2. Edit CMakeLists.txt</h3>
<p>To build the implemented allocator, you must edit CMakeLists.txt.
You can use build_library cmake function to add build target.</p>

<p>build_library takes a library name as its first argument and a set of required source files as the second and subsequent arguments.</p>

<p>For example,</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">build_library</span><span class="p">(</span>my_allocator
  src/my_allocator.cpp<span class="p">)</span>

</code></pre></div></div>

<h3 id="3-build">3. Build</h3>
<p>Go to the top directory and execute the following command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>colcon build

</code></pre></div></div>
<p>If the build is successful, a file named <code class="language-plaintext highlighter-rouge">lib&lt;libname&gt;.so</code> should be created.
You can use it as follows.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source install</span>/setup.bash
<span class="nv">$ LD_PRELOAD</span><span class="o">=</span>libmy_allocator.so executable

</code></pre></div></div>

<h2 id="heaphook-api">heaphook API</h2>
<p>This section describes the <code class="language-plaintext highlighter-rouge">GlobalAllocator</code> class, which is required when creating an allocator.</p>

<p>The <code class="language-plaintext highlighter-rouge">GlobalAllocator</code> class has 5 virtual member functions.</p>
<h3 id="do_alloc">do_alloc</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_alloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">align</span><span class="p">);</span>

</code></pre></div></div>
<p>This function allocates a memory area that is larger than <code class="language-plaintext highlighter-rouge">size</code> byte and aligned with <code class="language-plaintext highlighter-rouge">align</code> and returns its address. When implementing this function, the following conditions can be assumed. (heaphook will filter out those that do not meet these conditions.)</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">size</code> &gt; 0</li>
  <li>
<code class="language-plaintext highlighter-rouge">align</code> is either
    <ul>
      <li>1, which means there are no alignment constraints.</li>
      <li>a power of 2 and multiple of <code class="language-plaintext highlighter-rouge">sizeof(void *)</code>, such as 8, 16, 32, …, 4096, …</li>
    </ul>
  </li>
</ul>

<p>If memory allocation fails due to various factors, <code class="language-plaintext highlighter-rouge">nullptr</code> should be returned.</p>

<p>This function hooks the GLIBC allocation functions <code class="language-plaintext highlighter-rouge">malloc</code>, <code class="language-plaintext highlighter-rouge">posix_memalign</code>, <code class="language-plaintext highlighter-rouge">memalign</code>, <code class="language-plaintext highlighter-rouge">aligned_alloc</code>, <code class="language-plaintext highlighter-rouge">valloc</code> and <code class="language-plaintext highlighter-rouge">pvalloc</code>.</p>

<h3 id="do_dealloc">do_dealloc</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_dealloc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

</code></pre></div></div>
<p>This function deallocates a memory area pointed to by ptr, which must have been allocated by other allocation functions <code class="language-plaintext highlighter-rouge">do_alloc</code>, <code class="language-plaintext highlighter-rouge">do_alloc_zeroed</code> or <code class="language-plaintext highlighter-rouge">do_realloc</code>. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> is the value previously returned from these allocation functions. (If not, the program may be killed.)</li>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> != <code class="language-plaintext highlighter-rouge">nullptr</code>
</li>
</ul>

<p>This function hooks the <code class="language-plaintext highlighter-rouge">free</code> function in GLIBC.</p>

<h3 id="do_alloc_zeroed">do_alloc_zeroed</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_alloc_zeroed</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>

</code></pre></div></div>
<p>This function allocates a memory area that is larger than <code class="language-plaintext highlighter-rouge">size</code> byte. The memory is set to zero. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">size</code> &gt; 0</li>
</ul>

<p>If memory allocation fails due to various factors, <code class="language-plaintext highlighter-rouge">nullptr</code> should be returned.</p>

<p>This function hooks the <code class="language-plaintext highlighter-rouge">calloc</code> function in GLIBC.</p>

<p>A default implementation is provided that calls <code class="language-plaintext highlighter-rouge">do_alloc</code> and initializes the allocated memory area with zeros using <code class="language-plaintext highlighter-rouge">memset</code>.</p>

<h3 id="do_realloc">do_realloc</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_realloc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">new_size</span><span class="p">);</span>

</code></pre></div></div>
<p>This function changes the size of the memory block pointed to by <code class="language-plaintext highlighter-rouge">ptr</code> to <code class="language-plaintext highlighter-rouge">new_size</code> bytes and return a pointer to the new memory area. The contents of the memory area must remain unchanged. When expanging the memory, the added memory does not need to be initialized. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> is the value previously returned from these allocation functions. (If not, the program may be killed.)</li>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> != <code class="language-plaintext highlighter-rouge">nullptr</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">new_size</code> &gt; 0</li>
</ul>

<p>If memory allocation fails due to various factors, <code class="language-plaintext highlighter-rouge">nullptr</code> should be returned.</p>

<p>This function hooks the <code class="language-plaintext highlighter-rouge">realloc</code> function in GLIBC.</p>

<p>A default implementation is provided that performs <code class="language-plaintext highlighter-rouge">do_alloc(new_size, 1)</code>, copies contents, and then deallocates the original pointer using <code class="language-plaintext highlighter-rouge">dealloc(ptr)</code>.</p>

<h3 id="do_get_block_size">do_get_block_size</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_get_block_size</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

</code></pre></div></div>
<p>This function returns the size of the memory block pointed to by <code class="language-plaintext highlighter-rouge">ptr</code>. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> is the value previously returned from these allocation functions. (If not, the program may be killed.)</li>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> != <code class="language-plaintext highlighter-rouge">nullptr</code>
</li>
</ul>

<p>This function is called internally when calling the GLIBC’s <code class="language-plaintext highlighter-rouge">malloc_usable_size</code>.</p>

<h2 id="trace-function">Trace function</h2>
<p>heaphook has a trace function for debugging the allocator and analyzing its performance.</p>

<p>In the CMakeList.txt file, after declaring a new allocator building rule with <code class="language-plaintext highlighter-rouge">build_library</code>, you can specify <code class="language-plaintext highlighter-rouge">target_compile_options(&lt;libname&gt; PRIVATE "-DTRACE")</code> to build library that traces the allocator’s behavior.</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">build_library</span><span class="p">(</span>my_allocator ...<span class="p">)</span>
<span class="nb">target_compile_options</span><span class="p">(</span>my_allocator PRIVATE <span class="s2">"-DTRACE"</span><span class="p">)</span>

</code></pre></div></div>
<p>If configured in this way, the library will generate a log file named <code class="language-plaintext highlighter-rouge">heaplog.&lt;pid&gt;.log</code> in the current directory. You can visualize heap consumption transitions and performance of each GlobalAllocator member functions in png format based on the generated log file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>misc/heaptrace_analyzer.py heaplog.&lt;pid&gt;.log 

</code></pre></div></div>

<h2 id="test-allocator">Test allocator</h2>
<p>To test the new memory allocator, add the following statement in CMakeLists.txt. <code class="language-plaintext highlighter-rouge">test_library(&lt;target name&gt; &lt;sources&gt;..)</code> is a cmake function which builds a test program based on Google Test.</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">test_library</span><span class="p">(</span>test_my_allocator
  src/original_allocator.cpp<span class="p">)</span>

</code></pre></div></div>
<p>After describing the above, colcon build will create a test program in build/heaphook/test_my_allocator. The source of this test program is in the file test/test_allocator.cpp, so please refer to it if necessary.</p>
</div>
            
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">CONTRIBUTING</h3></div>
          <div class="panel-body">
            
              <em>No CONTRIBUTING.md found.</em>
            
          </div>
        </div>

        
        
      
    </div>
  </div>

  <div class="distro distro-kilted">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/heaphook">heaphook</a> <small>repository</small></h3>
        <span class="label label-default">ldpreload</span> <span class="label label-default">malloc</span> <span class="label label-default">ros2</span> 
        
        <a class="label label-primary pkg-label" href="/p/heaphook">heaphook</a>
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-tier4-heaphook
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-tier4-heaphook" role="menuitem" tabindex="-1" href="/r/heaphook/github-tier4-heaphook" data="github-tier4-heaphook">
                    <span class="glyphicon glyphicon-star"></span>
                    github-tier4-heaphook
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        
        <div class="panel panel-default">
          
          <div class="panel-heading"><h3 class="panel-title">Repository Summary</h3></div>
          <div class="panel-body" style="overflow-x: auto">
            
  <link rel="stylesheet" href="/css/ci-status.css">
  <table class="table table-condensed">
    <tr>
      <td class="text-right"><b>Description</b></td>
      <td><span class="label label-default">Replace all the dynamic heap allocation functions by LD_PRELOAD.</span></td>
    </tr>
    <tr>
      <td style="width:100px;" class="text-right"><b>Checkout URI</b></td>
      <td><a class="label label-default" href="https://github.com/tier4/heaphook.git">https://github.com/tier4/heaphook.git</a></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Type</b></td>
      <td><span class="label label-default">git</span></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Version</b></td>
      <td><span class="label label-default">main</span></td>
    </tr>
    <tr>
      <td style="white-space: nowrap;" class="text-right"><b>Last Updated</b></div>
      <td>
        
          <span class="label label-default"><span class="glyphicon glyphicon-time"></span> 2024-06-04
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Dev Status</b></td>
      <td>
        
          
            <span class="label label-primary">
          
          MAINTAINED
        </span>
      </td>
    </tr>
              <tr>
                <td class="text-right"><b>CI status</b></td>
                <td class="ci-status">
                  
                  
                    <span class="label label-default" title="">No Continuous Integration</span>
                  
                </td>
              </tr>
    <tr>
      <td class="text-right"><b>Released</b></td>
      <td>
        
          <span class="label label-primary"><span class="glyphicon glyphicon-flash"></span> RELEASED
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Tags</b></td>
      <td>
        
        
          <span class="label label-default">ldpreload</span> <span class="label label-default">malloc</span> <span class="label label-default">ros2</span> 
        
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Contributing</b></td>
      <td>
        <a class="label label-primary" href="/r/heaphook/#kilted-contribute-lists-help-wanted">
          Help Wanted (<span class="contribute-lists-help-wanted-count">0</span>)
        </a>
        <br>
        <a class="label label-primary" href="/r/heaphook/#kilted-contribute-lists-good-first-issue">
          Good First Issues (<span class="contribute-lists-good-first-issue-count">0</span>)
        </a>
        <br>
        <a class="label label-primary" href="/r/heaphook/#kilted-contribute-lists-pull-requests">
          Pull Requests to Review (<span class="contribute-lists-pull-requests-count">0</span>)
        </a>
      </td>
    </tr>
  </table>

          </div>
        </div>
        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">Packages</h3></div>
          <div class="panel-body">
            
            
              <table class="table table-condensed table-hover table-striped">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Version</th>
                  </tr>
                </thead>
                <tbody>
                
                  <tr>
                    <td><a href="/p/heaphook">heaphook</a></td>
                    <td>0.1.1</td>
                  </tr>
                
                </tbody>
              </table>
            
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">README</h3></div>
          <div class="panel-body">
            
              <div class="rendered-markdown">
<h1 id="heaphook">heaphook</h1>
<p>Replace all the dynamic heap allocation functions by LD_PRELOAD.</p>

<h2 id="build-and-install">Build and Install</h2>
<p>This library <code class="language-plaintext highlighter-rouge">heaphook</code> is prepared as a <code class="language-plaintext highlighter-rouge">ament_cmake</code> package.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mkdir -p /path/to/heaphook_ws &amp;&amp; cd /path/to/heaphook_ws
$ mkdir src &amp; git clone git@github.com:tier4/heaphook.git src
$ colcon build

</code></pre></div></div>
<p>The shared libraries that will be specified in <code class="language-plaintext highlighter-rouge">LD_PRELOAD</code> are generated under <code class="language-plaintext highlighter-rouge">install/heaphook/lib</code>.
This path is added to <code class="language-plaintext highlighter-rouge">LD_LIBRARY_PATH</code> by the setup script.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ source install/setup.bash

</code></pre></div></div>

<h2 id="how-to-use">How to use</h2>
<p>For now, We provide two kinds of the heaphook libraries.</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">libpreloaded_heaptrack.so</code>: Records all the heap allocation/deallocation function calls and generate a log file for visualizing the history of heap consumption.</li>
  <li>
<code class="language-plaintext highlighter-rouge">libpreloaded_tlsf.so</code>: Replaces all the heap allocation/deallocation with TLSF (Tow-Level Segregated Fit) memory allocator.</li>
  <li>
<code class="language-plaintext highlighter-rouge">libpreloaded_backtrace.so</code>: Records all malloc/new function calls with their backtraces where the memory allocations take place.</li>
</ul>

<p>A typical use case is to utilize <code class="language-plaintext highlighter-rouge">libpreloaded_heaptrack</code> to grasp the transition and maximum value of heap consumtion of the target process
and to determine the initial allocated memory pool size for <code class="language-plaintext highlighter-rouge">libpreloaded_tlsf</code>.
Of cource, it is also useful to utilize <code class="language-plaintext highlighter-rouge">libpreloaded_heaptrack</code> just to know the heap consumption of the target process.</p>

<h3 id="libpreloaded_heaptrack">libpreloaded_heaptrack</h3>
<p>You can track the heap consumption of the specified process.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ LD_PRELOAD=libpreloaded_heaptrack.so executable

</code></pre></div></div>
<p>A log file is generated under the current working directory in the format <code class="language-plaintext highlighter-rouge">heaplog.{%pid}.log</code>.
You can visualize heap consumption transitions in PDF format based on the generated log file.
The parser depends on <code class="language-plaintext highlighter-rouge">progressbar</code> python library, so install it before.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ pip install progressbar
$ python3 heaplog_parser.py heaplog.{%pid}.log // Generates heaplog.{%pid}.pdf

</code></pre></div></div>

<h3 id="libpreloaded_tlsf">libpreloaded_tlsf</h3>
<p>You need to specify the initial allocaton size for the memory pool and the size of additional memory to be allocated
when the initial memory pool size is not sufficient.
The initial size of the memory pool should be set to a value with a margin greater than the peak heap usage of the target process.
Extending the memory pool size during the runtime should be avoided, as it leads to overhead in the allocation functions.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ LD_PRELOAD=libpreloaded_tlsf.so INITIAL_MEMPOOL_SIZE=1000000 ADDITIONAL_MEMPOOL_SIZE=1000000 executable

</code></pre></div></div>

<p>When the initial size of the memory pool is insufficient, it first allocates the additional size specified by <code class="language-plaintext highlighter-rouge">ADDITIONAL_MEMPOOL_SIZE</code>,
and if it is still insufficient, it allocates double the value of the previous allocation until it is sufficient.</p>

<p>As an example, here is what happens when <code class="language-plaintext highlighter-rouge">malloc(1000)</code> is called when the existing memory pool is exhausted and <code class="language-plaintext highlighter-rouge">ADDITIONAL_MEMPOOL_SIZE=100</code>.</p>
<ol>
  <li>100 bytes added to the memory pool (still not sufficient)</li>
  <li>200 bytes added to the memory pool (still not sufficient)</li>
  <li>400 bytes added to the memory pool (still not sufficient)</li>
  <li>800 bytes added to the memory pool (still not sufficient)</li>
  <li>1600 bytes added to the memory pool (finally sufficient)</li>
</ol>

<p>The added memory pool areas are not contiguous with each other in the virual address space,
so it is not necessarily enough even if the total size of the added memory pools exceeds the size of the memory allocation request.</p>

<h3 id="libpreloaded_backtraceso">libpreloaded_backtrace.so</h3>
<p>Use the following command to trace the callers:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ LD_PRELOAD=libpreloaded_backtrace.so executable

</code></pre></div></div>
<p>Two log files are genearted under the working directory in the format of <code class="language-plaintext highlighter-rouge">top_alloc_bytes_bt.{%pid}.{%tid}.log</code> and <code class="language-plaintext highlighter-rouge">top_num_calls_bt.{%pid}.{%tid}.log</code>. By default, top 10 callers are logged. The environment variable <code class="language-plaintext highlighter-rouge">NUM_TOPS</code> can control the number of callers. In addition, callers that just make one malloc/new are not logged as they are not the major source of page faults. To disable it, just set environment variable <code class="language-plaintext highlighter-rouge">SHOW_NON_RECURRENT_CALLERS=1</code>.</p>

<p>To show the source code file name and the line numbers, run the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ python3 backtrace_analyzer.py -i top_alloc_bytes_bt.{%pid}.{%tid}.log
or
$ python3 backtrace_analyzer.py -i top_alloc_bytes_bt.{%pid}.{%tid}.log | c++filt  // demangle C++ function names

</code></pre></div></div>

<p>The result will be more user-friendly if the executables are linked with <code class="language-plaintext highlighter-rouge">-rdynamic -no-pie -fno-pie</code> options. Or even aggressive, build your code with <code class="language-plaintext highlighter-rouge">CMAKE_BUILD_TYPE=RelWithDebInfo</code>.</p>

<h2 id="integrate-with-ros2-launch">Integrate with ROS2 launch</h2>
<p>You can easily integrate <code class="language-plaintext highlighter-rouge">heaphook</code> with ROS2 launch systems.
From the launch file, you can replace all heap allocations of the process corresponding to the targeted <code class="language-plaintext highlighter-rouge">Node</code> and <code class="language-plaintext highlighter-rouge">ComposableNodeContainer</code>.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;node</span> <span class="na">pkg=</span><span class="s">"..."</span> <span class="na">exec=</span><span class="s">"..."</span> <span class="na">name=</span><span class="s">"..."</span><span class="nt">&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"LD_PRELOAD"</span> <span class="na">value=</span><span class="s">"libpreloaded_heaptrack.so"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/node&gt;</span>

</code></pre></div></div>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;node</span> <span class="na">pkg=</span><span class="s">"..."</span> <span class="na">exec=</span><span class="s">"..."</span> <span class="na">name=</span><span class="s">"..."</span><span class="nt">&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"LD_PRELOAD"</span> <span class="na">value=</span><span class="s">"libpreloaded_tlsf.so"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"INITIAL_MEMPOOL_SIZE"</span> <span class="na">value=</span><span class="s">"100000000"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"ADDITIONAL_MEMPOOL_SIZE"</span> <span class="na">value=</span><span class="s">"100000000"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/node&gt;</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">container</span> <span class="o">=</span> <span class="nc">ComposableNodeContainer</span><span class="p">(</span>
  <span class="p">...,</span>
  <span class="n">additional_env</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">LD_PRELOAD</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">libpreloaded_heaptrack.so</span><span class="sh">"</span><span class="p">},</span>
<span class="p">)</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">container</span> <span class="o">=</span> <span class="nc">ComposableNodeContainer</span><span class="p">(</span>
  <span class="p">...,</span>
  <span class="n">additional_env</span><span class="o">=</span><span class="p">{</span>
    <span class="sh">"</span><span class="s">LD_PRELOAD</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">libpreloaded_tlsf.so</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">INITIAL_MEMPOOL_SIZE</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">100000000</span><span class="sh">"</span><span class="p">,</span> <span class="c1"># 100MB
</span>    <span class="sh">"</span><span class="s">ADDITIONAL_MEMPOOL_SIZE</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">100000000</span><span class="sh">"</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">)</span>

</code></pre></div></div>

<h2 id="how-to-add-a-new-memory-allocator">How to add a new memory allocator</h2>
<p>If you want to implement an allocator to replace the GLIBC memory allcator, you can easily do so by using this heaphook library.</p>

<p>The steps you will take are as follows.</p>
<h3 id="1-create-source-file">1. Create source file</h3>
<p>What you have to implement are</p>
<ul>
  <li>Include <code class="language-plaintext highlighter-rouge">heaphook/heaphook.hpp</code> header file.</li>
  <li>Implement your own allocator class that inherits the abstract base class <code class="language-plaintext highlighter-rouge">GlobalAllocator</code> defined in <code class="language-plaintext highlighter-rouge">heaphook/heaphook.hpp</code>.
    <ul>
      <li>This base class has 5 virtual functions: <code class="language-plaintext highlighter-rouge">do_alloc</code>, <code class="language-plaintext highlighter-rouge">do_dealloc</code>, <code class="language-plaintext highlighter-rouge">do_alloc_zeroed</code>, <code class="language-plaintext highlighter-rouge">do_realloc</code> and <code class="language-plaintext highlighter-rouge">do_get_block_size</code>.</li>
      <li>
<code class="language-plaintext highlighter-rouge">do_alloc_zeroed</code> and <code class="language-plaintext highlighter-rouge">do_realloc</code> has default implementation, so you don’t have to implement them.</li>
      <li>For more information on the GlobalAllocagor API, see here.</li>
    </ul>
  </li>
  <li>Implement static member function named <code class="language-plaintext highlighter-rouge">get_instance</code> in <code class="language-plaintext highlighter-rouge">GlobalAllocator</code>.
    <ul>
      <li>The implementation of this static member function is almost a fixed form. It defines its own allocator as a static local variable and returns a reference to its instance.</li>
      <li>See the following example for a concrete implementation.</li>
    </ul>
  </li>
</ul>

<p>The minimum implementation required is as follows.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"heaphook/heaphook.hpp"</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">heaphook</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyAllocator</span> <span class="o">:</span> <span class="k">public</span> <span class="n">GlobalAllocator</span> <span class="p">{</span>
  <span class="kt">void</span><span class="o">*</span> <span class="n">do_alloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">align</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">do_dealloc</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>

  <span class="kt">size_t</span> <span class="n">do_get_block_size</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">ptr</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="n">GlobalAllocator</span> <span class="o">&amp;</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">get_instance</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">static</span> <span class="n">MyAllocator</span> <span class="n">allocator</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">allocator</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>Save the above implementation in src/my_allocator.cpp.</p>

<h3 id="2-edit-cmakeliststxt">2. Edit CMakeLists.txt</h3>
<p>To build the implemented allocator, you must edit CMakeLists.txt.
You can use build_library cmake function to add build target.</p>

<p>build_library takes a library name as its first argument and a set of required source files as the second and subsequent arguments.</p>

<p>For example,</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">build_library</span><span class="p">(</span>my_allocator
  src/my_allocator.cpp<span class="p">)</span>

</code></pre></div></div>

<h3 id="3-build">3. Build</h3>
<p>Go to the top directory and execute the following command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>colcon build

</code></pre></div></div>
<p>If the build is successful, a file named <code class="language-plaintext highlighter-rouge">lib&lt;libname&gt;.so</code> should be created.
You can use it as follows.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source install</span>/setup.bash
<span class="nv">$ LD_PRELOAD</span><span class="o">=</span>libmy_allocator.so executable

</code></pre></div></div>

<h2 id="heaphook-api">heaphook API</h2>
<p>This section describes the <code class="language-plaintext highlighter-rouge">GlobalAllocator</code> class, which is required when creating an allocator.</p>

<p>The <code class="language-plaintext highlighter-rouge">GlobalAllocator</code> class has 5 virtual member functions.</p>
<h3 id="do_alloc">do_alloc</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_alloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">align</span><span class="p">);</span>

</code></pre></div></div>
<p>This function allocates a memory area that is larger than <code class="language-plaintext highlighter-rouge">size</code> byte and aligned with <code class="language-plaintext highlighter-rouge">align</code> and returns its address. When implementing this function, the following conditions can be assumed. (heaphook will filter out those that do not meet these conditions.)</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">size</code> &gt; 0</li>
  <li>
<code class="language-plaintext highlighter-rouge">align</code> is either
    <ul>
      <li>1, which means there are no alignment constraints.</li>
      <li>a power of 2 and multiple of <code class="language-plaintext highlighter-rouge">sizeof(void *)</code>, such as 8, 16, 32, …, 4096, …</li>
    </ul>
  </li>
</ul>

<p>If memory allocation fails due to various factors, <code class="language-plaintext highlighter-rouge">nullptr</code> should be returned.</p>

<p>This function hooks the GLIBC allocation functions <code class="language-plaintext highlighter-rouge">malloc</code>, <code class="language-plaintext highlighter-rouge">posix_memalign</code>, <code class="language-plaintext highlighter-rouge">memalign</code>, <code class="language-plaintext highlighter-rouge">aligned_alloc</code>, <code class="language-plaintext highlighter-rouge">valloc</code> and <code class="language-plaintext highlighter-rouge">pvalloc</code>.</p>

<h3 id="do_dealloc">do_dealloc</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_dealloc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

</code></pre></div></div>
<p>This function deallocates a memory area pointed to by ptr, which must have been allocated by other allocation functions <code class="language-plaintext highlighter-rouge">do_alloc</code>, <code class="language-plaintext highlighter-rouge">do_alloc_zeroed</code> or <code class="language-plaintext highlighter-rouge">do_realloc</code>. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> is the value previously returned from these allocation functions. (If not, the program may be killed.)</li>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> != <code class="language-plaintext highlighter-rouge">nullptr</code>
</li>
</ul>

<p>This function hooks the <code class="language-plaintext highlighter-rouge">free</code> function in GLIBC.</p>

<h3 id="do_alloc_zeroed">do_alloc_zeroed</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_alloc_zeroed</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>

</code></pre></div></div>
<p>This function allocates a memory area that is larger than <code class="language-plaintext highlighter-rouge">size</code> byte. The memory is set to zero. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">size</code> &gt; 0</li>
</ul>

<p>If memory allocation fails due to various factors, <code class="language-plaintext highlighter-rouge">nullptr</code> should be returned.</p>

<p>This function hooks the <code class="language-plaintext highlighter-rouge">calloc</code> function in GLIBC.</p>

<p>A default implementation is provided that calls <code class="language-plaintext highlighter-rouge">do_alloc</code> and initializes the allocated memory area with zeros using <code class="language-plaintext highlighter-rouge">memset</code>.</p>

<h3 id="do_realloc">do_realloc</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_realloc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">new_size</span><span class="p">);</span>

</code></pre></div></div>
<p>This function changes the size of the memory block pointed to by <code class="language-plaintext highlighter-rouge">ptr</code> to <code class="language-plaintext highlighter-rouge">new_size</code> bytes and return a pointer to the new memory area. The contents of the memory area must remain unchanged. When expanging the memory, the added memory does not need to be initialized. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> is the value previously returned from these allocation functions. (If not, the program may be killed.)</li>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> != <code class="language-plaintext highlighter-rouge">nullptr</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">new_size</code> &gt; 0</li>
</ul>

<p>If memory allocation fails due to various factors, <code class="language-plaintext highlighter-rouge">nullptr</code> should be returned.</p>

<p>This function hooks the <code class="language-plaintext highlighter-rouge">realloc</code> function in GLIBC.</p>

<p>A default implementation is provided that performs <code class="language-plaintext highlighter-rouge">do_alloc(new_size, 1)</code>, copies contents, and then deallocates the original pointer using <code class="language-plaintext highlighter-rouge">dealloc(ptr)</code>.</p>

<h3 id="do_get_block_size">do_get_block_size</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_get_block_size</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

</code></pre></div></div>
<p>This function returns the size of the memory block pointed to by <code class="language-plaintext highlighter-rouge">ptr</code>. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> is the value previously returned from these allocation functions. (If not, the program may be killed.)</li>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> != <code class="language-plaintext highlighter-rouge">nullptr</code>
</li>
</ul>

<p>This function is called internally when calling the GLIBC’s <code class="language-plaintext highlighter-rouge">malloc_usable_size</code>.</p>

<h2 id="trace-function">Trace function</h2>
<p>heaphook has a trace function for debugging the allocator and analyzing its performance.</p>

<p>In the CMakeList.txt file, after declaring a new allocator building rule with <code class="language-plaintext highlighter-rouge">build_library</code>, you can specify <code class="language-plaintext highlighter-rouge">target_compile_options(&lt;libname&gt; PRIVATE "-DTRACE")</code> to build library that traces the allocator’s behavior.</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">build_library</span><span class="p">(</span>my_allocator ...<span class="p">)</span>
<span class="nb">target_compile_options</span><span class="p">(</span>my_allocator PRIVATE <span class="s2">"-DTRACE"</span><span class="p">)</span>

</code></pre></div></div>
<p>If configured in this way, the library will generate a log file named <code class="language-plaintext highlighter-rouge">heaplog.&lt;pid&gt;.log</code> in the current directory. You can visualize heap consumption transitions and performance of each GlobalAllocator member functions in png format based on the generated log file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>misc/heaptrace_analyzer.py heaplog.&lt;pid&gt;.log 

</code></pre></div></div>

<h2 id="test-allocator">Test allocator</h2>
<p>To test the new memory allocator, add the following statement in CMakeLists.txt. <code class="language-plaintext highlighter-rouge">test_library(&lt;target name&gt; &lt;sources&gt;..)</code> is a cmake function which builds a test program based on Google Test.</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">test_library</span><span class="p">(</span>test_my_allocator
  src/original_allocator.cpp<span class="p">)</span>

</code></pre></div></div>
<p>After describing the above, colcon build will create a test program in build/heaphook/test_my_allocator. The source of this test program is in the file test/test_allocator.cpp, so please refer to it if necessary.</p>
</div>
            
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">CONTRIBUTING</h3></div>
          <div class="panel-body">
            
              <em>No CONTRIBUTING.md found.</em>
            
          </div>
        </div>

        
        
      
    </div>
  </div>

  <div class="distro distro-rolling">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/heaphook">heaphook</a> <small>repository</small></h3>
        <span class="label label-default">ldpreload</span> <span class="label label-default">malloc</span> <span class="label label-default">ros2</span> 
        
        <a class="label label-primary pkg-label" href="/p/heaphook">heaphook</a>
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-tier4-heaphook
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-tier4-heaphook" role="menuitem" tabindex="-1" href="/r/heaphook/github-tier4-heaphook" data="github-tier4-heaphook">
                    <span class="glyphicon glyphicon-star"></span>
                    github-tier4-heaphook
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        
        <div class="panel panel-default">
          
          <div class="panel-heading"><h3 class="panel-title">Repository Summary</h3></div>
          <div class="panel-body" style="overflow-x: auto">
            
  <link rel="stylesheet" href="/css/ci-status.css">
  <table class="table table-condensed">
    <tr>
      <td class="text-right"><b>Description</b></td>
      <td><span class="label label-default">Replace all the dynamic heap allocation functions by LD_PRELOAD.</span></td>
    </tr>
    <tr>
      <td style="width:100px;" class="text-right"><b>Checkout URI</b></td>
      <td><a class="label label-default" href="https://github.com/tier4/heaphook.git">https://github.com/tier4/heaphook.git</a></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Type</b></td>
      <td><span class="label label-default">git</span></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Version</b></td>
      <td><span class="label label-default">main</span></td>
    </tr>
    <tr>
      <td style="white-space: nowrap;" class="text-right"><b>Last Updated</b></div>
      <td>
        
          <span class="label label-default"><span class="glyphicon glyphicon-time"></span> 2024-06-04
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Dev Status</b></td>
      <td>
        
          
            <span class="label label-primary">
          
          MAINTAINED
        </span>
      </td>
    </tr>
              <tr>
                <td class="text-right"><b>CI status</b></td>
                <td class="ci-status">
                  
                  
                    <span class="label label-default" title="">No Continuous Integration</span>
                  
                </td>
              </tr>
    <tr>
      <td class="text-right"><b>Released</b></td>
      <td>
        
          <span class="label label-primary"><span class="glyphicon glyphicon-flash"></span> RELEASED
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Tags</b></td>
      <td>
        
        
          <span class="label label-default">ldpreload</span> <span class="label label-default">malloc</span> <span class="label label-default">ros2</span> 
        
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Contributing</b></td>
      <td>
        <a class="label label-primary" href="/r/heaphook/#rolling-contribute-lists-help-wanted">
          Help Wanted (<span class="contribute-lists-help-wanted-count">0</span>)
        </a>
        <br>
        <a class="label label-primary" href="/r/heaphook/#rolling-contribute-lists-good-first-issue">
          Good First Issues (<span class="contribute-lists-good-first-issue-count">0</span>)
        </a>
        <br>
        <a class="label label-primary" href="/r/heaphook/#rolling-contribute-lists-pull-requests">
          Pull Requests to Review (<span class="contribute-lists-pull-requests-count">0</span>)
        </a>
      </td>
    </tr>
  </table>

          </div>
        </div>
        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">Packages</h3></div>
          <div class="panel-body">
            
            
              <table class="table table-condensed table-hover table-striped">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Version</th>
                  </tr>
                </thead>
                <tbody>
                
                  <tr>
                    <td><a href="/p/heaphook">heaphook</a></td>
                    <td>0.1.1</td>
                  </tr>
                
                </tbody>
              </table>
            
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">README</h3></div>
          <div class="panel-body">
            
              <div class="rendered-markdown">
<h1 id="heaphook">heaphook</h1>
<p>Replace all the dynamic heap allocation functions by LD_PRELOAD.</p>

<h2 id="build-and-install">Build and Install</h2>
<p>This library <code class="language-plaintext highlighter-rouge">heaphook</code> is prepared as a <code class="language-plaintext highlighter-rouge">ament_cmake</code> package.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mkdir -p /path/to/heaphook_ws &amp;&amp; cd /path/to/heaphook_ws
$ mkdir src &amp; git clone git@github.com:tier4/heaphook.git src
$ colcon build

</code></pre></div></div>
<p>The shared libraries that will be specified in <code class="language-plaintext highlighter-rouge">LD_PRELOAD</code> are generated under <code class="language-plaintext highlighter-rouge">install/heaphook/lib</code>.
This path is added to <code class="language-plaintext highlighter-rouge">LD_LIBRARY_PATH</code> by the setup script.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ source install/setup.bash

</code></pre></div></div>

<h2 id="how-to-use">How to use</h2>
<p>For now, We provide two kinds of the heaphook libraries.</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">libpreloaded_heaptrack.so</code>: Records all the heap allocation/deallocation function calls and generate a log file for visualizing the history of heap consumption.</li>
  <li>
<code class="language-plaintext highlighter-rouge">libpreloaded_tlsf.so</code>: Replaces all the heap allocation/deallocation with TLSF (Tow-Level Segregated Fit) memory allocator.</li>
  <li>
<code class="language-plaintext highlighter-rouge">libpreloaded_backtrace.so</code>: Records all malloc/new function calls with their backtraces where the memory allocations take place.</li>
</ul>

<p>A typical use case is to utilize <code class="language-plaintext highlighter-rouge">libpreloaded_heaptrack</code> to grasp the transition and maximum value of heap consumtion of the target process
and to determine the initial allocated memory pool size for <code class="language-plaintext highlighter-rouge">libpreloaded_tlsf</code>.
Of cource, it is also useful to utilize <code class="language-plaintext highlighter-rouge">libpreloaded_heaptrack</code> just to know the heap consumption of the target process.</p>

<h3 id="libpreloaded_heaptrack">libpreloaded_heaptrack</h3>
<p>You can track the heap consumption of the specified process.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ LD_PRELOAD=libpreloaded_heaptrack.so executable

</code></pre></div></div>
<p>A log file is generated under the current working directory in the format <code class="language-plaintext highlighter-rouge">heaplog.{%pid}.log</code>.
You can visualize heap consumption transitions in PDF format based on the generated log file.
The parser depends on <code class="language-plaintext highlighter-rouge">progressbar</code> python library, so install it before.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ pip install progressbar
$ python3 heaplog_parser.py heaplog.{%pid}.log // Generates heaplog.{%pid}.pdf

</code></pre></div></div>

<h3 id="libpreloaded_tlsf">libpreloaded_tlsf</h3>
<p>You need to specify the initial allocaton size for the memory pool and the size of additional memory to be allocated
when the initial memory pool size is not sufficient.
The initial size of the memory pool should be set to a value with a margin greater than the peak heap usage of the target process.
Extending the memory pool size during the runtime should be avoided, as it leads to overhead in the allocation functions.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ LD_PRELOAD=libpreloaded_tlsf.so INITIAL_MEMPOOL_SIZE=1000000 ADDITIONAL_MEMPOOL_SIZE=1000000 executable

</code></pre></div></div>

<p>When the initial size of the memory pool is insufficient, it first allocates the additional size specified by <code class="language-plaintext highlighter-rouge">ADDITIONAL_MEMPOOL_SIZE</code>,
and if it is still insufficient, it allocates double the value of the previous allocation until it is sufficient.</p>

<p>As an example, here is what happens when <code class="language-plaintext highlighter-rouge">malloc(1000)</code> is called when the existing memory pool is exhausted and <code class="language-plaintext highlighter-rouge">ADDITIONAL_MEMPOOL_SIZE=100</code>.</p>
<ol>
  <li>100 bytes added to the memory pool (still not sufficient)</li>
  <li>200 bytes added to the memory pool (still not sufficient)</li>
  <li>400 bytes added to the memory pool (still not sufficient)</li>
  <li>800 bytes added to the memory pool (still not sufficient)</li>
  <li>1600 bytes added to the memory pool (finally sufficient)</li>
</ol>

<p>The added memory pool areas are not contiguous with each other in the virual address space,
so it is not necessarily enough even if the total size of the added memory pools exceeds the size of the memory allocation request.</p>

<h3 id="libpreloaded_backtraceso">libpreloaded_backtrace.so</h3>
<p>Use the following command to trace the callers:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ LD_PRELOAD=libpreloaded_backtrace.so executable

</code></pre></div></div>
<p>Two log files are genearted under the working directory in the format of <code class="language-plaintext highlighter-rouge">top_alloc_bytes_bt.{%pid}.{%tid}.log</code> and <code class="language-plaintext highlighter-rouge">top_num_calls_bt.{%pid}.{%tid}.log</code>. By default, top 10 callers are logged. The environment variable <code class="language-plaintext highlighter-rouge">NUM_TOPS</code> can control the number of callers. In addition, callers that just make one malloc/new are not logged as they are not the major source of page faults. To disable it, just set environment variable <code class="language-plaintext highlighter-rouge">SHOW_NON_RECURRENT_CALLERS=1</code>.</p>

<p>To show the source code file name and the line numbers, run the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ python3 backtrace_analyzer.py -i top_alloc_bytes_bt.{%pid}.{%tid}.log
or
$ python3 backtrace_analyzer.py -i top_alloc_bytes_bt.{%pid}.{%tid}.log | c++filt  // demangle C++ function names

</code></pre></div></div>

<p>The result will be more user-friendly if the executables are linked with <code class="language-plaintext highlighter-rouge">-rdynamic -no-pie -fno-pie</code> options. Or even aggressive, build your code with <code class="language-plaintext highlighter-rouge">CMAKE_BUILD_TYPE=RelWithDebInfo</code>.</p>

<h2 id="integrate-with-ros2-launch">Integrate with ROS2 launch</h2>
<p>You can easily integrate <code class="language-plaintext highlighter-rouge">heaphook</code> with ROS2 launch systems.
From the launch file, you can replace all heap allocations of the process corresponding to the targeted <code class="language-plaintext highlighter-rouge">Node</code> and <code class="language-plaintext highlighter-rouge">ComposableNodeContainer</code>.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;node</span> <span class="na">pkg=</span><span class="s">"..."</span> <span class="na">exec=</span><span class="s">"..."</span> <span class="na">name=</span><span class="s">"..."</span><span class="nt">&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"LD_PRELOAD"</span> <span class="na">value=</span><span class="s">"libpreloaded_heaptrack.so"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/node&gt;</span>

</code></pre></div></div>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;node</span> <span class="na">pkg=</span><span class="s">"..."</span> <span class="na">exec=</span><span class="s">"..."</span> <span class="na">name=</span><span class="s">"..."</span><span class="nt">&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"LD_PRELOAD"</span> <span class="na">value=</span><span class="s">"libpreloaded_tlsf.so"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"INITIAL_MEMPOOL_SIZE"</span> <span class="na">value=</span><span class="s">"100000000"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"ADDITIONAL_MEMPOOL_SIZE"</span> <span class="na">value=</span><span class="s">"100000000"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/node&gt;</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">container</span> <span class="o">=</span> <span class="nc">ComposableNodeContainer</span><span class="p">(</span>
  <span class="p">...,</span>
  <span class="n">additional_env</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">LD_PRELOAD</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">libpreloaded_heaptrack.so</span><span class="sh">"</span><span class="p">},</span>
<span class="p">)</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">container</span> <span class="o">=</span> <span class="nc">ComposableNodeContainer</span><span class="p">(</span>
  <span class="p">...,</span>
  <span class="n">additional_env</span><span class="o">=</span><span class="p">{</span>
    <span class="sh">"</span><span class="s">LD_PRELOAD</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">libpreloaded_tlsf.so</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">INITIAL_MEMPOOL_SIZE</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">100000000</span><span class="sh">"</span><span class="p">,</span> <span class="c1"># 100MB
</span>    <span class="sh">"</span><span class="s">ADDITIONAL_MEMPOOL_SIZE</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">100000000</span><span class="sh">"</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">)</span>

</code></pre></div></div>

<h2 id="how-to-add-a-new-memory-allocator">How to add a new memory allocator</h2>
<p>If you want to implement an allocator to replace the GLIBC memory allcator, you can easily do so by using this heaphook library.</p>

<p>The steps you will take are as follows.</p>
<h3 id="1-create-source-file">1. Create source file</h3>
<p>What you have to implement are</p>
<ul>
  <li>Include <code class="language-plaintext highlighter-rouge">heaphook/heaphook.hpp</code> header file.</li>
  <li>Implement your own allocator class that inherits the abstract base class <code class="language-plaintext highlighter-rouge">GlobalAllocator</code> defined in <code class="language-plaintext highlighter-rouge">heaphook/heaphook.hpp</code>.
    <ul>
      <li>This base class has 5 virtual functions: <code class="language-plaintext highlighter-rouge">do_alloc</code>, <code class="language-plaintext highlighter-rouge">do_dealloc</code>, <code class="language-plaintext highlighter-rouge">do_alloc_zeroed</code>, <code class="language-plaintext highlighter-rouge">do_realloc</code> and <code class="language-plaintext highlighter-rouge">do_get_block_size</code>.</li>
      <li>
<code class="language-plaintext highlighter-rouge">do_alloc_zeroed</code> and <code class="language-plaintext highlighter-rouge">do_realloc</code> has default implementation, so you don’t have to implement them.</li>
      <li>For more information on the GlobalAllocagor API, see here.</li>
    </ul>
  </li>
  <li>Implement static member function named <code class="language-plaintext highlighter-rouge">get_instance</code> in <code class="language-plaintext highlighter-rouge">GlobalAllocator</code>.
    <ul>
      <li>The implementation of this static member function is almost a fixed form. It defines its own allocator as a static local variable and returns a reference to its instance.</li>
      <li>See the following example for a concrete implementation.</li>
    </ul>
  </li>
</ul>

<p>The minimum implementation required is as follows.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"heaphook/heaphook.hpp"</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">heaphook</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyAllocator</span> <span class="o">:</span> <span class="k">public</span> <span class="n">GlobalAllocator</span> <span class="p">{</span>
  <span class="kt">void</span><span class="o">*</span> <span class="n">do_alloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">align</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">do_dealloc</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>

  <span class="kt">size_t</span> <span class="n">do_get_block_size</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">ptr</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="n">GlobalAllocator</span> <span class="o">&amp;</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">get_instance</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">static</span> <span class="n">MyAllocator</span> <span class="n">allocator</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">allocator</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>Save the above implementation in src/my_allocator.cpp.</p>

<h3 id="2-edit-cmakeliststxt">2. Edit CMakeLists.txt</h3>
<p>To build the implemented allocator, you must edit CMakeLists.txt.
You can use build_library cmake function to add build target.</p>

<p>build_library takes a library name as its first argument and a set of required source files as the second and subsequent arguments.</p>

<p>For example,</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">build_library</span><span class="p">(</span>my_allocator
  src/my_allocator.cpp<span class="p">)</span>

</code></pre></div></div>

<h3 id="3-build">3. Build</h3>
<p>Go to the top directory and execute the following command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>colcon build

</code></pre></div></div>
<p>If the build is successful, a file named <code class="language-plaintext highlighter-rouge">lib&lt;libname&gt;.so</code> should be created.
You can use it as follows.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source install</span>/setup.bash
<span class="nv">$ LD_PRELOAD</span><span class="o">=</span>libmy_allocator.so executable

</code></pre></div></div>

<h2 id="heaphook-api">heaphook API</h2>
<p>This section describes the <code class="language-plaintext highlighter-rouge">GlobalAllocator</code> class, which is required when creating an allocator.</p>

<p>The <code class="language-plaintext highlighter-rouge">GlobalAllocator</code> class has 5 virtual member functions.</p>
<h3 id="do_alloc">do_alloc</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_alloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">align</span><span class="p">);</span>

</code></pre></div></div>
<p>This function allocates a memory area that is larger than <code class="language-plaintext highlighter-rouge">size</code> byte and aligned with <code class="language-plaintext highlighter-rouge">align</code> and returns its address. When implementing this function, the following conditions can be assumed. (heaphook will filter out those that do not meet these conditions.)</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">size</code> &gt; 0</li>
  <li>
<code class="language-plaintext highlighter-rouge">align</code> is either
    <ul>
      <li>1, which means there are no alignment constraints.</li>
      <li>a power of 2 and multiple of <code class="language-plaintext highlighter-rouge">sizeof(void *)</code>, such as 8, 16, 32, …, 4096, …</li>
    </ul>
  </li>
</ul>

<p>If memory allocation fails due to various factors, <code class="language-plaintext highlighter-rouge">nullptr</code> should be returned.</p>

<p>This function hooks the GLIBC allocation functions <code class="language-plaintext highlighter-rouge">malloc</code>, <code class="language-plaintext highlighter-rouge">posix_memalign</code>, <code class="language-plaintext highlighter-rouge">memalign</code>, <code class="language-plaintext highlighter-rouge">aligned_alloc</code>, <code class="language-plaintext highlighter-rouge">valloc</code> and <code class="language-plaintext highlighter-rouge">pvalloc</code>.</p>

<h3 id="do_dealloc">do_dealloc</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_dealloc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

</code></pre></div></div>
<p>This function deallocates a memory area pointed to by ptr, which must have been allocated by other allocation functions <code class="language-plaintext highlighter-rouge">do_alloc</code>, <code class="language-plaintext highlighter-rouge">do_alloc_zeroed</code> or <code class="language-plaintext highlighter-rouge">do_realloc</code>. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> is the value previously returned from these allocation functions. (If not, the program may be killed.)</li>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> != <code class="language-plaintext highlighter-rouge">nullptr</code>
</li>
</ul>

<p>This function hooks the <code class="language-plaintext highlighter-rouge">free</code> function in GLIBC.</p>

<h3 id="do_alloc_zeroed">do_alloc_zeroed</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_alloc_zeroed</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>

</code></pre></div></div>
<p>This function allocates a memory area that is larger than <code class="language-plaintext highlighter-rouge">size</code> byte. The memory is set to zero. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">size</code> &gt; 0</li>
</ul>

<p>If memory allocation fails due to various factors, <code class="language-plaintext highlighter-rouge">nullptr</code> should be returned.</p>

<p>This function hooks the <code class="language-plaintext highlighter-rouge">calloc</code> function in GLIBC.</p>

<p>A default implementation is provided that calls <code class="language-plaintext highlighter-rouge">do_alloc</code> and initializes the allocated memory area with zeros using <code class="language-plaintext highlighter-rouge">memset</code>.</p>

<h3 id="do_realloc">do_realloc</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_realloc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">new_size</span><span class="p">);</span>

</code></pre></div></div>
<p>This function changes the size of the memory block pointed to by <code class="language-plaintext highlighter-rouge">ptr</code> to <code class="language-plaintext highlighter-rouge">new_size</code> bytes and return a pointer to the new memory area. The contents of the memory area must remain unchanged. When expanging the memory, the added memory does not need to be initialized. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> is the value previously returned from these allocation functions. (If not, the program may be killed.)</li>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> != <code class="language-plaintext highlighter-rouge">nullptr</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">new_size</code> &gt; 0</li>
</ul>

<p>If memory allocation fails due to various factors, <code class="language-plaintext highlighter-rouge">nullptr</code> should be returned.</p>

<p>This function hooks the <code class="language-plaintext highlighter-rouge">realloc</code> function in GLIBC.</p>

<p>A default implementation is provided that performs <code class="language-plaintext highlighter-rouge">do_alloc(new_size, 1)</code>, copies contents, and then deallocates the original pointer using <code class="language-plaintext highlighter-rouge">dealloc(ptr)</code>.</p>

<h3 id="do_get_block_size">do_get_block_size</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_get_block_size</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

</code></pre></div></div>
<p>This function returns the size of the memory block pointed to by <code class="language-plaintext highlighter-rouge">ptr</code>. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> is the value previously returned from these allocation functions. (If not, the program may be killed.)</li>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> != <code class="language-plaintext highlighter-rouge">nullptr</code>
</li>
</ul>

<p>This function is called internally when calling the GLIBC’s <code class="language-plaintext highlighter-rouge">malloc_usable_size</code>.</p>

<h2 id="trace-function">Trace function</h2>
<p>heaphook has a trace function for debugging the allocator and analyzing its performance.</p>

<p>In the CMakeList.txt file, after declaring a new allocator building rule with <code class="language-plaintext highlighter-rouge">build_library</code>, you can specify <code class="language-plaintext highlighter-rouge">target_compile_options(&lt;libname&gt; PRIVATE "-DTRACE")</code> to build library that traces the allocator’s behavior.</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">build_library</span><span class="p">(</span>my_allocator ...<span class="p">)</span>
<span class="nb">target_compile_options</span><span class="p">(</span>my_allocator PRIVATE <span class="s2">"-DTRACE"</span><span class="p">)</span>

</code></pre></div></div>
<p>If configured in this way, the library will generate a log file named <code class="language-plaintext highlighter-rouge">heaplog.&lt;pid&gt;.log</code> in the current directory. You can visualize heap consumption transitions and performance of each GlobalAllocator member functions in png format based on the generated log file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>misc/heaptrace_analyzer.py heaplog.&lt;pid&gt;.log 

</code></pre></div></div>

<h2 id="test-allocator">Test allocator</h2>
<p>To test the new memory allocator, add the following statement in CMakeLists.txt. <code class="language-plaintext highlighter-rouge">test_library(&lt;target name&gt; &lt;sources&gt;..)</code> is a cmake function which builds a test program based on Google Test.</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">test_library</span><span class="p">(</span>test_my_allocator
  src/original_allocator.cpp<span class="p">)</span>

</code></pre></div></div>
<p>After describing the above, colcon build will create a test program in build/heaphook/test_my_allocator. The source of this test program is in the file test/test_allocator.cpp, so please refer to it if necessary.</p>
</div>
            
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">CONTRIBUTING</h3></div>
          <div class="panel-body">
            
              <em>No CONTRIBUTING.md found.</em>
            
          </div>
        </div>

        
        
      
    </div>
  </div>

  <div class="distro distro-github">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/heaphook">heaphook</a> <small>repository</small></h3>
        <span class="label label-default">ldpreload</span> <span class="label label-default">malloc</span> <span class="label label-default">ros2</span> 
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-tier4-heaphook
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-tier4-heaphook" role="menuitem" tabindex="-1" href="/r/heaphook/github-tier4-heaphook" data="github-tier4-heaphook">
                    <span class="glyphicon glyphicon-star"></span>
                    github-tier4-heaphook
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        <div class="alert alert-warning" role="alert">No version for distro <strong>github</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-noetic">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/heaphook">heaphook</a> <small>repository</small></h3>
        <span class="label label-default">ldpreload</span> <span class="label label-default">malloc</span> <span class="label label-default">ros2</span> 
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-tier4-heaphook
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-tier4-heaphook" role="menuitem" tabindex="-1" href="/r/heaphook/github-tier4-heaphook" data="github-tier4-heaphook">
                    <span class="glyphicon glyphicon-star"></span>
                    github-tier4-heaphook
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        <div class="alert alert-warning" role="alert">No version for distro <strong>noetic</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-galactic">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/heaphook">heaphook</a> <small>repository</small></h3>
        <span class="label label-default">ldpreload</span> <span class="label label-default">malloc</span> <span class="label label-default">ros2</span> 
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-tier4-heaphook
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-tier4-heaphook" role="menuitem" tabindex="-1" href="/r/heaphook/github-tier4-heaphook" data="github-tier4-heaphook">
                    <span class="glyphicon glyphicon-star"></span>
                    github-tier4-heaphook
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        <div class="alert alert-warning" role="alert">No version for distro <strong>galactic</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-iron">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/heaphook">heaphook</a> <small>repository</small></h3>
        <span class="label label-default">ldpreload</span> <span class="label label-default">malloc</span> <span class="label label-default">ros2</span> 
        
        <a class="label label-primary pkg-label" href="/p/heaphook">heaphook</a>
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-tier4-heaphook
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-tier4-heaphook" role="menuitem" tabindex="-1" href="/r/heaphook/github-tier4-heaphook" data="github-tier4-heaphook">
                    <span class="glyphicon glyphicon-star"></span>
                    github-tier4-heaphook
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        
        <div class="panel panel-default">
          
          <div class="panel-heading"><h3 class="panel-title">Repository Summary</h3></div>
          <div class="panel-body" style="overflow-x: auto">
            
  <link rel="stylesheet" href="/css/ci-status.css">
  <table class="table table-condensed">
    <tr>
      <td class="text-right"><b>Description</b></td>
      <td><span class="label label-default">Replace all the dynamic heap allocation functions by LD_PRELOAD.</span></td>
    </tr>
    <tr>
      <td style="width:100px;" class="text-right"><b>Checkout URI</b></td>
      <td><a class="label label-default" href="https://github.com/tier4/heaphook.git">https://github.com/tier4/heaphook.git</a></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Type</b></td>
      <td><span class="label label-default">git</span></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Version</b></td>
      <td><span class="label label-default">main</span></td>
    </tr>
    <tr>
      <td style="white-space: nowrap;" class="text-right"><b>Last Updated</b></div>
      <td>
        
          <span class="label label-default"><span class="glyphicon glyphicon-time"></span> 2024-06-04
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Dev Status</b></td>
      <td>
        
          
            <span class="label label-primary">
          
          MAINTAINED
        </span>
      </td>
    </tr>
              <tr>
                <td class="text-right"><b>CI status</b></td>
                <td class="ci-status">
                  
                  
                    <span class="label label-default" title="">No Continuous Integration</span>
                  
                </td>
              </tr>
    <tr>
      <td class="text-right"><b>Released</b></td>
      <td>
        
          <span class="label label-primary"><span class="glyphicon glyphicon-flash"></span> RELEASED
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Tags</b></td>
      <td>
        
        
          <span class="label label-default">ldpreload</span> <span class="label label-default">malloc</span> <span class="label label-default">ros2</span> 
        
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Contributing</b></td>
      <td>
        <a class="label label-primary" href="/r/heaphook/#iron-contribute-lists-help-wanted">
          Help Wanted (<span class="contribute-lists-help-wanted-count">0</span>)
        </a>
        <br>
        <a class="label label-primary" href="/r/heaphook/#iron-contribute-lists-good-first-issue">
          Good First Issues (<span class="contribute-lists-good-first-issue-count">0</span>)
        </a>
        <br>
        <a class="label label-primary" href="/r/heaphook/#iron-contribute-lists-pull-requests">
          Pull Requests to Review (<span class="contribute-lists-pull-requests-count">0</span>)
        </a>
      </td>
    </tr>
  </table>

          </div>
        </div>
        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">Packages</h3></div>
          <div class="panel-body">
            
            
              <table class="table table-condensed table-hover table-striped">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Version</th>
                  </tr>
                </thead>
                <tbody>
                
                  <tr>
                    <td><a href="/p/heaphook">heaphook</a></td>
                    <td>0.1.1</td>
                  </tr>
                
                </tbody>
              </table>
            
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">README</h3></div>
          <div class="panel-body">
            
              <div class="rendered-markdown">
<h1 id="heaphook">heaphook</h1>
<p>Replace all the dynamic heap allocation functions by LD_PRELOAD.</p>

<h2 id="build-and-install">Build and Install</h2>
<p>This library <code class="language-plaintext highlighter-rouge">heaphook</code> is prepared as a <code class="language-plaintext highlighter-rouge">ament_cmake</code> package.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mkdir -p /path/to/heaphook_ws &amp;&amp; cd /path/to/heaphook_ws
$ mkdir src &amp; git clone git@github.com:tier4/heaphook.git src
$ colcon build

</code></pre></div></div>
<p>The shared libraries that will be specified in <code class="language-plaintext highlighter-rouge">LD_PRELOAD</code> are generated under <code class="language-plaintext highlighter-rouge">install/heaphook/lib</code>.
This path is added to <code class="language-plaintext highlighter-rouge">LD_LIBRARY_PATH</code> by the setup script.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ source install/setup.bash

</code></pre></div></div>

<h2 id="how-to-use">How to use</h2>
<p>For now, We provide two kinds of the heaphook libraries.</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">libpreloaded_heaptrack.so</code>: Records all the heap allocation/deallocation function calls and generate a log file for visualizing the history of heap consumption.</li>
  <li>
<code class="language-plaintext highlighter-rouge">libpreloaded_tlsf.so</code>: Replaces all the heap allocation/deallocation with TLSF (Tow-Level Segregated Fit) memory allocator.</li>
  <li>
<code class="language-plaintext highlighter-rouge">libpreloaded_backtrace.so</code>: Records all malloc/new function calls with their backtraces where the memory allocations take place.</li>
</ul>

<p>A typical use case is to utilize <code class="language-plaintext highlighter-rouge">libpreloaded_heaptrack</code> to grasp the transition and maximum value of heap consumtion of the target process
and to determine the initial allocated memory pool size for <code class="language-plaintext highlighter-rouge">libpreloaded_tlsf</code>.
Of cource, it is also useful to utilize <code class="language-plaintext highlighter-rouge">libpreloaded_heaptrack</code> just to know the heap consumption of the target process.</p>

<h3 id="libpreloaded_heaptrack">libpreloaded_heaptrack</h3>
<p>You can track the heap consumption of the specified process.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ LD_PRELOAD=libpreloaded_heaptrack.so executable

</code></pre></div></div>
<p>A log file is generated under the current working directory in the format <code class="language-plaintext highlighter-rouge">heaplog.{%pid}.log</code>.
You can visualize heap consumption transitions in PDF format based on the generated log file.
The parser depends on <code class="language-plaintext highlighter-rouge">progressbar</code> python library, so install it before.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ pip install progressbar
$ python3 heaplog_parser.py heaplog.{%pid}.log // Generates heaplog.{%pid}.pdf

</code></pre></div></div>

<h3 id="libpreloaded_tlsf">libpreloaded_tlsf</h3>
<p>You need to specify the initial allocaton size for the memory pool and the size of additional memory to be allocated
when the initial memory pool size is not sufficient.
The initial size of the memory pool should be set to a value with a margin greater than the peak heap usage of the target process.
Extending the memory pool size during the runtime should be avoided, as it leads to overhead in the allocation functions.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ LD_PRELOAD=libpreloaded_tlsf.so INITIAL_MEMPOOL_SIZE=1000000 ADDITIONAL_MEMPOOL_SIZE=1000000 executable

</code></pre></div></div>

<p>When the initial size of the memory pool is insufficient, it first allocates the additional size specified by <code class="language-plaintext highlighter-rouge">ADDITIONAL_MEMPOOL_SIZE</code>,
and if it is still insufficient, it allocates double the value of the previous allocation until it is sufficient.</p>

<p>As an example, here is what happens when <code class="language-plaintext highlighter-rouge">malloc(1000)</code> is called when the existing memory pool is exhausted and <code class="language-plaintext highlighter-rouge">ADDITIONAL_MEMPOOL_SIZE=100</code>.</p>
<ol>
  <li>100 bytes added to the memory pool (still not sufficient)</li>
  <li>200 bytes added to the memory pool (still not sufficient)</li>
  <li>400 bytes added to the memory pool (still not sufficient)</li>
  <li>800 bytes added to the memory pool (still not sufficient)</li>
  <li>1600 bytes added to the memory pool (finally sufficient)</li>
</ol>

<p>The added memory pool areas are not contiguous with each other in the virual address space,
so it is not necessarily enough even if the total size of the added memory pools exceeds the size of the memory allocation request.</p>

<h3 id="libpreloaded_backtraceso">libpreloaded_backtrace.so</h3>
<p>Use the following command to trace the callers:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ LD_PRELOAD=libpreloaded_backtrace.so executable

</code></pre></div></div>
<p>Two log files are genearted under the working directory in the format of <code class="language-plaintext highlighter-rouge">top_alloc_bytes_bt.{%pid}.{%tid}.log</code> and <code class="language-plaintext highlighter-rouge">top_num_calls_bt.{%pid}.{%tid}.log</code>. By default, top 10 callers are logged. The environment variable <code class="language-plaintext highlighter-rouge">NUM_TOPS</code> can control the number of callers. In addition, callers that just make one malloc/new are not logged as they are not the major source of page faults. To disable it, just set environment variable <code class="language-plaintext highlighter-rouge">SHOW_NON_RECURRENT_CALLERS=1</code>.</p>

<p>To show the source code file name and the line numbers, run the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ python3 backtrace_analyzer.py -i top_alloc_bytes_bt.{%pid}.{%tid}.log
or
$ python3 backtrace_analyzer.py -i top_alloc_bytes_bt.{%pid}.{%tid}.log | c++filt  // demangle C++ function names

</code></pre></div></div>

<p>The result will be more user-friendly if the executables are linked with <code class="language-plaintext highlighter-rouge">-rdynamic -no-pie -fno-pie</code> options. Or even aggressive, build your code with <code class="language-plaintext highlighter-rouge">CMAKE_BUILD_TYPE=RelWithDebInfo</code>.</p>

<h2 id="integrate-with-ros2-launch">Integrate with ROS2 launch</h2>
<p>You can easily integrate <code class="language-plaintext highlighter-rouge">heaphook</code> with ROS2 launch systems.
From the launch file, you can replace all heap allocations of the process corresponding to the targeted <code class="language-plaintext highlighter-rouge">Node</code> and <code class="language-plaintext highlighter-rouge">ComposableNodeContainer</code>.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;node</span> <span class="na">pkg=</span><span class="s">"..."</span> <span class="na">exec=</span><span class="s">"..."</span> <span class="na">name=</span><span class="s">"..."</span><span class="nt">&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"LD_PRELOAD"</span> <span class="na">value=</span><span class="s">"libpreloaded_heaptrack.so"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/node&gt;</span>

</code></pre></div></div>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;node</span> <span class="na">pkg=</span><span class="s">"..."</span> <span class="na">exec=</span><span class="s">"..."</span> <span class="na">name=</span><span class="s">"..."</span><span class="nt">&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"LD_PRELOAD"</span> <span class="na">value=</span><span class="s">"libpreloaded_tlsf.so"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"INITIAL_MEMPOOL_SIZE"</span> <span class="na">value=</span><span class="s">"100000000"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;env</span> <span class="na">name=</span><span class="s">"ADDITIONAL_MEMPOOL_SIZE"</span> <span class="na">value=</span><span class="s">"100000000"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/node&gt;</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">container</span> <span class="o">=</span> <span class="nc">ComposableNodeContainer</span><span class="p">(</span>
  <span class="p">...,</span>
  <span class="n">additional_env</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">LD_PRELOAD</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">libpreloaded_heaptrack.so</span><span class="sh">"</span><span class="p">},</span>
<span class="p">)</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">container</span> <span class="o">=</span> <span class="nc">ComposableNodeContainer</span><span class="p">(</span>
  <span class="p">...,</span>
  <span class="n">additional_env</span><span class="o">=</span><span class="p">{</span>
    <span class="sh">"</span><span class="s">LD_PRELOAD</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">libpreloaded_tlsf.so</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">INITIAL_MEMPOOL_SIZE</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">100000000</span><span class="sh">"</span><span class="p">,</span> <span class="c1"># 100MB
</span>    <span class="sh">"</span><span class="s">ADDITIONAL_MEMPOOL_SIZE</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">100000000</span><span class="sh">"</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">)</span>

</code></pre></div></div>

<h2 id="how-to-add-a-new-memory-allocator">How to add a new memory allocator</h2>
<p>If you want to implement an allocator to replace the GLIBC memory allcator, you can easily do so by using this heaphook library.</p>

<p>The steps you will take are as follows.</p>
<h3 id="1-create-source-file">1. Create source file</h3>
<p>What you have to implement are</p>
<ul>
  <li>Include <code class="language-plaintext highlighter-rouge">heaphook/heaphook.hpp</code> header file.</li>
  <li>Implement your own allocator class that inherits the abstract base class <code class="language-plaintext highlighter-rouge">GlobalAllocator</code> defined in <code class="language-plaintext highlighter-rouge">heaphook/heaphook.hpp</code>.
    <ul>
      <li>This base class has 5 virtual functions: <code class="language-plaintext highlighter-rouge">do_alloc</code>, <code class="language-plaintext highlighter-rouge">do_dealloc</code>, <code class="language-plaintext highlighter-rouge">do_alloc_zeroed</code>, <code class="language-plaintext highlighter-rouge">do_realloc</code> and <code class="language-plaintext highlighter-rouge">do_get_block_size</code>.</li>
      <li>
<code class="language-plaintext highlighter-rouge">do_alloc_zeroed</code> and <code class="language-plaintext highlighter-rouge">do_realloc</code> has default implementation, so you don’t have to implement them.</li>
      <li>For more information on the GlobalAllocagor API, see here.</li>
    </ul>
  </li>
  <li>Implement static member function named <code class="language-plaintext highlighter-rouge">get_instance</code> in <code class="language-plaintext highlighter-rouge">GlobalAllocator</code>.
    <ul>
      <li>The implementation of this static member function is almost a fixed form. It defines its own allocator as a static local variable and returns a reference to its instance.</li>
      <li>See the following example for a concrete implementation.</li>
    </ul>
  </li>
</ul>

<p>The minimum implementation required is as follows.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"heaphook/heaphook.hpp"</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">heaphook</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyAllocator</span> <span class="o">:</span> <span class="k">public</span> <span class="n">GlobalAllocator</span> <span class="p">{</span>
  <span class="kt">void</span><span class="o">*</span> <span class="n">do_alloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">align</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">do_dealloc</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>

  <span class="kt">size_t</span> <span class="n">do_get_block_size</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">ptr</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="n">GlobalAllocator</span> <span class="o">&amp;</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">get_instance</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">static</span> <span class="n">MyAllocator</span> <span class="n">allocator</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">allocator</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>Save the above implementation in src/my_allocator.cpp.</p>

<h3 id="2-edit-cmakeliststxt">2. Edit CMakeLists.txt</h3>
<p>To build the implemented allocator, you must edit CMakeLists.txt.
You can use build_library cmake function to add build target.</p>

<p>build_library takes a library name as its first argument and a set of required source files as the second and subsequent arguments.</p>

<p>For example,</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">build_library</span><span class="p">(</span>my_allocator
  src/my_allocator.cpp<span class="p">)</span>

</code></pre></div></div>

<h3 id="3-build">3. Build</h3>
<p>Go to the top directory and execute the following command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>colcon build

</code></pre></div></div>
<p>If the build is successful, a file named <code class="language-plaintext highlighter-rouge">lib&lt;libname&gt;.so</code> should be created.
You can use it as follows.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">source install</span>/setup.bash
<span class="nv">$ LD_PRELOAD</span><span class="o">=</span>libmy_allocator.so executable

</code></pre></div></div>

<h2 id="heaphook-api">heaphook API</h2>
<p>This section describes the <code class="language-plaintext highlighter-rouge">GlobalAllocator</code> class, which is required when creating an allocator.</p>

<p>The <code class="language-plaintext highlighter-rouge">GlobalAllocator</code> class has 5 virtual member functions.</p>
<h3 id="do_alloc">do_alloc</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_alloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">align</span><span class="p">);</span>

</code></pre></div></div>
<p>This function allocates a memory area that is larger than <code class="language-plaintext highlighter-rouge">size</code> byte and aligned with <code class="language-plaintext highlighter-rouge">align</code> and returns its address. When implementing this function, the following conditions can be assumed. (heaphook will filter out those that do not meet these conditions.)</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">size</code> &gt; 0</li>
  <li>
<code class="language-plaintext highlighter-rouge">align</code> is either
    <ul>
      <li>1, which means there are no alignment constraints.</li>
      <li>a power of 2 and multiple of <code class="language-plaintext highlighter-rouge">sizeof(void *)</code>, such as 8, 16, 32, …, 4096, …</li>
    </ul>
  </li>
</ul>

<p>If memory allocation fails due to various factors, <code class="language-plaintext highlighter-rouge">nullptr</code> should be returned.</p>

<p>This function hooks the GLIBC allocation functions <code class="language-plaintext highlighter-rouge">malloc</code>, <code class="language-plaintext highlighter-rouge">posix_memalign</code>, <code class="language-plaintext highlighter-rouge">memalign</code>, <code class="language-plaintext highlighter-rouge">aligned_alloc</code>, <code class="language-plaintext highlighter-rouge">valloc</code> and <code class="language-plaintext highlighter-rouge">pvalloc</code>.</p>

<h3 id="do_dealloc">do_dealloc</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_dealloc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

</code></pre></div></div>
<p>This function deallocates a memory area pointed to by ptr, which must have been allocated by other allocation functions <code class="language-plaintext highlighter-rouge">do_alloc</code>, <code class="language-plaintext highlighter-rouge">do_alloc_zeroed</code> or <code class="language-plaintext highlighter-rouge">do_realloc</code>. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> is the value previously returned from these allocation functions. (If not, the program may be killed.)</li>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> != <code class="language-plaintext highlighter-rouge">nullptr</code>
</li>
</ul>

<p>This function hooks the <code class="language-plaintext highlighter-rouge">free</code> function in GLIBC.</p>

<h3 id="do_alloc_zeroed">do_alloc_zeroed</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_alloc_zeroed</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>

</code></pre></div></div>
<p>This function allocates a memory area that is larger than <code class="language-plaintext highlighter-rouge">size</code> byte. The memory is set to zero. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">size</code> &gt; 0</li>
</ul>

<p>If memory allocation fails due to various factors, <code class="language-plaintext highlighter-rouge">nullptr</code> should be returned.</p>

<p>This function hooks the <code class="language-plaintext highlighter-rouge">calloc</code> function in GLIBC.</p>

<p>A default implementation is provided that calls <code class="language-plaintext highlighter-rouge">do_alloc</code> and initializes the allocated memory area with zeros using <code class="language-plaintext highlighter-rouge">memset</code>.</p>

<h3 id="do_realloc">do_realloc</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_realloc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">new_size</span><span class="p">);</span>

</code></pre></div></div>
<p>This function changes the size of the memory block pointed to by <code class="language-plaintext highlighter-rouge">ptr</code> to <code class="language-plaintext highlighter-rouge">new_size</code> bytes and return a pointer to the new memory area. The contents of the memory area must remain unchanged. When expanging the memory, the added memory does not need to be initialized. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> is the value previously returned from these allocation functions. (If not, the program may be killed.)</li>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> != <code class="language-plaintext highlighter-rouge">nullptr</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">new_size</code> &gt; 0</li>
</ul>

<p>If memory allocation fails due to various factors, <code class="language-plaintext highlighter-rouge">nullptr</code> should be returned.</p>

<p>This function hooks the <code class="language-plaintext highlighter-rouge">realloc</code> function in GLIBC.</p>

<p>A default implementation is provided that performs <code class="language-plaintext highlighter-rouge">do_alloc(new_size, 1)</code>, copies contents, and then deallocates the original pointer using <code class="language-plaintext highlighter-rouge">dealloc(ptr)</code>.</p>

<h3 id="do_get_block_size">do_get_block_size</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">GlobalAllocator</span><span class="o">::</span><span class="n">do_get_block_size</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

</code></pre></div></div>
<p>This function returns the size of the memory block pointed to by <code class="language-plaintext highlighter-rouge">ptr</code>. The following conditions can be assumed,</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> is the value previously returned from these allocation functions. (If not, the program may be killed.)</li>
  <li>
<code class="language-plaintext highlighter-rouge">ptr</code> != <code class="language-plaintext highlighter-rouge">nullptr</code>
</li>
</ul>

<p>This function is called internally when calling the GLIBC’s <code class="language-plaintext highlighter-rouge">malloc_usable_size</code>.</p>

<h2 id="trace-function">Trace function</h2>
<p>heaphook has a trace function for debugging the allocator and analyzing its performance.</p>

<p>In the CMakeList.txt file, after declaring a new allocator building rule with <code class="language-plaintext highlighter-rouge">build_library</code>, you can specify <code class="language-plaintext highlighter-rouge">target_compile_options(&lt;libname&gt; PRIVATE "-DTRACE")</code> to build library that traces the allocator’s behavior.</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">build_library</span><span class="p">(</span>my_allocator ...<span class="p">)</span>
<span class="nb">target_compile_options</span><span class="p">(</span>my_allocator PRIVATE <span class="s2">"-DTRACE"</span><span class="p">)</span>

</code></pre></div></div>
<p>If configured in this way, the library will generate a log file named <code class="language-plaintext highlighter-rouge">heaplog.&lt;pid&gt;.log</code> in the current directory. You can visualize heap consumption transitions and performance of each GlobalAllocator member functions in png format based on the generated log file.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>misc/heaptrace_analyzer.py heaplog.&lt;pid&gt;.log 

</code></pre></div></div>

<h2 id="test-allocator">Test allocator</h2>
<p>To test the new memory allocator, add the following statement in CMakeLists.txt. <code class="language-plaintext highlighter-rouge">test_library(&lt;target name&gt; &lt;sources&gt;..)</code> is a cmake function which builds a test program based on Google Test.</p>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">test_library</span><span class="p">(</span>test_my_allocator
  src/original_allocator.cpp<span class="p">)</span>

</code></pre></div></div>
<p>After describing the above, colcon build will create a test program in build/heaphook/test_my_allocator. The source of this test program is in the file test/test_allocator.cpp, so please refer to it if necessary.</p>
</div>
            
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">CONTRIBUTING</h3></div>
          <div class="panel-body">
            
              <em>No CONTRIBUTING.md found.</em>
            
          </div>
        </div>

        
        
      
    </div>
  </div>

  <div class="distro distro-melodic">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/heaphook">heaphook</a> <small>repository</small></h3>
        <span class="label label-default">ldpreload</span> <span class="label label-default">malloc</span> <span class="label label-default">ros2</span> 
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-tier4-heaphook
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-tier4-heaphook" role="menuitem" tabindex="-1" href="/r/heaphook/github-tier4-heaphook" data="github-tier4-heaphook">
                    <span class="glyphicon glyphicon-star"></span>
                    github-tier4-heaphook
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        <div class="alert alert-warning" role="alert">No version for distro <strong>melodic</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>


<script src=/js/contribution_suggestions.js></script>
<script type="text/javascript">
  $(function() {
    setupContributeListTabLinks();
  });
  $(document).ready(function() {
    setupDistroSwitch("humble");
    setupContributeLists("https://github.com/tier4/heaphook.git");
  });
</script>

      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="container-fluid">
      <div style="float:left;">
        
          <a href="https://github.com/rkent/rosindex" title="Find rosindex in Github">
          <span class="icon  icon--github">
            <svg viewBox="0 0 16 16">
              <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
            </svg>
          </span>

          <span class="username">rkent/rosindex</span>
        </a>
        <em class="hidden-xs">| generated on 2025-05-05</em>
      
      </div>
      <div style="float:right;">
        <p class="text"><span class="hidden-xs">a community-maintained index of robotics software
 | </span><a href="/privacy.txt">privacy</a></p>
      </div>
    </div>
  </div>

</footer>


  </body>

</html>
