<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>ROS Index</title>
    <meta name="description" content="a community-maintained index of robotics software
">

    
    <link rel="canonical" href="http://index.rosdabbler.com/r/week-5-6-gazebo-sensors/github-mogi-ros-week-5-6-gazebo-sensors/">
    
    
    <link rel="icon" sizes="any" type="image/svg+xml" href="/assets/rosindex_logo.svg">

    

    <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/css/main.css">
    

    

    <script type="text/javascript" src=/js/jquery.js></script>
    <script src=/bootstrap/js/bootstrap.min.js type="text/javascript"></script>
    <script src=/js/jquery-cookie.js type="text/javascript"></script>
    
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EVD5Z6G6NH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EVD5Z6G6NH');
</script>

    <script type="text/javascript" src=/js/toc.js></script>

    <script src=/js/distro_switch.js></script>
  </head>

  <body>

    <header class="site-header">

  <div class="wrapper">
    <div class="container-fluid" style="margin-bottom: 10px">
      <div class="row">
        <!-- title -->
        <div class="col-xs-3" style="white-space:nowrap">
          <a class="site-title" href="/">
            <img src="/assets/rosindex_logo.svg" width="26" height="26" alt="ROS index logo" style="padding-bottom: 3px"/>
            ROS Index</a>
        </div>
        <!-- main internal links -->
        <div class="col-xs-6 text-center" style="padding:0px">
          <div class="btn-group hidden-xs" role="group" aria-label="..." style="padding: 6px">
            <div class="btn-group" role="group">
              <a href="/?search_packages=true" class="btn btn-default" role="button">Package List</a>
            </div>
            <div class="btn-group" role="group">
              <a href="/?search_repos=true" class="btn btn-default" role="button">Repository List</a>
            </div>
            <div class="btn-group" role="group">
              <a href="/search_deps" class="btn btn-default" role="button">System Dependencies</a>
            </div>
          </div>
          <div class="hidden-lg hidden-md hidden-sm">
            <button id="hLabel" class="btn btn-link dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Lists <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" aria-labelledby="hLabel">
              <li><a href="/?search_packages=true">Package List</a></li>
              <li><a href="/?search_repos=true">Repository List</a></li>
              <li><a href="/search_deps">System Dependencies</a></li>
            </ul>
          </div>
        </div>
        <!-- additional links -->
        <div class="col-xs-3 text-right" style="white-space:nowrap; padding:0px">
          <ul class="list-inline" style="margin-bottom:0px;">
            <li class="dropdown hidden-xs hidden-sm">
              <button id="rLabel" class="btn btn-link" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                ROS Resources <span class="caret"></span>
              </button>
              <ul class="dropdown-menu" role="menu" aria-labelledby="rLabel">
                <li><a href="http://docs.ros.org/">Documentation</a></li>
                <li><a href="http://wiki.ros.org/Support">Support</a></li>
                <li><a href="http://discourse.ros.org/">Discussion Forum</a></li>
                <li><a href="http://status.ros.org/">Service Status</a></li>
                <li><a href="https://robotics.stackexchange.com/questions/tagged/ros">ros @ Robotics Stack Exchange</a></li>
                <li><a href="https://docs.ros.org/en/ros2_packages/">Package API</a></li>
              </ul>
            </li>
            <li class="dropdown hidden-xs hidden-sm">
              <button id="aLabel" class="btn btn-link" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                About <span class="caret"></span>
              </button>
              <ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="aLabel">
                <li><a href="/about">About </a></li>
                <li><a href="/contribute">Contribute</a></li>
                <li><a href="/help">Help</a></li>
                <li><a href="/stats">Stats</a></li>
              </ul>
            </li>
            <li class="dropdown hidden-md hidden-lg">
              <button id="qLabel" class="btn btn-link" type="button"
                      data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Resources <span class="caret"></span>
              </button>
              <ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="qLabel">
                <li><a href="/about">About </a></li>
                <li><a href="/contribute">Contribute</a></li>
                <li><a href="/help">Help</a></li>
                <li><a href="/stats">Stats</a></li>
                <hr style="margin:7px" />
                <li><a href="http://docs.ros.org/">Documentation</a></li>
                <li><a href="http://wiki.ros.org/Support">Support</a></li>
                <li><a href="http://discourse.ros.org/">Discussion Forum</a></li>
                <li><a href="http://status.ros.org/">Service Status</a></li>
                <li><a href="https://robotics.stackexchange.com/questions/tagged/ros">ros @ Robotics Stack Exchange</a></li>
                <li><a href="https://docs.ros.org/en/ros2_packages/">Package API</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="container-fluid" style="margin-top:20px">
  <div class="container-fluid">
    <div class="row">
      <ol class="breadcrumb">
        <li><a href="/">Home</a></li>
        <li><a href="/repos">Repos</a></li>
        <li class="active">week-5-6-gazebo-sensors</li>
        <!--<li class="active">week-5-6-gazebo-sensors</li>-->
      </ol>
    </div>
    <div class="row">
      

<div id="distro-switch" class="btn-group btn-group-justified" data-toggle="buttons">
  
    <label id="humble-option" class="distro-button btn btn-xs btn-default" href="#humble" data="humble">
      <input type="radio" name="options" id="humble-radio" autocomplete="off"> humble
    </label>
  
    <label id="jazzy-option" class="distro-button btn btn-xs btn-default" href="#jazzy" data="jazzy">
      <input type="radio" name="options" id="jazzy-radio" autocomplete="off"> jazzy
    </label>
  
    <label id="kilted-option" class="distro-button btn btn-xs btn-default" href="#kilted" data="kilted">
      <input type="radio" name="options" id="kilted-radio" autocomplete="off"> kilted
    </label>
  
    <label id="rolling-option" class="distro-button btn btn-xs btn-default" href="#rolling" data="rolling">
      <input type="radio" name="options" id="rolling-radio" autocomplete="off"> rolling
    </label>
  
    <label id="github-option" class="distro-button btn btn-xs btn-primary" href="#github" data="github">
      <input type="radio" name="options" id="github-radio" autocomplete="off"> github
    </label>
  
    <label id="noetic-option" class="distro-button btn btn-xs btn-default" href="#noetic" data="noetic">
      <input type="radio" name="options" id="noetic-radio" autocomplete="off"> noetic
    </label>
  

  <!-- Older distros -->
  <div class="btn-group dropdown">
    <label type="button" class="btn btn-xs dropdown-toggle btn-default" data-toggle="dropdown" id="older-distro-button">
        <input type="radio" name="options" autocomplete="off">
      <span id="older-label">Older</span>
      <span class="caret"></span>
    </label>
    <ul class="dropdown-menu" role="menu">
      
        <li data="galactic" id="galactic-option" class="disabled older-distro-option"  href="#galactic">
          <a href="#galactic" data="galactic" id="galactic-button">galactic</a>
        </li>
      
        <li data="iron" id="iron-option" class="disabled older-distro-option"  href="#iron">
          <a href="#iron" data="iron" id="iron-button">iron</a>
        </li>
      
        <li data="melodic" id="melodic-option" class="disabled older-distro-option"  href="#melodic">
          <a href="#melodic" data="melodic" id="melodic-button">melodic</a>
        </li>
      
    </ul>
  </div>
</div>

    </div>
    <div class="row">
      &nbsp;
    </div>
  </div>
</div>


  <div class="distro distro-humble">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/week-5-6-gazebo-sensors">week-5-6-gazebo-sensors</a> <small>repository</small></h3>
        <span class="label label-default">python</span> <span class="label label-default">opencv</span> <span class="label label-default">camera</span> <span class="label label-default">gps</span> <span class="label label-default">point-cloud</span> <span class="label label-default">imu</span> <span class="label label-default">lidar</span> <span class="label label-default">gazebo</span> <span class="label label-default">harmonic</span> <span class="label label-default">depth-camera</span> <span class="label label-default">rqt</span> <span class="label label-default">ros2</span> <span class="label label-default">ekf-localization</span> <span class="label label-default">rqt-reconfigure</span> <span class="label label-default">gazebosim</span> <span class="label label-default">fisheye-camera</span> 
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-mogi-ros-week-5-6-gazebo-sensors
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-mogi-ros-week-5-6-gazebo-sensors" role="menuitem" tabindex="-1" href="/r/week-5-6-gazebo-sensors/github-mogi-ros-week-5-6-gazebo-sensors" data="github-mogi-ros-week-5-6-gazebo-sensors">
                    <span class="glyphicon glyphicon-star"></span>
                    github-mogi-ros-week-5-6-gazebo-sensors
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        <div class="alert alert-warning" role="alert">No version for distro <strong>humble</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-jazzy">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/week-5-6-gazebo-sensors">week-5-6-gazebo-sensors</a> <small>repository</small></h3>
        <span class="label label-default">python</span> <span class="label label-default">opencv</span> <span class="label label-default">camera</span> <span class="label label-default">gps</span> <span class="label label-default">point-cloud</span> <span class="label label-default">imu</span> <span class="label label-default">lidar</span> <span class="label label-default">gazebo</span> <span class="label label-default">harmonic</span> <span class="label label-default">depth-camera</span> <span class="label label-default">rqt</span> <span class="label label-default">ros2</span> <span class="label label-default">ekf-localization</span> <span class="label label-default">rqt-reconfigure</span> <span class="label label-default">gazebosim</span> <span class="label label-default">fisheye-camera</span> 
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-mogi-ros-week-5-6-gazebo-sensors
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-mogi-ros-week-5-6-gazebo-sensors" role="menuitem" tabindex="-1" href="/r/week-5-6-gazebo-sensors/github-mogi-ros-week-5-6-gazebo-sensors" data="github-mogi-ros-week-5-6-gazebo-sensors">
                    <span class="glyphicon glyphicon-star"></span>
                    github-mogi-ros-week-5-6-gazebo-sensors
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        <div class="alert alert-warning" role="alert">No version for distro <strong>jazzy</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-kilted">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/week-5-6-gazebo-sensors">week-5-6-gazebo-sensors</a> <small>repository</small></h3>
        <span class="label label-default">python</span> <span class="label label-default">opencv</span> <span class="label label-default">camera</span> <span class="label label-default">gps</span> <span class="label label-default">point-cloud</span> <span class="label label-default">imu</span> <span class="label label-default">lidar</span> <span class="label label-default">gazebo</span> <span class="label label-default">harmonic</span> <span class="label label-default">depth-camera</span> <span class="label label-default">rqt</span> <span class="label label-default">ros2</span> <span class="label label-default">ekf-localization</span> <span class="label label-default">rqt-reconfigure</span> <span class="label label-default">gazebosim</span> <span class="label label-default">fisheye-camera</span> 
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-mogi-ros-week-5-6-gazebo-sensors
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-mogi-ros-week-5-6-gazebo-sensors" role="menuitem" tabindex="-1" href="/r/week-5-6-gazebo-sensors/github-mogi-ros-week-5-6-gazebo-sensors" data="github-mogi-ros-week-5-6-gazebo-sensors">
                    <span class="glyphicon glyphicon-star"></span>
                    github-mogi-ros-week-5-6-gazebo-sensors
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        <div class="alert alert-warning" role="alert">No version for distro <strong>kilted</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-rolling">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/week-5-6-gazebo-sensors">week-5-6-gazebo-sensors</a> <small>repository</small></h3>
        <span class="label label-default">python</span> <span class="label label-default">opencv</span> <span class="label label-default">camera</span> <span class="label label-default">gps</span> <span class="label label-default">point-cloud</span> <span class="label label-default">imu</span> <span class="label label-default">lidar</span> <span class="label label-default">gazebo</span> <span class="label label-default">harmonic</span> <span class="label label-default">depth-camera</span> <span class="label label-default">rqt</span> <span class="label label-default">ros2</span> <span class="label label-default">ekf-localization</span> <span class="label label-default">rqt-reconfigure</span> <span class="label label-default">gazebosim</span> <span class="label label-default">fisheye-camera</span> 
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-mogi-ros-week-5-6-gazebo-sensors
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-mogi-ros-week-5-6-gazebo-sensors" role="menuitem" tabindex="-1" href="/r/week-5-6-gazebo-sensors/github-mogi-ros-week-5-6-gazebo-sensors" data="github-mogi-ros-week-5-6-gazebo-sensors">
                    <span class="glyphicon glyphicon-star"></span>
                    github-mogi-ros-week-5-6-gazebo-sensors
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        <div class="alert alert-warning" role="alert">No version for distro <strong>rolling</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-github">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/week-5-6-gazebo-sensors">week-5-6-gazebo-sensors</a> <small>repository</small></h3>
        <span class="label label-default">python</span> <span class="label label-default">opencv</span> <span class="label label-default">camera</span> <span class="label label-default">gps</span> <span class="label label-default">point-cloud</span> <span class="label label-default">imu</span> <span class="label label-default">lidar</span> <span class="label label-default">gazebo</span> <span class="label label-default">harmonic</span> <span class="label label-default">depth-camera</span> <span class="label label-default">rqt</span> <span class="label label-default">ros2</span> <span class="label label-default">ekf-localization</span> <span class="label label-default">rqt-reconfigure</span> <span class="label label-default">gazebosim</span> <span class="label label-default">fisheye-camera</span> 
        
        <a class="label label-primary pkg-label" href="/p/bme_gazebo_sensors">bme_gazebo_sensors</a>
        
        <a class="label label-primary pkg-label" href="/p/bme_gazebo_sensors_py">bme_gazebo_sensors_py</a>
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-mogi-ros-week-5-6-gazebo-sensors
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-mogi-ros-week-5-6-gazebo-sensors" role="menuitem" tabindex="-1" href="/r/week-5-6-gazebo-sensors/github-mogi-ros-week-5-6-gazebo-sensors" data="github-mogi-ros-week-5-6-gazebo-sensors">
                    <span class="glyphicon glyphicon-star"></span>
                    github-mogi-ros-week-5-6-gazebo-sensors
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        
        <div class="panel panel-default">
          
          <div class="panel-heading"><h3 class="panel-title">Repository Summary</h3></div>
          <div class="panel-body" style="overflow-x: auto">
            
  <link rel="stylesheet" href="/css/ci-status.css">
  <table class="table table-condensed">
    <tr>
      <td class="text-right"><b>Description</b></td>
      <td><span class="label label-default">Introducing various sensors to our Gazebo Harmonic simulation</span></td>
    </tr>
    <tr>
      <td style="width:100px;" class="text-right"><b>Checkout URI</b></td>
      <td><a class="label label-default" href="https://github.com/mogi-ros/week-5-6-gazebo-sensors.git">https://github.com/mogi-ros/week-5-6-gazebo-sensors.git</a></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Type</b></td>
      <td><span class="label label-default">git</span></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Version</b></td>
      <td><span class="label label-default">main</span></td>
    </tr>
    <tr>
      <td style="white-space: nowrap;" class="text-right"><b>Last Updated</b></div>
      <td>
        
          <span class="label label-default"><span class="glyphicon glyphicon-time"></span> 2025-03-22
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Dev Status</b></td>
      <td>
        
          <span class="label label-warning">UNKNOWN
        </span>
      </td>
    </tr>
              <tr>
                <td class="text-right"><b>CI status</b></td>
                <td class="ci-status">
                  
                  
                    <span class="label label-default" title="">No Continuous Integration</span>
                  
                </td>
              </tr>
    <tr>
      <td class="text-right"><b>Released</b></td>
      <td>
        
          <span class="label label-default">UNRELEASED
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Tags</b></td>
      <td>
        
        
          <span class="label label-default">python</span> <span class="label label-default">opencv</span> <span class="label label-default">camera</span> <span class="label label-default">gps</span> <span class="label label-default">point-cloud</span> <span class="label label-default">imu</span> <span class="label label-default">lidar</span> <span class="label label-default">gazebo</span> <span class="label label-default">harmonic</span> <span class="label label-default">depth-camera</span> <span class="label label-default">rqt</span> <span class="label label-default">ros2</span> <span class="label label-default">ekf-localization</span> <span class="label label-default">rqt-reconfigure</span> <span class="label label-default">gazebosim</span> <span class="label label-default">fisheye-camera</span> 
        
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Contributing</b></td>
      <td>
        <a class="label label-primary" href="/r/week-5-6-gazebo-sensors/#github-contribute-lists-help-wanted">
          Help Wanted (<span class="contribute-lists-help-wanted-count">0</span>)
        </a>
        <br>
        <a class="label label-primary" href="/r/week-5-6-gazebo-sensors/#github-contribute-lists-good-first-issue">
          Good First Issues (<span class="contribute-lists-good-first-issue-count">0</span>)
        </a>
        <br>
        <a class="label label-primary" href="/r/week-5-6-gazebo-sensors/#github-contribute-lists-pull-requests">
          Pull Requests to Review (<span class="contribute-lists-pull-requests-count">0</span>)
        </a>
      </td>
    </tr>
  </table>

          </div>
        </div>
        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">Packages</h3></div>
          <div class="panel-body">
            
            
              <table class="table table-condensed table-hover table-striped">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Version</th>
                  </tr>
                </thead>
                <tbody>
                
                  <tr>
                    <td><a href="/p/bme_gazebo_sensors">bme_gazebo_sensors</a></td>
                    <td>1.0.0</td>
                  </tr>
                
                  <tr>
                    <td><a href="/p/bme_gazebo_sensors_py">bme_gazebo_sensors_py</a></td>
                    <td>1.0.0</td>
                  </tr>
                
                </tbody>
              </table>
            
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">README</h3></div>
          <div class="panel-body">
            
              <div class="rendered-markdown">
<h1 id="week-5-6-gazebo-sensors">Week 5-6: Gazebo sensors</h1>

<h2 id="this-is-how-far-we-will-get-by-the-end-of-this-lesson">This is how far we will get by the end of this lesson:</h2>
<p><a href="https://youtu.be/0Xokl5dHRoQ"><img width="600" src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/youtube-gazebo.png"></a></p>

<p><a href="https://youtu.be/ELwRqeNR_NA"><img width="600" src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/youtube-gazebo-1.png"></a></p>

<h1 id="table-of-contents">Table of Contents</h1>
<ol>
  <li>
<a href="https://github.com/mogi-ros/week-5-6-gazebo-sensors/tree/main/#introduction">Introduction</a><br>
1.1. <a href="https://github.com/mogi-ros/week-5-6-gazebo-sensors/tree/main/#download-ros-package">Download ROS package</a><br>
1.2. <a href="https://github.com/mogi-ros/week-5-6-gazebo-sensors/tree/main/#test-the-starter-package">Test the starter package</a>
</li>
  <li>
<a href="https://github.com/mogi-ros/week-5-6-gazebo-sensors/tree/main/#camera">Camera</a><br>
2.1. <a href="https://github.com/mogi-ros/week-5-6-gazebo-sensors/tree/main/#image-transport">Image transport</a><br>
2.2. <a href="https://github.com/mogi-ros/week-5-6-gazebo-sensors/tree/main/#rqt-reconfigure">rqt reconfigure</a><br>
2.3. <a href="https://github.com/mogi-ros/week-5-6-gazebo-sensors/tree/main/#wide-angle-camera">Wide angle camera</a>
</li>
  <li>
<a href="https://github.com/mogi-ros/week-5-6-gazebo-sensors/tree/main/#imu">IMU</a><br>
3.1. <a href="https://github.com/mogi-ros/week-5-6-gazebo-sensors/tree/main/#sensor-fusion-with-ekf">Sensor fusion with ekf</a>
</li>
  <li>
<a href="https://github.com/mogi-ros/week-5-6-gazebo-sensors/tree/main/#gps">GPS</a><br>
4.1. <a href="https://github.com/mogi-ros/week-5-6-gazebo-sensors/tree/main/#haversine-formula">Haversine formula</a><br>
4.2. <a href="https://github.com/mogi-ros/week-5-6-gazebo-sensors/tree/main/#gps-waypoint-following">GPS waypoint following</a>
</li>
  <li>
<a href="https://github.com/mogi-ros/week-5-6-gazebo-sensors/tree/main/#lidar">Lidar</a><br>
5.1. <a href="https://github.com/mogi-ros/week-5-6-gazebo-sensors/tree/main/#3d-lidar">3D lidar</a>
</li>
  <li><a href="https://github.com/mogi-ros/week-5-6-gazebo-sensors/tree/main/#rgbd-camera">RGBD camera</a></li>
  <li><a href="https://github.com/mogi-ros/week-5-6-gazebo-sensors/tree/main/#image-processing-with-opencv">Image processing with OpenCV</a></li>
</ol>

<h1 id="introduction">Introduction</h1>

<p>After we built a simulated robot that we can drive around manually, we’ll start adding various types of sensors to it. We’ll see how to improve the odometry with sensor fusion using an IMI, how to follow GPS waypoints and we’ll use various cameras and lidars.</p>

<h2 id="download-ros-package">Download ROS package</h2>

<p>The starting package of this lesson is very similar to where we just finished in the previous lesson, but don’t forget that every lesson has its own starter package that you can donwload from GitHub. To download the starter package clone the following git repo with the <code class="language-plaintext highlighter-rouge">starter-branch</code> (using the <code class="language-plaintext highlighter-rouge">-b branch</code> flag) to your colcon workspace:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone <span class="nt">-b</span> starter-branch https://github.com/MOGI-ROS/Week-5-6-Gazebo-sensors.git

</code></pre></div></div>

<p>As we saw prevoiusly we can take a look what’s inside the <code class="language-plaintext highlighter-rouge">bme_gazebo_sensors</code> package with the <code class="language-plaintext highlighter-rouge">tree</code> command!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
├── CMakeLists.txt
├── package.xml
├── config
│   └── ekf.yaml
├── launch
│   ├── check_urdf.launch.py
│   ├── spawn_robot.launch.py
│   └── world.launch.py
├── meshes
│   ├── lidar.dae
│   ├── mogi_bot.dae
│   └── wheel.dae
├── rviz
│   ├── gps.rviz
│   ├── rviz.rviz
│   └── urdf.rviz
├── urdf
│   ├── materials.xacro
│   ├── mogi_bot.gazebo
│   └── mogi_bot.urdf
└── worlds
    ├── empty.sdf
    ├── home.sdf
    └── world.sdf

</code></pre></div></div>

<p>Let’s see what will we do with the existing files and folders:</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">config</code>: We usually store parameters and large configuration files for ROS packages which aren’t comfortable to handle from the launchfiles directly. In this lesson we store the configuration file for the sensor fusion using the <code class="language-plaintext highlighter-rouge">robot_localization</code> package’s Extended Kalman Filter.</li>
  <li>
<code class="language-plaintext highlighter-rouge">launch</code>: Default launch files are already part of the starting package, we can test the package with <code class="language-plaintext highlighter-rouge">spawn_robot.launch.py</code>.</li>
  <li>
<code class="language-plaintext highlighter-rouge">meshes</code>: this folder contains the 3D models in <code class="language-plaintext highlighter-rouge">dae</code> format (collada mesh) that we use for our robot’s body, wheels and lidar sensor.</li>
  <li>
<code class="language-plaintext highlighter-rouge">rviz</code>: Pre-configured RViz2 layouts</li>
  <li>
<code class="language-plaintext highlighter-rouge">urdf</code>: The URDF models of our robot, we’ll extend the <code class="language-plaintext highlighter-rouge">mogi_bot.urdf</code> and <code class="language-plaintext highlighter-rouge">gazebo</code> files through this lesson</li>
  <li>
<code class="language-plaintext highlighter-rouge">worlds</code>: default Gazebo worlds that we’ll use in the simulations.</li>
</ul>

<p>We have another package <code class="language-plaintext highlighter-rouge">bme_gazebo_sensors_py</code> for our python scripts:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
├── bme_gazebo_sensors_py
│   ├── gps_waypoint_follower.py
│   ├── haversine_test.py
│   ├── image_republisher.py
│   └── __init__.py
├── package.xml
├── resource
│   └── bme_gazebo_sensors_py
├── setup.cfg
└── setup.py

</code></pre></div></div>

<h2 id="test-the-starter-package">Test the starter package</h2>

<p>After we downloaded the <code class="language-plaintext highlighter-rouge">starter-branch</code> from GitHub, let’s rebuild the workspace and source the <code class="language-plaintext highlighter-rouge">install/setup.bash</code> file to make sure ROS and its tools are aware about the new package.</p>

<p>Then we can test the package with the usual launch file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ros2 launch bme_gazebo_sensors spawn_robot.launch.py

</code></pre></div></div>

<p>And we can also start a teleop node:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ros2 run teleop_twist_keyboard teleop_twist_keyboard

</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/starter-package.png" alt="alt text" title="Starter package"></p>

<blockquote>
  <p>In the next chapters we will add various sensors with many different properties, if it’s unclear what kind of properties are available for which sensors, the official SDF reference manual is available <a href="http://sdformat.org/spec?elem=sensor&amp;ver=1.6">on the following link</a>.</p>
</blockquote>

<h1 id="camera">Camera</h1>

<p>To add a camera - and every other sensors later - we have to change 2 files:
1) The <code class="language-plaintext highlighter-rouge">mogi_bot.urdf</code>: we have to define the position, orientation and other physical properties of the camera in this file. This is not necessarily simulation dependent, we have to do these same changes in the urdf in case of a real robot with a real sensor.
2) The <code class="language-plaintext highlighter-rouge">mogi_bot.gazebo</code>: this is fully simulation dependent, we have to define the properties of the simulated camera in this file.</p>

<p>Let’s add the camera first to the <code class="language-plaintext highlighter-rouge">mogi_bot.urdf</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c">&lt;!-- STEP 7 - Camera --&gt;</span>
  <span class="nt">&lt;joint</span> <span class="na">type=</span><span class="s">"fixed"</span> <span class="na">name=</span><span class="s">"camera_joint"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0.225 0 0.075"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"camera_link"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;axis</span> <span class="na">xyz=</span><span class="s">"0 1 0"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'camera_link'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;pose&gt;</span>0 0 0 0 0 0<span class="nt">&lt;/pose&gt;</span>
    <span class="nt">&lt;inertial&gt;</span>
      <span class="nt">&lt;mass</span> <span class="na">value=</span><span class="s">"0.1"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;inertia</span>
          <span class="na">ixx=</span><span class="s">"1e-6"</span> <span class="na">ixy=</span><span class="s">"0"</span> <span class="na">ixz=</span><span class="s">"0"</span>
          <span class="na">iyy=</span><span class="s">"1e-6"</span> <span class="na">iyz=</span><span class="s">"0"</span>
          <span class="na">izz=</span><span class="s">"1e-6"</span>
      <span class="nt">/&gt;</span>
    <span class="nt">&lt;/inertial&gt;</span>

    <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'collision'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span> 
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;box</span> <span class="na">size=</span><span class="s">".03 .03 .03"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
    <span class="nt">&lt;/collision&gt;</span>

    <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'camera_link_visual'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;box</span> <span class="na">size=</span><span class="s">".03 .03 .03"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>

  <span class="nt">&lt;/link&gt;</span>

  <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"camera_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;material&gt;</span>Gazebo/Red<span class="nt">&lt;/material&gt;</span>
  <span class="nt">&lt;/gazebo&gt;</span>

  <span class="nt">&lt;joint</span> <span class="na">type=</span><span class="s">"fixed"</span> <span class="na">name=</span><span class="s">"camera_optical_joint"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"-1.5707 0 -1.5707"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"camera_link_optical"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"camera_link"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"camera_link_optical"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

</code></pre></div></div>

<p>As we see above, the camera is a 3 x 3 x 3 cm cube, attached to the <code class="language-plaintext highlighter-rouge">base_link</code> with a fixed joint. But there is another thing, <code class="language-plaintext highlighter-rouge">camera_link_optical</code> which is connected to the <code class="language-plaintext highlighter-rouge">camera_link</code> through the <code class="language-plaintext highlighter-rouge">camera_optical_joint</code>! The purpose of this additional link and joint to solve the conflict between 2 different conventional coordinate systems:</p>
<ul>
  <li>By default, URDF uses the right-handed coordinate system with X forward, Y left, and Z up.</li>
  <li>However, many ROS drivers and vision processing pipelines expect a camera’s optical axis to be aligned with Z forward, X to the right, and Y down.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">camera_optical_joint</code> applies a static rotation so that the camera data will be interpreted correctly by ROS tools that assume the Z-forward convention for image and depth sensors.</p>

<p>Now let’s add the simulated camera into <code class="language-plaintext highlighter-rouge">mogi_bot.gazebo</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"camera_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sensor</span> <span class="na">name=</span><span class="s">"camera"</span> <span class="na">type=</span><span class="s">"camera"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;camera&gt;</span>
        <span class="nt">&lt;horizontal_fov&gt;</span>1.3962634<span class="nt">&lt;/horizontal_fov&gt;</span>
        <span class="nt">&lt;image&gt;</span>
          <span class="nt">&lt;width&gt;</span>640<span class="nt">&lt;/width&gt;</span>
          <span class="nt">&lt;height&gt;</span>480<span class="nt">&lt;/height&gt;</span>
          <span class="nt">&lt;format&gt;</span>R8G8B8<span class="nt">&lt;/format&gt;</span>
        <span class="nt">&lt;/image&gt;</span>
        <span class="nt">&lt;clip&gt;</span>
          <span class="nt">&lt;near&gt;</span>0.1<span class="nt">&lt;/near&gt;</span>
          <span class="nt">&lt;far&gt;</span>15<span class="nt">&lt;/far&gt;</span>
        <span class="nt">&lt;/clip&gt;</span>
        <span class="nt">&lt;noise&gt;</span>
          <span class="nt">&lt;type&gt;</span>gaussian<span class="nt">&lt;/type&gt;</span>
          <span class="c">&lt;!-- Noise is sampled independently per pixel on each frame.
               That pixel's noise value is added to each of its color
               channels, which at that point lie in the range [0,1]. --&gt;</span>
          <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
          <span class="nt">&lt;stddev&gt;</span>0.007<span class="nt">&lt;/stddev&gt;</span>
        <span class="nt">&lt;/noise&gt;</span>
        <span class="nt">&lt;optical_frame_id&gt;</span>camera_link_optical<span class="nt">&lt;/optical_frame_id&gt;</span>
        <span class="nt">&lt;camera_info_topic&gt;</span>camera/camera_info<span class="nt">&lt;/camera_info_topic&gt;</span>
      <span class="nt">&lt;/camera&gt;</span>
      <span class="nt">&lt;always_on&gt;</span>1<span class="nt">&lt;/always_on&gt;</span>
      <span class="nt">&lt;update_rate&gt;</span>20<span class="nt">&lt;/update_rate&gt;</span>
      <span class="nt">&lt;visualize&gt;</span>true<span class="nt">&lt;/visualize&gt;</span>
      <span class="nt">&lt;topic&gt;</span>camera/image<span class="nt">&lt;/topic&gt;</span>
    <span class="nt">&lt;/sensor&gt;</span>
  <span class="nt">&lt;/gazebo&gt;</span>

</code></pre></div></div>

<blockquote>
  <p>Don’t forget that the above code snippets must be placed within the already existing <code class="language-plaintext highlighter-rouge">&lt;robot&gt;</code> tag!</p>
</blockquote>

<p>With the above plugin we define a couple of things for Gazebo, let’s see the important ones one by one:</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">&lt;gazebo reference="camera_link"&gt;</code>, we have to refer to the <code class="language-plaintext highlighter-rouge">camera_link</code> that we defined in the <code class="language-plaintext highlighter-rouge">urdf</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">&lt;horizontal_fov&gt;1.3962634&lt;/horizontal_fov&gt;</code>, the field of view of the simulated camera</li>
  <li>
<code class="language-plaintext highlighter-rouge">width</code>, <code class="language-plaintext highlighter-rouge">height</code>, <code class="language-plaintext highlighter-rouge">format</code> and <code class="language-plaintext highlighter-rouge">update_rate</code>, properties of the video stream</li>
  <li>
<code class="language-plaintext highlighter-rouge">&lt;optical_frame_id&gt;camera_link_optical&lt;/optical_frame_id&gt;</code>, we have to use the <code class="language-plaintext highlighter-rouge">camera_link_optical</code> that we checked in details above to ensure the right static transformations between the coordinate systems</li>
  <li>
<code class="language-plaintext highlighter-rouge">&lt;camera_info_topic&gt;camera/camera_info&lt;/camera_info_topic&gt;</code>, certain tools like rviz requires a <code class="language-plaintext highlighter-rouge">camera_info</code> topic that describes the physical properties of the camera. The topic’s name must match camera’s topic (in this case both are <code class="language-plaintext highlighter-rouge">camera/...</code>)</li>
  <li>
<code class="language-plaintext highlighter-rouge">&lt;topic&gt;camera/image&lt;/topic&gt;</code>, we define the camera topic here</li>
</ul>

<p>We can rebuild the workspace and try our changes, but it will not yet work. The camera’s red cube model is visible but the topics aren’t available for ROS (we can check it for example with <code class="language-plaintext highlighter-rouge">rqt</code>)</p>

<blockquote>
  <p>It’s possible to reload the urdf without restarting the nodes by setting the parameter from the terminal:</p>

  <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>ros2 param <span class="nb">set</span> /robot_state_publisher robot_description <span class="s2">"</span><span class="si">$(</span>xacro <span class="si">$(</span>ros2 pkg prefix bme_gazebo_sensors<span class="si">)</span>/share/bme_gazebo_sensors/urdf/mogi_bot.urdf<span class="si">)</span><span class="s2">"</span>

</code></pre></div>  </div>
</blockquote>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/camera-first-try.png" alt="alt text" title="Adding a camera"></p>

<p>With the new Gazebo simulator topics are not automatically forwarded as we already saw it in the previous lesson, we have to use the <code class="language-plaintext highlighter-rouge">parameter_bridge</code> of the <code class="language-plaintext highlighter-rouge">ros_gz_bridge</code> package. It has <a href="https://github.com/gazebosim/ros_gz/tree/ros2/ros_gz_bridge">a very detailed readme</a> what kind of topic types can be forwarded between ROS and Gazebo. We have to extend the arguments of the <code class="language-plaintext highlighter-rouge">parameter_bridge</code> in our launch file:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># Node to bridge /cmd_vel and /odom
</span>    <span class="n">gz_bridge_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">ros_gz_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">parameter_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">/clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/cmd_vel@geometry_msgs/msg/Twist@gz.msgs.Twist</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/odom@nav_msgs/msg/Odometry@gz.msgs.Odometry</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/joint_states@sensor_msgs/msg/JointState@gz.msgs.Model</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/tf@tf2_msgs/msg/TFMessage@gz.msgs.Pose_V</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/camera/image@sensor_msgs/msg/Image@gz.msgs.Image</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/camera/camera_info@sensor_msgs/msg/CameraInfo@gz.msgs.CameraInfo</span><span class="sh">"</span><span class="p">,</span>

        <span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">"</span><span class="s">screen</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">)},</span>
        <span class="p">]</span>
    <span class="p">)</span>

</code></pre></div></div>

<p>Let’s rebuild the workspace and try it again:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ros2 launch bme_gazebo_sensors spawn_robot.launch.py

</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/camera.png" alt="alt text" title="Adding a camera"></p>

<h2 id="image-transport">Image transport</h2>

<p>We can see that both <code class="language-plaintext highlighter-rouge">/camera/camera_info</code> and <code class="language-plaintext highlighter-rouge">/camera/image</code> topics are forwarded. Although this is still not the ideal way to forward the camera image from Gazebo. ROS has a very handy feature with it’s image transport protocol plugins, it’s able to automatically compress the video stream in the background without any additional work on our side. But this feature doesn’t work together with <code class="language-plaintext highlighter-rouge">parameter_bridge</code>. Without compression the 640x480 camera stream consumes almost 20 MB/s network bandwith which is unacceptable for a wireless mobile robot.</p>

<p>Therefore there is a dedicated <code class="language-plaintext highlighter-rouge">image_bridge</code> node in the <code class="language-plaintext highlighter-rouge">ros_gz_image</code> package. Let’s modify our launch file to the following:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># Node to bridge /cmd_vel and /odom
</span>    <span class="n">gz_bridge_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">ros_gz_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">parameter_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">/clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/cmd_vel@geometry_msgs/msg/Twist@gz.msgs.Twist</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/odom@nav_msgs/msg/Odometry@gz.msgs.Odometry</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/joint_states@sensor_msgs/msg/JointState@gz.msgs.Model</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/tf@tf2_msgs/msg/TFMessage@gz.msgs.Pose_V</span><span class="sh">"</span><span class="p">,</span>
            <span class="c1">#"/camera/image@sensor_msgs/msg/Image@gz.msgs.Image",
</span>            <span class="sh">"</span><span class="s">/camera/camera_info@sensor_msgs/msg/CameraInfo@gz.msgs.CameraInfo</span><span class="sh">"</span><span class="p">,</span>

        <span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">"</span><span class="s">screen</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">)},</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Node to bridge camera image with image_transport and compressed_image_transport
</span>    <span class="n">gz_image_bridge_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">ros_gz_image</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">image_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">/camera/image</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">"</span><span class="s">screen</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">),</span>
             <span class="sh">'</span><span class="s">camera.image.compressed.jpeg_quality</span><span class="sh">'</span><span class="p">:</span> <span class="mi">75</span><span class="p">},</span>
        <span class="p">],</span>
    <span class="p">)</span>

</code></pre></div></div>

<p>We also have to add the new node to the <code class="language-plaintext highlighter-rouge">launchDescription</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">launchDescriptionObject</span><span class="p">.</span><span class="nf">add_action</span><span class="p">(</span><span class="n">gz_image_bridge_node</span><span class="p">)</span>

</code></pre></div></div>

<p>After rebuild we can try it using <code class="language-plaintext highlighter-rouge">rqt</code> and we will see huge improvement in the bandwith thanks to the <code class="language-plaintext highlighter-rouge">jpeg</code> compression.
<img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/compressed.png" alt="alt text" title="Adding a camera"></p>

<blockquote>
  <p>If compressed images are not visible in rqt, you have to install the plugins you want to use:</p>
  <ul>
    <li>
<code class="language-plaintext highlighter-rouge">sudo apt install ros-jazzy-compressed-image-transport</code>: for jpeg and png compression</li>
    <li>
<code class="language-plaintext highlighter-rouge">sudo apt install ros-jazzy-theora-image-transport</code>: for theora compression</li>
    <li>
<code class="language-plaintext highlighter-rouge">sudo apt install ros-jazzy-zstd-image-transport</code>: for zstd compression</li>
  </ul>
</blockquote>

<p>But we face another issue, this time in RViz, the uncompressed camera stream is visible as before but the compressed one isn’t due to the following warning:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Camera Info
Expecting Camera Info on topic [/camera/image/camera_info]. No CameraInfo received. Topic may not exist.

</code></pre></div></div>

<p>It’s because RViz always expect the <code class="language-plaintext highlighter-rouge">image</code> and <code class="language-plaintext highlighter-rouge">the camera_info</code> topics with the same prefix which works well for:</p>

<p><code class="language-plaintext highlighter-rouge">/camera/image</code> → <code class="language-plaintext highlighter-rouge">/camera/camera_info</code></p>

<p>But doesn’t work for:</p>

<p><code class="language-plaintext highlighter-rouge">/camera/image/compressed</code> → <code class="language-plaintext highlighter-rouge">/camera/image/camera_info</code></p>

<p>because we don’t publish the <code class="language-plaintext highlighter-rouge">camera_info</code> to that topic. We could remap the <code class="language-plaintext highlighter-rouge">camera_info</code> to that topic, but then the uncompressed image won’t work in RViz, so it’s not the desired solution.</p>

<p>But there is another useful tool that we can use, the <code class="language-plaintext highlighter-rouge">relay</code> node from the <code class="language-plaintext highlighter-rouge">topic_tools</code> package:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># Relay node to republish /camera/camera_info to /camera/image/camera_info
</span>    <span class="n">relay_camera_info_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">topic_tools</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">relay</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">relay_camera_info</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">camera/camera_info</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">camera/image/camera_info</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">)},</span>
        <span class="p">]</span>
    <span class="p">)</span>

</code></pre></div></div>

<p>Of course, don’t forget to add it to the <code class="language-plaintext highlighter-rouge">launchDescription</code> too:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">launchDescriptionObject</span><span class="p">.</span><span class="nf">add_action</span><span class="p">(</span><span class="n">relay_camera_info_node</span><span class="p">)</span>

</code></pre></div></div>

<blockquote>
  <p>If <code class="language-plaintext highlighter-rouge">topic_tools</code> is not installed you can install it with <code class="language-plaintext highlighter-rouge">sudo apt install ros-jazzy-topic-tools</code></p>
</blockquote>

<p>Rebuild the workspace and let’s try it!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ros2 launch bme_gazebo_sensors spawn_robot.launch.py

</code></pre></div></div>
<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/compressed-1.png" alt="alt text" title="Adding a camera"></p>

<h2 id="rqt-reconfigure">rqt reconfigure</h2>

<p>We already set up the <code class="language-plaintext highlighter-rouge">jpeg</code> quality in the <code class="language-plaintext highlighter-rouge">image_bridge</code> node with the following parameter:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="sh">'</span><span class="s">camera.image.compressed.jpeg_quality</span><span class="sh">'</span><span class="p">:</span> <span class="mi">75</span>

</code></pre></div></div>

<p>But how do we know what is the name of the parameter and what other settings do we can change? To see that we will use the <code class="language-plaintext highlighter-rouge">rqt_reconfigure</code> node.</p>

<p>First start the simulation:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ros2 launch bme_gazebo_sensors spawn_robot.launch.py

</code></pre></div></div>

<p>Then start rqt_reconfigure:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ros2 run rqt_reconfigure rqt_reconfigure

</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/rqt-reconfigure.png" alt="alt text" title="rqt reconfigure"></p>

<p>We can play with the parameters here, change the compression or the algorithm as we wish and we can monitor it’s impact with <code class="language-plaintext highlighter-rouge">rqt</code>.</p>

<h2 id="wide-angle-camera">Wide angle camera</h2>

<p>Using wide angle or fisheye lens on mobile robots is quite common, but With the conventional camera simulation we cannot simply increase the field of view to get a wide angle distortion. To achieve this we need a different plugin, the <code class="language-plaintext highlighter-rouge">wideangle_camera</code>. Let’s replace the camera simulation in the <code class="language-plaintext highlighter-rouge">mogi_bot.gazebo</code> to this one:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"camera_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sensor</span> <span class="na">name=</span><span class="s">"wideangle_camera"</span> <span class="na">type=</span><span class="s">"wideanglecamera"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;camera&gt;</span>
        <span class="nt">&lt;horizontal_fov&gt;</span>3.14<span class="nt">&lt;/horizontal_fov&gt;</span>
        <span class="nt">&lt;image&gt;</span>
          <span class="nt">&lt;width&gt;</span>640<span class="nt">&lt;/width&gt;</span>
          <span class="nt">&lt;height&gt;</span>480<span class="nt">&lt;/height&gt;</span>
        <span class="nt">&lt;/image&gt;</span>
        <span class="nt">&lt;clip&gt;</span>
          <span class="nt">&lt;near&gt;</span>0.1<span class="nt">&lt;/near&gt;</span>
          <span class="nt">&lt;far&gt;</span>15<span class="nt">&lt;/far&gt;</span>
        <span class="nt">&lt;/clip&gt;</span>
        <span class="nt">&lt;optical_frame_id&gt;</span>camera_link_optical<span class="nt">&lt;/optical_frame_id&gt;</span>
        <span class="nt">&lt;camera_info_topic&gt;</span>camera/camera_info<span class="nt">&lt;/camera_info_topic&gt;</span>
      <span class="nt">&lt;/camera&gt;</span>
      <span class="nt">&lt;always_on&gt;</span>1<span class="nt">&lt;/always_on&gt;</span>
      <span class="nt">&lt;update_rate&gt;</span>20<span class="nt">&lt;/update_rate&gt;</span>
      <span class="nt">&lt;topic&gt;</span>camera/image<span class="nt">&lt;/topic&gt;</span>
      <span class="nt">&lt;gz_frame_id&gt;</span>camera_link<span class="nt">&lt;/gz_frame_id&gt;</span>
    <span class="nt">&lt;/sensor&gt;</span>
  <span class="nt">&lt;/gazebo&gt;</span>

</code></pre></div></div>

<p>After rebuilding the workspace we can try it out:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ros2 launch bme_gazebo_sensors spawn_robot.launch.py

</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/wide-angle.png" alt="alt text" title="Wide angle camera"></p>

<p>As image it works in both <code class="language-plaintext highlighter-rouge">rviz</code> and in <code class="language-plaintext highlighter-rouge">rqt</code> but as a camera it doesn’t work in RViz due to the following error:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>rviz2-2] <span class="o">[</span>INFO] <span class="o">[</span>1736112172.091762692] <span class="o">[</span>rviz]: Message Filter dropping message: frame <span class="s1">'mogi_bot/base_footprint/wideangle_camera'</span> at <span class="nb">time </span>137.352 <span class="k">for </span>reason <span class="s1">'discarding message because the queue is full'</span>

</code></pre></div></div>

<p>As of ROS2 Jazzy and Gazebo Harmonic <code class="language-plaintext highlighter-rouge">wideangle_camera</code> has a bug and it ignores the <code class="language-plaintext highlighter-rouge">optical_frame_id</code> tag therefore RViz rejects visualizing it, we can also take a look on the header of the image topic:</p>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/wide-angle-1.png" alt="alt text" title="Wide angle camera"></p>

<p>If we want to fix this problem we can re-publish the message with a corrected header, I created a very simply script that does this, it’s part of the starter package and we can run the node with the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ros2 run bme_gazebo_sensors_py image_republisher

</code></pre></div></div>

<h1 id="imu">IMU</h1>

<p>An Inertial Measurement Unit (IMU) typically consists of a 3-axis accelerometer, 3-axis gyroscope, and sometimes a 3-axis magnetometer. It measures linear acceleration, angular velocity, and possibly magnetic heading (orientation). It’s important to remember that it’s not possible to measure unform motion with an IMU where the velocity is constant (acceleration is zero) and there is no change in the orientation. Therefore we cannot replace the odometry of the robot with an IMU but with the right technique we can combine these two into a more precise measurement unit.</p>

<p>But first, let’s add our IMU to the <code class="language-plaintext highlighter-rouge">urdf</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c">&lt;!-- STEP 8 - IMU --&gt;</span>
  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"imu_joint"</span> <span class="na">type=</span><span class="s">"fixed"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"imu_link"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"imu_link"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

</code></pre></div></div>

<p>Which is a simple link and a fixed joint in the center of the base link. Let’s add the plugin to the <code class="language-plaintext highlighter-rouge">mogi_bot.gazebo</code> file too:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"imu_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sensor</span> <span class="na">name=</span><span class="s">"imu"</span> <span class="na">type=</span><span class="s">"imu"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;always_on&gt;</span>1<span class="nt">&lt;/always_on&gt;</span>
      <span class="nt">&lt;update_rate&gt;</span>50<span class="nt">&lt;/update_rate&gt;</span>
      <span class="nt">&lt;visualize&gt;</span>true<span class="nt">&lt;/visualize&gt;</span>
      <span class="nt">&lt;topic&gt;</span>imu<span class="nt">&lt;/topic&gt;</span>
      <span class="nt">&lt;enable_metrics&gt;</span>true<span class="nt">&lt;/enable_metrics&gt;</span>
      <span class="nt">&lt;gz_frame_id&gt;</span>imu_link<span class="nt">&lt;/gz_frame_id&gt;</span>
    <span class="nt">&lt;/sensor&gt;</span>
  <span class="nt">&lt;/gazebo&gt;</span>

</code></pre></div></div>

<p>With adding the IMU we aren’t done yet, with the new Gazebo we also have to make sure that our simulated world has the right plugins within its <code class="language-plaintext highlighter-rouge">&lt;world&gt;</code> tag. In this lesson I already added the plugins to each world files, but if you use your won custom made world, don’t forget to add the plugins!</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;plugin</span>
      <span class="na">filename=</span><span class="s">"gz-sim-imu-system"</span>
      <span class="na">name=</span><span class="s">"gz::sim::systems::Imu"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/plugin&gt;</span>

</code></pre></div></div>

<p>Before we try it out we also have to bridge the topics from Gazebo towards ROS using the <code class="language-plaintext highlighter-rouge">parameter_bridge</code>. Let’s add the <code class="language-plaintext highlighter-rouge">imu</code> topic - or what we defined as <code class="language-plaintext highlighter-rouge">&lt;topic&gt;</code> in the Gazebo plugin - to the parameter bridge, rebuild the workspace and we are ready to test it!</p>

<blockquote>
  <p>To properly visualize IMU in RViz install the following plugin: <code class="language-plaintext highlighter-rouge">sudo apt install ros-jazzy-rviz-imu-plugin</code></p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># Node to bridge /cmd_vel and /odom
</span>    <span class="n">gz_bridge_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">ros_gz_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">parameter_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">/clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/cmd_vel@geometry_msgs/msg/Twist@gz.msgs.Twist</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/odom@nav_msgs/msg/Odometry@gz.msgs.Odometry</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/joint_states@sensor_msgs/msg/JointState@gz.msgs.Model</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/tf@tf2_msgs/msg/TFMessage@gz.msgs.Pose_V</span><span class="sh">"</span><span class="p">,</span>
            <span class="c1">#"/camera/image@sensor_msgs/msg/Image@gz.msgs.Image",
</span>            <span class="sh">"</span><span class="s">/camera/camera_info@sensor_msgs/msg/CameraInfo@gz.msgs.CameraInfo</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">imu@sensor_msgs/msg/Imu@gz.msgs.IMU</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">"</span><span class="s">screen</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">)},</span>
        <span class="p">]</span>
    <span class="p">)</span>

</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ros2 launch bme_gazebo_sensors spawn_robot.launch.py

</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/imu.png" alt="alt text" title="IMU"></p>

<h2 id="sensor-fusion-with-ekf">Sensor fusion with ekf</h2>

<p>Sensor fusion is the process of combining data from multiple sensors (possibly of different types) to obtain a more accurate or more complete understanding of a system or environment than could be achieved by using the sensors separately. By merging redundant and complementary information, sensor fusion reduces uncertainty, mitigates individual sensor errors, and provides robust state estimates (e.g., position, velocity, orientation).</p>

<p>A Kalman Filter (KF) is a mathematical algorithm that estimates the internal state of a system (e.g., position, velocity) based on noisy measurements and a predictive model of how the system behaves. The standard (linear) Kalman Filter assumes the system dynamics (state transitions) and measurement models are linear.</p>

<p>Real-world systems—especially those involving orientation, rotations, or non-linear sensor models (e.g., fusing IMU acceleration, odometry, GPS position, magnetometer) often do not follow purely linear equations. That’s where the Extended Kalman Filter (EKF) comes in. It’s a widely used sensor fusion algorithm that handles non-linear system and measurement models by locally linearizing them. Luckily we don’t have to bother too much about its implementation in this lesson because we’ll use a package that is widely used in robotics applications for years around the world. It’s the <a href="https://docs.ros.org/en/melodic/api/robot_localization/html/index.html">robot localization package</a> that you can install with the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>ros-jazzy-robot-localization

</code></pre></div></div>

<p>To configure <code class="language-plaintext highlighter-rouge">robot_localization</code> package can be tricky in the beginning, but I already created a config yaml file in the <code class="language-plaintext highlighter-rouge">config</code> folder based on the official guidelines that will do the job in this lesson. Important to notice that <code class="language-plaintext highlighter-rouge">robot_localization</code> will publish a filtered odometry topic and also a transformation between the robot’s <code class="language-plaintext highlighter-rouge">base_link</code> and this improved odometry coordinate system.</p>

<p>From the <code class="language-plaintext highlighter-rouge">rqt_tf_tree</code> tool we cannot tell which node is broadcasting the TF:
<img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/tf-tree.png" alt="alt text" title="TF Tree"></p>
<blockquote>
  <p>Run <code class="language-plaintext highlighter-rouge">rqt_tf_tree</code> with the following command: <code class="language-plaintext highlighter-rouge">ros2 run rqt_tf_tree rqt_tf_tree</code></p>
</blockquote>

<p>But we can take a look into the <code class="language-plaintext highlighter-rouge">/tf</code> topic which nodes are publishing:
<code class="language-plaintext highlighter-rouge">ros2 topic info /tf --verbose</code></p>

<p>And we will see 2 publisher nodes, the <code class="language-plaintext highlighter-rouge">ros_gz_bridge</code> and the <code class="language-plaintext highlighter-rouge">robot_state_publisher</code> as we expected.</p>

<p>Since a robot cannot have 2 odomnetry transformation we have to stop Gazebo doing it. The easiest way is simply not bridging it anymore with the <code class="language-plaintext highlighter-rouge">parameter_bridge</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># Node to bridge /cmd_vel and /odom
</span>    <span class="n">gz_bridge_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">ros_gz_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">parameter_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">/clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/cmd_vel@geometry_msgs/msg/Twist@gz.msgs.Twist</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/odom@nav_msgs/msg/Odometry@gz.msgs.Odometry</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/joint_states@sensor_msgs/msg/JointState@gz.msgs.Model</span><span class="sh">"</span><span class="p">,</span>
            <span class="c1">#"/tf@tf2_msgs/msg/TFMessage@gz.msgs.Pose_V",
</span>            <span class="c1">#"/camera/image@sensor_msgs/msg/Image@gz.msgs.Image",
</span>            <span class="sh">"</span><span class="s">/camera/camera_info@sensor_msgs/msg/CameraInfo@gz.msgs.CameraInfo</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">imu@sensor_msgs/msg/Imu@gz.msgs.IMU</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">"</span><span class="s">screen</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">)},</span>
        <span class="p">]</span>
    <span class="p">)</span>

</code></pre></div></div>

<p>And then let’s add the <code class="language-plaintext highlighter-rouge">robot_localization</code> to the launch file:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">ekf_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">robot_localization</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">ekf_node</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">ekf_filter_node</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">'</span><span class="s">screen</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
            <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">pkg_bme_gazebo_sensors</span><span class="p">,</span> <span class="sh">'</span><span class="s">config</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ekf.yaml</span><span class="sh">'</span><span class="p">),</span>
            <span class="p">{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">)},</span>
             <span class="p">]</span>
    <span class="p">)</span>

</code></pre></div></div>

<p>And of course, add the new node to the <code class="language-plaintext highlighter-rouge">launchDescription</code> object:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">launchDescriptionObject</span><span class="p">.</span><span class="nf">add_action</span><span class="p">(</span><span class="n">ekf_node</span><span class="p">)</span>

</code></pre></div></div>

<p>Rebuild the workspace and let’s try it out!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ros2 launch bme_gazebo_sensors spawn_robot.launch.py

</code></pre></div></div>

<p>As we expected the <code class="language-plaintext highlighter-rouge">tf_tree</code> looks the same, but if we check the publishers of the <code class="language-plaintext highlighter-rouge">/tf</code> we’ll see the following nodes: <code class="language-plaintext highlighter-rouge">ekf_filter_node</code> and <code class="language-plaintext highlighter-rouge">robot_state_publisher</code>. We can also see that there is a <code class="language-plaintext highlighter-rouge">/odometry/filtered</code> topic published by the <code class="language-plaintext highlighter-rouge">ekf_filter_node</code>.</p>

<p>But how could we validate that odometry is improved with adding the ekf sensor fusion? We can use the <code class="language-plaintext highlighter-rouge">mogi_trajectory_server</code> package for that. By default the trajectory server gets its data from the <code class="language-plaintext highlighter-rouge">/tf</code> but there is another node in the package that can subscribe to the original <code class="language-plaintext highlighter-rouge">/odom</code> topic which is basically identical to the old transformation between the <code class="language-plaintext highlighter-rouge">base_link</code> and <code class="language-plaintext highlighter-rouge">odom</code> frame. Let’s add it to the launch file:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">trajectory_odom_topic_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">'</span><span class="s">mogi_trajectory_server</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">'</span><span class="s">mogi_trajectory_server_topic_based</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">mogi_trajectory_server_odom_topic</span><span class="sh">'</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="sh">'</span><span class="s">trajectory_topic</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">trajectory_raw</span><span class="sh">'</span><span class="p">},</span>
                    <span class="p">{</span><span class="sh">'</span><span class="s">odometry_topic</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">odom</span><span class="sh">'</span><span class="p">}]</span>
    <span class="p">)</span>

</code></pre></div></div>

<p>Also add it to the <code class="language-plaintext highlighter-rouge">launchDescription</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">launchDescriptionObject</span><span class="p">.</span><span class="nf">add_action</span><span class="p">(</span><span class="n">trajectory_odom_topic_node</span><span class="p">)</span>

</code></pre></div></div>

<p>Rebuild the workspace, restart the simulation and let’s see the 2 trajectories in RViz:
<img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/odometry.png" alt="alt text" title="Odometry"></p>

<p>We can see that the yellow (raw) odometry starts drifting away from the corrected one very quickly and we can easily bring the robot into a special situation if we drive on a curve and hit the wall. In this case the robot is unable to move and the wheels are slipping. The raw odometry believes from the encoder signals that the robot is still moving on a curve while the odometry after the ekf sensor fusion will believe that the robot moves forward straight. Although none of them are correct, but remember, neither the IMU and neither the odometry can tell if the robot is doing an uniform movement or it’s stand still. At least the ekf is able to properly tell that the robot’s orientation is not changing regardless what the encoders measure.</p>

<h1 id="gps">GPS</h1>

<p>Just as we did for the GPS we add another simple link and joint for the simulated GPS in the <code class="language-plaintext highlighter-rouge">urdf</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c">&lt;!-- STEP 9 - GPS --&gt;</span>
  <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"navsat_joint"</span> <span class="na">type=</span><span class="s">"fixed"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"navsat_link"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">"navsat_link"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

</code></pre></div></div>

<p>And we add the Gazebo plugin:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"navsat_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sensor</span> <span class="na">name=</span><span class="s">"navsat"</span> <span class="na">type=</span><span class="s">"navsat"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;always_on&gt;</span>1<span class="nt">&lt;/always_on&gt;</span>
      <span class="nt">&lt;update_rate&gt;</span>1<span class="nt">&lt;/update_rate&gt;</span>
      <span class="nt">&lt;topic&gt;</span>navsat<span class="nt">&lt;/topic&gt;</span>
      <span class="nt">&lt;gz_frame_id&gt;</span>navsat_link<span class="nt">&lt;/gz_frame_id&gt;</span>
    <span class="nt">&lt;/sensor&gt;</span>
  <span class="nt">&lt;/gazebo&gt;</span>

</code></pre></div></div>

<p>We also have to add a plugin the worlds we use similarly to the IMU and furthermore we have to define what is the latitude and longitude of the centerpoint of the simulated world.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;plugin</span>
      <span class="na">filename=</span><span class="s">"gz-sim-navsat-system"</span>
      <span class="na">name=</span><span class="s">"gz::sim::systems::NavSat"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/plugin&gt;</span>
    <span class="c">&lt;!-- Set the coordinates for the world origin --&gt;</span>
    <span class="nt">&lt;spherical_coordinates&gt;</span>
      <span class="nt">&lt;surface_model&gt;</span>EARTH_WGS84<span class="nt">&lt;/surface_model&gt;</span>
      <span class="nt">&lt;world_frame_orientation&gt;</span>ENU<span class="nt">&lt;/world_frame_orientation&gt;</span>
      <span class="nt">&lt;latitude_deg&gt;</span>47.478950<span class="nt">&lt;/latitude_deg&gt;</span>
      <span class="nt">&lt;longitude_deg&gt;</span>19.057785<span class="nt">&lt;/longitude_deg&gt;</span>
      <span class="nt">&lt;elevation&gt;</span>0<span class="nt">&lt;/elevation&gt;</span>
      <span class="nt">&lt;heading_deg&gt;</span>0<span class="nt">&lt;/heading_deg&gt;</span>
    <span class="nt">&lt;/spherical_coordinates&gt;</span>

</code></pre></div></div>

<p>When all of these are done, we have to still extend the topic forwarding in the <code class="language-plaintext highlighter-rouge">parameter_bridge</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># Node to bridge /cmd_vel and /odom
</span>    <span class="n">gz_bridge_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">ros_gz_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">parameter_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">/clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/cmd_vel@geometry_msgs/msg/Twist@gz.msgs.Twist</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/odom@nav_msgs/msg/Odometry@gz.msgs.Odometry</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/joint_states@sensor_msgs/msg/JointState@gz.msgs.Model</span><span class="sh">"</span><span class="p">,</span>
            <span class="c1">#"/tf@tf2_msgs/msg/TFMessage@gz.msgs.Pose_V",
</span>            <span class="c1">#"/camera/image@sensor_msgs/msg/Image@gz.msgs.Image",
</span>            <span class="sh">"</span><span class="s">/camera/camera_info@sensor_msgs/msg/CameraInfo@gz.msgs.CameraInfo</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">imu@sensor_msgs/msg/Imu@gz.msgs.IMU</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/navsat@sensor_msgs/msg/NavSatFix@gz.msgs.NavSat</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">"</span><span class="s">screen</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">)},</span>
        <span class="p">]</span>
    <span class="p">)</span>

</code></pre></div></div>

<p>Let’s rebuild the workspace and check the <code class="language-plaintext highlighter-rouge">navsat</code> topic.
<img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/navsat.png" alt="alt text" title="Navsat"></p>

<p>But what can we do with this simulated GPS?</p>

<h2 id="haversine-formula">Haversine formula</h2>
<p>Before we can move forward to practical application we have to learn the haversine formula. It is used to calculate the great-circle distance between two points on a sphere (e.g. the Earth) from their latitudes and longitudes. It accounts for the spherical shape of the planet, making it more accurate than simple Euclidean distance formulas when dealing with geographical coordinates. By using half-angle trigonometric functions, it avoids numerical issues for small distances and is thus a popular choice in navigation and mapping applications.</p>

<p>The haversine formula results in a distance and bearing between 2 points on the sphere, where the bearing is measured clockwise from north. 0° bearing corresponds to North, 90° bearing corresponds to East, etc.</p>

<p>Let’s see the haversine formula implemented in python and we can try it with a few different cities:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="n">math</span>

<span class="k">def</span> <span class="nf">haversine</span><span class="p">(</span><span class="n">lat1_deg</span><span class="p">,</span> <span class="n">lon1_deg</span><span class="p">,</span> <span class="n">lat2_deg</span><span class="p">,</span> <span class="n">lon2_deg</span><span class="p">):</span>
    <span class="c1"># 0. Radius of earth in km
</span>    <span class="n">R</span> <span class="o">=</span> <span class="mf">6378.137</span>
    <span class="c1"># 1. Convert from degrees to radians
</span>    <span class="n">lat1</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">radians</span><span class="p">(</span><span class="n">lat1_deg</span><span class="p">)</span>
    <span class="n">lon1</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">radians</span><span class="p">(</span><span class="n">lon1_deg</span><span class="p">)</span>
    <span class="n">lat2</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">radians</span><span class="p">(</span><span class="n">lat2_deg</span><span class="p">)</span>
    <span class="n">lon2</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">radians</span><span class="p">(</span><span class="n">lon2_deg</span><span class="p">)</span>

    <span class="c1"># 2. Haversine formula for distance
</span>    <span class="n">dlat</span> <span class="o">=</span> <span class="n">lat2</span> <span class="o">-</span> <span class="n">lat1</span>
    <span class="n">dlon</span> <span class="o">=</span> <span class="n">lon2</span> <span class="o">-</span> <span class="n">lon1</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">dlat</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">dlon</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">asin</span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
    <span class="n">distance_km</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="n">c</span>

    <span class="c1"># 3. Initial bearing calculation (forward azimuth)
</span>    <span class="n">y</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">dlon</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">dlon</span><span class="p">)</span>
    <span class="n">bearing_rad</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">atan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># range -π to +π
</span>
    <span class="c1"># 4. Convert to degrees [0, 360)
</span>    <span class="n">bearing_deg</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">degrees</span><span class="p">(</span><span class="n">bearing_rad</span><span class="p">)</span>
    <span class="n">bearing_deg</span> <span class="o">=</span> <span class="p">(</span><span class="n">bearing_deg</span> <span class="o">+</span> <span class="mi">360</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>  <span class="c1"># normalize
</span>
    <span class="k">return</span> <span class="n">distance_km</span><span class="p">,</span> <span class="n">bearing_deg</span>

<span class="c1"># (latitude, longitude)
</span><span class="n">new_york</span>   <span class="o">=</span> <span class="p">(</span><span class="mf">40.66964055858272</span><span class="p">,</span>  <span class="o">-</span><span class="mf">73.2918438988026</span><span class="p">)</span>
<span class="n">montreal</span>   <span class="o">=</span> <span class="p">(</span><span class="mf">45.499155994690476</span><span class="p">,</span> <span class="o">-</span><span class="mf">73.5187471087869</span><span class="p">)</span>
<span class="n">madrid</span>     <span class="o">=</span> <span class="p">(</span><span class="mf">40.42545972472332</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.577711461862623</span><span class="p">)</span>
<span class="n">glasgow</span>    <span class="o">=</span> <span class="p">(</span><span class="mf">55.86725614373743</span><span class="p">,</span>  <span class="o">-</span><span class="mf">4.22935951146214</span><span class="p">)</span>
<span class="n">copenhagen</span> <span class="o">=</span> <span class="p">(</span><span class="mf">55.711247305054904</span><span class="p">,</span> <span class="mf">12.585837172964045</span><span class="p">)</span>


<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">New York to Montreal: </span><span class="sh">"</span><span class="p">,</span> <span class="nf">haversine</span><span class="p">(</span><span class="n">new_york</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">new_york</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">montreal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">montreal</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>    <span class="c1"># Should be 540 km
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">New York to Madrid: </span><span class="sh">"</span><span class="p">,</span> <span class="nf">haversine</span><span class="p">(</span><span class="n">new_york</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">new_york</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">madrid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">madrid</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>          <span class="c1"># Should be 5730 km
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Glasgow to Madrid: </span><span class="sh">"</span><span class="p">,</span> <span class="nf">haversine</span><span class="p">(</span><span class="n">glasgow</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">glasgow</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">madrid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">madrid</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>             <span class="c1"># Should be 1720 km
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Copenhagen to Glasgow: </span><span class="sh">"</span><span class="p">,</span> <span class="nf">haversine</span><span class="p">(</span><span class="n">copenhagen</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">copenhagen</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">glasgow</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">glasgow</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># Should be 1050 km
</span>
</code></pre></div></div>

<p>The results are the following:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">python</span> <span class="n">haversine_test</span><span class="p">.</span><span class="n">py</span> 
<span class="n">New</span> <span class="n">York</span> <span class="n">to</span> <span class="n">Montreal</span><span class="p">:</span>  <span class="p">(</span><span class="mf">537.9349305919243</span><span class="p">,</span> <span class="mf">358.1117237377836</span><span class="p">)</span>
<span class="n">New</span> <span class="n">York</span> <span class="n">to</span> <span class="n">Madrid</span><span class="p">:</span>  <span class="p">(</span><span class="mf">5730.769414305992</span><span class="p">,</span> <span class="mf">65.87069002082472</span><span class="p">)</span>
<span class="n">Glasgow</span> <span class="n">to</span> <span class="n">Madrid</span><span class="p">:</span>  <span class="p">(</span><span class="mf">1719.634568091304</span><span class="p">,</span> <span class="mf">178.13731351039723</span><span class="p">)</span>
<span class="n">Copenhagen</span> <span class="n">to</span> <span class="n">Glasgow</span><span class="p">:</span>  <span class="p">(</span><span class="mf">1049.9843791993976</span><span class="p">,</span> <span class="mf">277.9072459115459</span><span class="p">)</span>

</code></pre></div></div>

<p>Which is pretty much what we expected, except the bearing from New York to Madrid. Madrid is just perfectly to the east from New York, but the bearing isn’t even close to 90°. Great-circle navigation on a sphere (or ellipsoid) doesn’t always match our intuitive “straight line on a flat map”. Despite New York and Madrid having similar latitudes, the difference in longitude is large (roughly 70° of longitude). To reach Madrid along the shortest path, the great-circle solution will “curve” somewhat. The initial bearing in a great-circle sense is typically northeast (less than 90°), <a href="https://www.greatcirclemap.com/globe?fbclid=IwAR06f4ZtxJYeLPikyCc87FomfFToelVzD6-4jrdiYp5RIo4GIQ0a-Vb3MUE&amp;routes=%20JFK-MAD">because you tend to move slightly northward initially</a> before you “swing” back southward across the Atlantic. This yields an initial bearing from New York to Madrid around 66° which is noticeably less than 90°.</p>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/new-york-madrid.png" alt="alt text" title="New York - Madrid"></p>

<h2 id="gps-waypoint-following">GPS waypoint following</h2>

<p>Let’s get back to our lesson and navigate through a series of GPS waypoints using the above formula. Before we deep dive into our new node let’s make sure that the necessary RViz plugin is installed to show an aerial map in RViz. This plugin can use various map services (<a href="https://www.openstreetmap.org/search?lat=47.479099&amp;lon=19.057811">e.g. OpenStreetMap in our case</a>), and you can find the details about its setup <a href="https://github.com/nobleo/rviz_satellite">on its GitHub page</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>ros-jazzy-rviz-satellite

</code></pre></div></div>

<p>Let’s spawn our robot in an empty world with a different RViz config where the plugin is already configured:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ros2 launch bme_gazebo_sensors spawn_robot.launch.py world:<span class="o">=</span>empty.sdf rviz_config:<span class="o">=</span>gps.rviz x:<span class="o">=</span>0.0 y:<span class="o">=</span>0.0 yaw:<span class="o">=</span>0.0

</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/rviz-gps.png" alt="alt text" title="RViz GPS"></p>

<p>Let’s take a look on the <code class="language-plaintext highlighter-rouge">gps_waypoint_follower.py</code> which is part of this lesson. It uses the exact same haversine function, but this time we’ll use it in meters and radian instead of km and degrees.</p>

<p>To get the yaw angle of the robot we will have to convert the robot’s orientation in quaternion into Euler angles. Make sure that the necessary package is installed: <code class="language-plaintext highlighter-rouge">sudo apt install ros-jazzy-tf-transformations</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">imu_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">orientation_q</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">orientation</span>
        <span class="n">orientation_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">orientation_q</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">orientation_q</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">orientation_q</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">orientation_q</span><span class="p">.</span><span class="n">w</span><span class="p">]</span>
        <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">roll</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">pitch</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">yaw</span><span class="p">)</span> <span class="o">=</span> <span class="nf">euler_from_quaternion </span><span class="p">(</span><span class="n">orientation_list</span><span class="p">)</span>

</code></pre></div></div>

<p>Also note that the default convention for ROS for rotations around the z-axis follows the right hand rule. Consequently, rotating counterclockwise about the z-axis corresponds to a positive increase in yaw, while rotating clockwise corresponds to a negative yaw change. But bearing is a compass-like convention: 0° at North, increasing when turning clockwise. So we have to make sure that the we convert bearing to the same convention as the robot’s yaw angle.</p>

<p>Let’s start the node:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ros2 run bme_gazebo_sensors_py gps_waypoint_follower

</code></pre></div></div>

<p>The node will navigate through 4 waypoints and stops after that.</p>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/rviz-gps-1.png" alt="alt text" title="RViz GPS"></p>

<h1 id="lidar">Lidar</h1>

<p>LIDAR (an acronym for “Light Detection and Ranging” or “Laser Imaging, Detection, and Ranging”) is a sensing technology that uses laser light to measure distances. LIDAR sensor typically emits pulses of laser light in a scanning pattern (2D or 3D) and measures how long it takes for the light to return after hitting nearby objects. From this, the system computes distances to obstacles or surfaces in the environment. By continuously scanning the surroundings, the LIDAR provides a 2D or 3D map of distances to any objects around the robot. Lidars are simple and important sensors of almost every mobile robot applications, it’s widely used in Simultaneous Localization and Mapping (SLAM) algorithms which use LIDAR scans to build a map of the environment in real time while also estimating the robot’s pose (position and orientation) within that map.</p>

<p>First, we start with a simple 2D lidar, let’s add it to the urdf:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c">&lt;!-- STEP 10 - Lidar --&gt;</span>
  <span class="nt">&lt;joint</span> <span class="na">type=</span><span class="s">"fixed"</span> <span class="na">name=</span><span class="s">"scan_joint"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0.0 0 0.15"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;child</span> <span class="na">link=</span><span class="s">"scan_link"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;parent</span> <span class="na">link=</span><span class="s">"base_link"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;axis</span> <span class="na">xyz=</span><span class="s">"0 1 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/joint&gt;</span>

  <span class="nt">&lt;link</span> <span class="na">name=</span><span class="s">'scan_link'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;inertial&gt;</span>
      <span class="nt">&lt;mass</span> <span class="na">value=</span><span class="s">"1e-5"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;inertia</span>
          <span class="na">ixx=</span><span class="s">"1e-6"</span> <span class="na">ixy=</span><span class="s">"0"</span> <span class="na">ixz=</span><span class="s">"0"</span>
          <span class="na">iyy=</span><span class="s">"1e-6"</span> <span class="na">iyz=</span><span class="s">"0"</span>
          <span class="na">izz=</span><span class="s">"1e-6"</span>
      <span class="nt">/&gt;</span>
    <span class="nt">&lt;/inertial&gt;</span>
    <span class="nt">&lt;collision</span> <span class="na">name=</span><span class="s">'collision'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span> 
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;box</span> <span class="na">size=</span><span class="s">".1 .1 .1"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
    <span class="nt">&lt;/collision&gt;</span>

    <span class="nt">&lt;visual</span> <span class="na">name=</span><span class="s">'scan_link_visual'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;origin</span> <span class="na">xyz=</span><span class="s">"0 0 0"</span> <span class="na">rpy=</span><span class="s">"0 0 0"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;geometry&gt;</span>
        <span class="nt">&lt;mesh</span> <span class="na">filename =</span> <span class="s">"package://bme_gazebo_sensors/meshes/lidar.dae"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/geometry&gt;</span>
    <span class="nt">&lt;/visual&gt;</span>
  <span class="nt">&lt;/link&gt;</span>

</code></pre></div></div>

<p>Then add the plugin to the <code class="language-plaintext highlighter-rouge">mogi_bot.gazebo</code> file:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"scan_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sensor</span> <span class="na">name=</span><span class="s">"gpu_lidar"</span> <span class="na">type=</span><span class="s">"gpu_lidar"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;update_rate&gt;</span>10<span class="nt">&lt;/update_rate&gt;</span>
      <span class="nt">&lt;topic&gt;</span>scan<span class="nt">&lt;/topic&gt;</span>
      <span class="nt">&lt;gz_frame_id&gt;</span>scan_link<span class="nt">&lt;/gz_frame_id&gt;</span>
      <span class="nt">&lt;lidar&gt;</span>
        <span class="nt">&lt;scan&gt;</span>
          <span class="nt">&lt;horizontal&gt;</span>
            <span class="nt">&lt;samples&gt;</span>720<span class="nt">&lt;/samples&gt;</span>
            <span class="c">&lt;!--(max_angle-min_angle)/samples * resolution --&gt;</span>
            <span class="nt">&lt;resolution&gt;</span>1<span class="nt">&lt;/resolution&gt;</span>
            <span class="nt">&lt;min_angle&gt;</span>-3.14156<span class="nt">&lt;/min_angle&gt;</span>
            <span class="nt">&lt;max_angle&gt;</span>3.14156<span class="nt">&lt;/max_angle&gt;</span>
          <span class="nt">&lt;/horizontal&gt;</span>
          <span class="c">&lt;!-- Dirty hack for fake lidar detections with ogre 1 rendering in VM --&gt;</span>
          <span class="c">&lt;!-- &lt;vertical&gt;
              &lt;samples&gt;3&lt;/samples&gt;
              &lt;min_angle&gt;-0.001&lt;/min_angle&gt;
              &lt;max_angle&gt;0.001&lt;/max_angle&gt;
          &lt;/vertical&gt; --&gt;</span>
        <span class="nt">&lt;/scan&gt;</span>
        <span class="nt">&lt;range&gt;</span>
          <span class="nt">&lt;min&gt;</span>0.05<span class="nt">&lt;/min&gt;</span>
          <span class="nt">&lt;max&gt;</span>10.0<span class="nt">&lt;/max&gt;</span>
          <span class="nt">&lt;resolution&gt;</span>0.01<span class="nt">&lt;/resolution&gt;</span>
        <span class="nt">&lt;/range&gt;</span>
        <span class="nt">&lt;noise&gt;</span>
            <span class="nt">&lt;type&gt;</span>gaussian<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;mean&gt;</span>0.0<span class="nt">&lt;/mean&gt;</span>
            <span class="nt">&lt;stddev&gt;</span>0.01<span class="nt">&lt;/stddev&gt;</span>
        <span class="nt">&lt;/noise&gt;</span>
        <span class="nt">&lt;frame_id&gt;</span>scan_link<span class="nt">&lt;/frame_id&gt;</span>
      <span class="nt">&lt;/lidar&gt;</span>
      <span class="nt">&lt;always_on&gt;</span>1<span class="nt">&lt;/always_on&gt;</span>
      <span class="nt">&lt;visualize&gt;</span>true<span class="nt">&lt;/visualize&gt;</span>
    <span class="nt">&lt;/sensor&gt;</span>
  <span class="nt">&lt;/gazebo&gt;</span>

</code></pre></div></div>

<blockquote>
  <p>If you are using OGRE 1 rendering in VM and lidar reading is not properly rendered (it renders only within a small circle around the sensor) you can try to enable 3 vertical samples with very small vertical angles.</p>
</blockquote>

<p>Before we can test our lidar we have to update the <code class="language-plaintext highlighter-rouge">parameter_bridge</code> to forward the lidar scan topic:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># Node to bridge /cmd_vel and /odom
</span>    <span class="n">gz_bridge_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">ros_gz_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">parameter_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">/clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/cmd_vel@geometry_msgs/msg/Twist@gz.msgs.Twist</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/odom@nav_msgs/msg/Odometry@gz.msgs.Odometry</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/joint_states@sensor_msgs/msg/JointState@gz.msgs.Model</span><span class="sh">"</span><span class="p">,</span>
            <span class="c1">#"/tf@tf2_msgs/msg/TFMessage@gz.msgs.Pose_V",
</span>            <span class="c1">#"/camera/image@sensor_msgs/msg/Image@gz.msgs.Image",
</span>            <span class="sh">"</span><span class="s">/camera/camera_info@sensor_msgs/msg/CameraInfo@gz.msgs.CameraInfo</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/imu@sensor_msgs/msg/Imu@gz.msgs.IMU</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/navsat@sensor_msgs/msg/NavSatFix@gz.msgs.NavSat</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/scan@sensor_msgs/msg/LaserScan@gz.msgs.LaserScan</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">"</span><span class="s">screen</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">)},</span>
        <span class="p">]</span>
    <span class="p">)</span>

</code></pre></div></div>

<p>Let’s try it in the simulation!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ros2 launch bme_gazebo_sensors spawn_robot.launch.py

</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/lidar.png" alt="alt text" title="Lidar"></p>

<p>We can also verify the rendering of lidars in Gazebo with the <code class="language-plaintext highlighter-rouge">Visualize Lidar</code> tool:</p>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/lidar-1.png" alt="alt text" title="Lidar"></p>

<p>If we increase decay time of the visualization of lidar scans and we drive around the robot we can do a very simple “mapping” of the environment. Although in the next lesson we will see that mapping algorithms are more complicated, usually this a good quick and dirty test on real robots if odometry, lidar scan and the other components are working well together.</p>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/lidar-2.png" alt="alt text" title="Lidar"></p>

<h2 id="3d-lidar">3D lidar</h2>

<p>If we want to simulate a 3D lidar we only have to increase the number of vertical samples together with the minimum and maximum angles. For example the following vertical parameters are matching a Velodyne VLP-32 sensor:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>          <span class="nt">&lt;vertical&gt;</span>
              <span class="nt">&lt;samples&gt;</span>32<span class="nt">&lt;/samples&gt;</span>
              <span class="nt">&lt;min_angle&gt;</span>-0.5353<span class="nt">&lt;/min_angle&gt;</span>
              <span class="nt">&lt;max_angle&gt;</span>0.1862<span class="nt">&lt;/max_angle&gt;</span>
          <span class="nt">&lt;/vertical&gt;</span>

</code></pre></div></div>

<p>To properly visualize a 3D point cloud in RViz we have to forward one more topic with <code class="language-plaintext highlighter-rouge">parameter_bridge</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># Node to bridge /cmd_vel and /odom
</span>    <span class="n">gz_bridge_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">ros_gz_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">parameter_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">/clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/cmd_vel@geometry_msgs/msg/Twist@gz.msgs.Twist</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/odom@nav_msgs/msg/Odometry@gz.msgs.Odometry</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/joint_states@sensor_msgs/msg/JointState@gz.msgs.Model</span><span class="sh">"</span><span class="p">,</span>
            <span class="c1">#"/tf@tf2_msgs/msg/TFMessage@gz.msgs.Pose_V",
</span>            <span class="c1">#"/camera/image@sensor_msgs/msg/Image@gz.msgs.Image",
</span>            <span class="sh">"</span><span class="s">/camera/camera_info@sensor_msgs/msg/CameraInfo@gz.msgs.CameraInfo</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/imu@sensor_msgs/msg/Imu@gz.msgs.IMU</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/navsat@sensor_msgs/msg/NavSatFix@gz.msgs.NavSat</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/scan@sensor_msgs/msg/LaserScan@gz.msgs.LaserScan</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/scan/points@sensor_msgs/msg/PointCloud2@gz.msgs.PointCloudPacked</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">"</span><span class="s">screen</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">)},</span>
        <span class="p">]</span>
    <span class="p">)</span>

</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ros2 launch bme_gazebo_sensors spawn_robot.launch.py

</code></pre></div></div>
<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/3d-lidar.png" alt="alt text" title="Lidar"></p>

<p>We can also increase the decay time just as we did with the 2D points.</p>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/3d-lidar-1.png" alt="alt text" title="Lidar"></p>

<h1 id="rgbd-camera">RGBD Camera</h1>

<p>Another way to get 3D pointclouds around the robot is using an RGBD camera which can tell not just the color but also the depth of every single pixel. To add an RGBD camera let’s replace the conventional camera with this one:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;gazebo</span> <span class="na">reference=</span><span class="s">"camera_link"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sensor</span> <span class="na">name=</span><span class="s">"rgbd_camera"</span> <span class="na">type=</span><span class="s">"rgbd_camera"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;camera&gt;</span>
        <span class="nt">&lt;horizontal_fov&gt;</span>1.25<span class="nt">&lt;/horizontal_fov&gt;</span>
        <span class="nt">&lt;image&gt;</span>
          <span class="nt">&lt;width&gt;</span>320<span class="nt">&lt;/width&gt;</span>
          <span class="nt">&lt;height&gt;</span>240<span class="nt">&lt;/height&gt;</span>
        <span class="nt">&lt;/image&gt;</span>
        <span class="nt">&lt;clip&gt;</span>
          <span class="nt">&lt;near&gt;</span>0.3<span class="nt">&lt;/near&gt;</span>
          <span class="nt">&lt;far&gt;</span>15<span class="nt">&lt;/far&gt;</span>
        <span class="nt">&lt;/clip&gt;</span>
        <span class="nt">&lt;optical_frame_id&gt;</span>camera_link_optical<span class="nt">&lt;/optical_frame_id&gt;</span>
      <span class="nt">&lt;/camera&gt;</span>
      <span class="nt">&lt;always_on&gt;</span>1<span class="nt">&lt;/always_on&gt;</span>
      <span class="nt">&lt;update_rate&gt;</span>20<span class="nt">&lt;/update_rate&gt;</span>
      <span class="nt">&lt;visualize&gt;</span>true<span class="nt">&lt;/visualize&gt;</span>
      <span class="nt">&lt;topic&gt;</span>camera<span class="nt">&lt;/topic&gt;</span>
      <span class="nt">&lt;gz_frame_id&gt;</span>camera_link<span class="nt">&lt;/gz_frame_id&gt;</span>
    <span class="nt">&lt;/sensor&gt;</span>
  <span class="nt">&lt;/gazebo&gt;</span>

</code></pre></div></div>

<p>And let’s forward 2 topics with the <code class="language-plaintext highlighter-rouge">parameter_bridge</code>:</p>
<ul>
  <li>
    <p>the <code class="language-plaintext highlighter-rouge">/camera/depth_image</code> which provides a grayscale camera stream where the grayscale values correspond to the distance of the individual pixels. RViz is able to render depth image topic and the color image topic together as a depth cloud.
<img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/depth-image.png" alt="alt text" title="Depth image"></p>
  </li>
  <li>
    <p>the <code class="language-plaintext highlighter-rouge">/camera/points</code> which is a 3D pointcloud, the same type as the 3D lidar’s point cloud. We can visualize it in RViz just as any point clouds.</p>
  </li>
</ul>

<p>Let’s add the topics to the parameter bridge:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># Node to bridge /cmd_vel and /odom
</span>    <span class="n">gz_bridge_node</span> <span class="o">=</span> <span class="nc">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="sh">"</span><span class="s">ros_gz_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="sh">"</span><span class="s">parameter_bridge</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
            <span class="sh">"</span><span class="s">/clock@rosgraph_msgs/msg/Clock[gz.msgs.Clock</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/cmd_vel@geometry_msgs/msg/Twist@gz.msgs.Twist</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/odom@nav_msgs/msg/Odometry@gz.msgs.Odometry</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/joint_states@sensor_msgs/msg/JointState@gz.msgs.Model</span><span class="sh">"</span><span class="p">,</span>
            <span class="c1">#"/tf@tf2_msgs/msg/TFMessage@gz.msgs.Pose_V",
</span>            <span class="c1">#"/camera/image@sensor_msgs/msg/Image@gz.msgs.Image",
</span>            <span class="sh">"</span><span class="s">/camera/camera_info@sensor_msgs/msg/CameraInfo@gz.msgs.CameraInfo</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/imu@sensor_msgs/msg/Imu@gz.msgs.IMU</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/navsat@sensor_msgs/msg/NavSatFix@gz.msgs.NavSat</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/scan@sensor_msgs/msg/LaserScan@gz.msgs.LaserScan</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/scan/points@sensor_msgs/msg/PointCloud2@gz.msgs.PointCloudPacked</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/camera/depth_image@sensor_msgs/msg/Image@gz.msgs.Image</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">/camera/points@sensor_msgs/msg/PointCloud2@gz.msgs.PointCloudPacked</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="sh">"</span><span class="s">screen</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">:</span> <span class="nc">LaunchConfiguration</span><span class="p">(</span><span class="sh">'</span><span class="s">use_sim_time</span><span class="sh">'</span><span class="p">)},</span>
        <span class="p">]</span>
    <span class="p">)</span>

</code></pre></div></div>

<p>Rebuild the workspace and let’s start the simulation:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ros2 launch bme_gazebo_sensors spawn_robot.launch.py

</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/rgbd-camera.png" alt="alt text" title="RGBD Camera"></p>

<p>The orientation of 3D point cloud isn’t correct because it’s interpreted in the <code class="language-plaintext highlighter-rouge">camera_link_optical</code> frame, let’s change the Gazebo plugin a little bit:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nt">&lt;optical_frame_id&gt;</span>camera_link<span class="nt">&lt;/optical_frame_id&gt;</span>

</code></pre></div></div>

<p>After rebuild we can try it out:</p>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/depth-cloud.png" alt="alt text" title="RGBD Camera"></p>

<p>Just as we saw before we can adjust the decay time to keep rendering the previous points:</p>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/depth-cloud-1.png" alt="alt text" title="RGBD Camera"></p>

<blockquote>
  <p>Gazebo support many more different sensors that we won’t cover in this lesson, you can find more examples <a href="https://github.com/gazebosim/gz-sim/tree/gz-sim8/examples/worlds">on the following link</a>.</p>
</blockquote>

<h1 id="image-processing-with-opencv">Image processing with OpenCV</h1>

<p>In this last chapter we’ll learn how to implement our own node for image processing using ROS and OpenCV.
First, let’s switch back to a conventional camera and create the new node within the <code class="language-plaintext highlighter-rouge">bme_gazebo_sensors_py</code> package.</p>

<blockquote>
  <p>If we want to use OpenCV and other python modules from a python virtual environment, we’ll have to add the following to the <code class="language-plaintext highlighter-rouge">setup.cfg</code> file inside our python package:</p>

  <div class="language-ini highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nn">[build_scripts]</span>
<span class="py">executable</span> <span class="p">=</span> <span class="s">/usr/bin/env python3</span>

</code></pre></div>  </div>
</blockquote>

<p>I’ll name it <code class="language-plaintext highlighter-rouge">chase_the_ball.py</code> because it will make our robot following a simulated red ball. But as the first step we just write a node that subscribes to the <code class="language-plaintext highlighter-rouge">/camera/image</code> topic, converts it to OpenCV compatible frame and dispays it using OpenCV:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">rclpy</span>
<span class="kn">from</span> <span class="n">rclpy.node</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="n">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="n">cv_bridge</span> <span class="kn">import</span> <span class="n">CvBridge</span>
<span class="kn">from</span> <span class="n">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Twist</span>
<span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">threading</span>

<span class="k">class</span> <span class="nc">ImageSubscriber</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sh">'</span><span class="s">image_subscriber</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Create a subscriber with a queue size of 1 to only keep the last frame
</span>        <span class="n">self</span><span class="p">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">create_subscription</span><span class="p">(</span>
            <span class="n">Image</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">camera/image</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">self</span><span class="p">.</span><span class="n">image_callback</span><span class="p">,</span>
            <span class="mi">1</span>  <span class="c1"># Queue size of 1
</span>        <span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">create_publisher</span><span class="p">(</span><span class="n">Twist</span><span class="p">,</span> <span class="sh">'</span><span class="s">cmd_vel</span><span class="sh">'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        
        <span class="c1"># Initialize CvBridge
</span>        <span class="n">self</span><span class="p">.</span><span class="n">bridge</span> <span class="o">=</span> <span class="nc">CvBridge</span><span class="p">()</span>
        
        <span class="c1"># Variable to store the latest frame
</span>        <span class="n">self</span><span class="p">.</span><span class="n">latest_frame</span> <span class="o">=</span> <span class="bp">None</span>       

        <span class="c1"># Flag to control the display loop
</span>        <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span> 

    <span class="k">def</span> <span class="nf">image_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Callback function to receive and store the latest frame.</span><span class="sh">"""</span>
        <span class="c1"># Convert ROS Image message to OpenCV format and store it
</span>        <span class="n">self</span><span class="p">.</span><span class="n">latest_frame</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="nf">imgmsg_to_cv2</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">bgr8</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">display_image</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Main loop to process and display the latest frame.</span><span class="sh">"""</span>
        <span class="c1"># Create a single OpenCV window
</span>        <span class="n">cv2</span><span class="p">.</span><span class="nf">namedWindow</span><span class="p">(</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
        <span class="n">cv2</span><span class="p">.</span><span class="nf">resizeWindow</span><span class="p">(</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span><span class="mi">600</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">rclpy</span><span class="p">.</span><span class="nf">ok</span><span class="p">():</span>
            <span class="c1"># Check if there is a new frame available
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">latest_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

                <span class="c1"># Process the current image
</span>                <span class="n">self</span><span class="p">.</span><span class="nf">process_image</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">latest_frame</span><span class="p">)</span>

                <span class="c1"># Show the latest frame
</span>                <span class="n">cv2</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">latest_frame</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">latest_frame</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># Clear the frame after displaying
</span>
            <span class="c1"># Check for quit key
</span>            <span class="k">if</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nf">ord</span><span class="p">(</span><span class="sh">'</span><span class="s">q</span><span class="sh">'</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">break</span>

            <span class="n">rclpy</span><span class="p">.</span><span class="nf">spin_once</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

        <span class="c1"># Close OpenCV window after quitting
</span>        <span class="n">cv2</span><span class="p">.</span><span class="nf">destroyAllWindows</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">process_image</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Image processing task.</span><span class="sh">"""</span>
        <span class="k">return</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">OpenCV version: %s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">cv2</span><span class="p">.</span><span class="n">__version__</span><span class="p">)</span>

    <span class="n">rclpy</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="nc">ImageSubscriber</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">node</span><span class="p">.</span><span class="nf">display_image</span><span class="p">()</span>  <span class="c1"># Run the display loop
</span>    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">node</span><span class="p">.</span><span class="nf">destroy_node</span><span class="p">()</span>
        <span class="n">rclpy</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>

</code></pre></div></div>

<blockquote>
  <p>We can quit the node if we press the <code class="language-plaintext highlighter-rouge">q</code> key on the OpenCV window!</p>
</blockquote>

<p>You have to install OpenCV for your python using <code class="language-plaintext highlighter-rouge">pip</code> or <code class="language-plaintext highlighter-rouge">pipx</code> depending your setup for python virtual environments, during these lessons I’m using OpenCV version 4.6.0. You also have to install the ROS-OpenCV bridge with <code class="language-plaintext highlighter-rouge">sudo apt install ros-jazzy-cv-bridge</code>.</p>

<p>When everything is installed we have to add the new node to <code class="language-plaintext highlighter-rouge">entry_points</code> of the <code class="language-plaintext highlighter-rouge">setup.py</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">'</span><span class="s">console_scripts</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span>
            <span class="sh">'</span><span class="s">image_republisher = bme_gazebo_sensors_py.image_republisher:main</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">gps_waypoint_follower = bme_gazebo_sensors_py.gps_waypoint_follower:main</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">chase_the_ball = bme_gazebo_sensors_py.chase_the_ball:main</span><span class="sh">'</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">},</span>

</code></pre></div></div>

<p>Let’s try it out after building the workspace, first we start the simulation then in another terminal we run the new node:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ros2 run bme_gazebo_sensors_py chase_the_ball

</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/opencv.png" alt="alt text" title="OpenCV"></p>

<p>As you can see the <code class="language-plaintext highlighter-rouge">process_image()</code> function is now just a placeholder and we’ll start implementing more features within this function later, but first let’s extend the node with better handling of the subscription to the image topic. If <code class="language-plaintext highlighter-rouge">process_image()</code> will take more time to run it will also block the execution of <code class="language-plaintext highlighter-rouge">rclpy.spin_once(self, timeout_sec=0.05)</code> that is needed to trigger the <code class="language-plaintext highlighter-rouge">image_callback()</code>. So let’s move the spin functionality to a separate thread:</p>

<p>Let’s change the <code class="language-plaintext highlighter-rouge">__init__()</code> constructor first:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="sh">'</span><span class="s">image_subscriber</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Create a subscriber with a queue size of 1 to only keep the last frame
</span>        <span class="n">self</span><span class="p">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">create_subscription</span><span class="p">(</span>
            <span class="n">Image</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">camera/image</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">self</span><span class="p">.</span><span class="n">image_callback</span><span class="p">,</span>
            <span class="mi">1</span>  <span class="c1"># Queue size of 1
</span>        <span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">create_publisher</span><span class="p">(</span><span class="n">Twist</span><span class="p">,</span> <span class="sh">'</span><span class="s">cmd_vel</span><span class="sh">'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        
        <span class="c1"># Initialize CvBridge
</span>        <span class="n">self</span><span class="p">.</span><span class="n">bridge</span> <span class="o">=</span> <span class="nc">CvBridge</span><span class="p">()</span>
        
        <span class="c1"># Variable to store the latest frame
</span>        <span class="n">self</span><span class="p">.</span><span class="n">latest_frame</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">frame_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>  <span class="c1"># Lock to ensure thread safety
</span>        
        <span class="c1"># Flag to control the display loop
</span>        <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># Start a separate thread for spinning (to ensure image_callback keeps receiving new frames)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">spin_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">spin_thread_func</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spin_thread</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

</code></pre></div></div>

<p>and then add the <code class="language-plaintext highlighter-rouge">spin_thread_func()</code> function and also implement a thread lock in <code class="language-plaintext highlighter-rouge">image_callback()</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">spin_thread_func</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Separate thread function for rclpy spinning.</span><span class="sh">"""</span>
        <span class="k">while</span> <span class="n">rclpy</span><span class="p">.</span><span class="nf">ok</span><span class="p">()</span> <span class="ow">and</span> <span class="n">self</span><span class="p">.</span><span class="n">running</span><span class="p">:</span>
            <span class="n">rclpy</span><span class="p">.</span><span class="nf">spin_once</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">image_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Callback function to receive and store the latest frame.</span><span class="sh">"""</span>
        <span class="c1"># Convert ROS Image message to OpenCV format and store it
</span>        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">frame_lock</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">latest_frame</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">bridge</span><span class="p">.</span><span class="nf">imgmsg_to_cv2</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="sh">"</span><span class="s">bgr8</span><span class="sh">"</span><span class="p">)</span>

</code></pre></div></div>

<p>Obviously, we don’t need <code class="language-plaintext highlighter-rouge">rclpy.spin_once(self, timeout_sec=0.05)</code> anymore within <code class="language-plaintext highlighter-rouge">display_image()</code>!</p>

<p>Let’s add a <code class="language-plaintext highlighter-rouge">stop()</code> function, too, to join the therads when we stop the node:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Stop the node and the spin thread.</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">spin_thread</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>

</code></pre></div></div>

<p>And we’ll call this <code class="language-plaintext highlighter-rouge">stop()</code> function when we stop the node in the <code class="language-plaintext highlighter-rouge">main()</code> function:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="nc">ImageSubscriber</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">node</span><span class="p">.</span><span class="nf">display_image</span><span class="p">()</span>  <span class="c1"># Run the display loop
</span>    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">node</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>  <span class="c1"># Ensure the spin thread and node stop properly
</span>        <span class="n">node</span><span class="p">.</span><span class="nf">destroy_node</span><span class="p">()</span>
        <span class="n">rclpy</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>

</code></pre></div></div>

<p>Let’s rebuild the workspace and try the node! We shouldn’t see any difference at this point, but the image callback is triggered on a separate thread now!</p>

<hr>

<p>Now let’s work on the image processing:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">process_image</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Image processing task.</span><span class="sh">"""</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nc">Twist</span><span class="p">()</span>
        <span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">rows</span><span class="p">,</span><span class="n">cols</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">R</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">B</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">convert2rgb</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="n">redMask</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">threshold_binary</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="p">(</span><span class="mi">220</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
        <span class="n">stackedMask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dstack</span><span class="p">((</span><span class="n">redMask</span><span class="p">,</span> <span class="n">redMask</span><span class="p">,</span> <span class="n">redMask</span><span class="p">))</span>
        <span class="n">contourMask</span> <span class="o">=</span> <span class="n">stackedMask</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
        <span class="n">crosshairMask</span> <span class="o">=</span> <span class="n">stackedMask</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>

        <span class="c1"># return value of findContours depends on OpenCV version
</span>        <span class="p">(</span><span class="n">contours</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">)</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">findContours</span><span class="p">(</span><span class="n">redMask</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">CHAIN_APPROX_NONE</span><span class="p">)</span>

        <span class="c1"># Find the biggest contour (if detected)
</span>        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">contours</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            
            <span class="n">c</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">contours</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">contourArea</span><span class="p">)</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">moments</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

            <span class="c1"># Make sure that "m00" won't cause ZeroDivisionError: float division by zero
</span>            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="sh">"</span><span class="s">m00</span><span class="sh">"</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cx</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="sh">"</span><span class="s">m10</span><span class="sh">"</span><span class="p">]</span> <span class="o">/</span> <span class="n">M</span><span class="p">[</span><span class="sh">"</span><span class="s">m00</span><span class="sh">"</span><span class="p">])</span>
                <span class="n">cy</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="sh">"</span><span class="s">m01</span><span class="sh">"</span><span class="p">]</span> <span class="o">/</span> <span class="n">M</span><span class="p">[</span><span class="sh">"</span><span class="s">m00</span><span class="sh">"</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

            <span class="c1"># Show contour and centroid
</span>            <span class="n">cv2</span><span class="p">.</span><span class="nf">drawContours</span><span class="p">(</span><span class="n">contourMask</span><span class="p">,</span> <span class="n">contours</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">cv2</span><span class="p">.</span><span class="nf">circle</span><span class="p">(</span><span class="n">contourMask</span><span class="p">,</span> <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Show crosshair and difference from middle point
</span>            <span class="n">cv2</span><span class="p">.</span><span class="nf">line</span><span class="p">(</span><span class="n">crosshairMask</span><span class="p">,(</span><span class="n">cx</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="n">cx</span><span class="p">,</span><span class="n">rows</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">cv2</span><span class="p">.</span><span class="nf">line</span><span class="p">(</span><span class="n">crosshairMask</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="n">cy</span><span class="p">),(</span><span class="n">cols</span><span class="p">,</span><span class="n">cy</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">cv2</span><span class="p">.</span><span class="nf">line</span><span class="p">(</span><span class="n">crosshairMask</span><span class="p">,(</span><span class="nf">int</span><span class="p">(</span><span class="n">cols</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="mi">0</span><span class="p">),(</span><span class="nf">int</span><span class="p">(</span><span class="n">cols</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">rows</span><span class="p">),(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Return processed frames
</span>        <span class="k">return</span> <span class="n">redMask</span><span class="p">,</span> <span class="n">contourMask</span><span class="p">,</span> <span class="n">crosshairMask</span>

    <span class="c1"># Convert to RGB channels
</span>    <span class="k">def</span> <span class="nf">convert2rgb</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">R</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">B</span>

    <span class="c1"># Apply threshold and result a binary image
</span>    <span class="k">def</span> <span class="nf">threshold_binary</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">255</span><span class="p">)):</span>
        <span class="n">binary</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">binary</span><span class="p">[(</span><span class="n">img</span> <span class="o">&gt;=</span> <span class="n">thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">img</span> <span class="o">&lt;=</span> <span class="n">thresh</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">binary</span><span class="o">*</span><span class="mi">255</span>

</code></pre></div></div>

<p>Let’s handle the return values of the <code class="language-plaintext highlighter-rouge">process_image()</code> and display them within the <code class="language-plaintext highlighter-rouge">display_image()</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">display_image</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Main loop to process and display the latest frame.</span><span class="sh">"""</span>
        <span class="c1"># Create a single OpenCV window
</span>        <span class="n">cv2</span><span class="p">.</span><span class="nf">namedWindow</span><span class="p">(</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
        <span class="n">cv2</span><span class="p">.</span><span class="nf">resizeWindow</span><span class="p">(</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span><span class="mi">600</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">rclpy</span><span class="p">.</span><span class="nf">ok</span><span class="p">():</span>
            <span class="c1"># Check if there is a new frame available
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">latest_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

                <span class="c1"># Process the current image
</span>                <span class="n">mask</span><span class="p">,</span> <span class="n">contour</span><span class="p">,</span> <span class="n">crosshair</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">process_image</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">latest_frame</span><span class="p">)</span>

                <span class="c1"># Show the latest frame
</span>                <span class="n">cv2</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">latest_frame</span><span class="p">)</span>
                <span class="n">cv2</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="sh">"</span><span class="s">mask</span><span class="sh">"</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
                <span class="n">cv2</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="sh">"</span><span class="s">contour</span><span class="sh">"</span><span class="p">,</span> <span class="n">contour</span><span class="p">)</span>
                <span class="n">cv2</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="sh">"</span><span class="s">crosshair</span><span class="sh">"</span><span class="p">,</span> <span class="n">crosshair</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">latest_frame</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># Clear the frame after displaying
</span>
            <span class="c1"># Check for quit key
</span>            <span class="k">if</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nf">ord</span><span class="p">(</span><span class="sh">'</span><span class="s">q</span><span class="sh">'</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">break</span>

        <span class="c1"># Close OpenCV window after quitting
</span>        <span class="n">cv2</span><span class="p">.</span><span class="nf">destroyAllWindows</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>

</code></pre></div></div>

<p>This time the node will open 4 OpenCV windows and try to find the red ball on the image. Let’s add a red ball to the simulation first using the <code class="language-plaintext highlighter-rouge">Resource Spawner</code> plugin of Gazebo:
<img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/red-ball.png" alt="alt text" title="Red ball in Gazebo"></p>

<p>Then let’s see the new windows of our node:</p>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/opencv-1.png" alt="alt text" title="OpenCV"></p>

<p>Handling many OpenCV windows can be uncomfortable, so before we start following the ball, let’s overlay the output of the image processing on the camera frame:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># Add small images to the top row of the main image
</span>    <span class="k">def</span> <span class="nf">add_small_pictures</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">small_images</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">120</span><span class="p">)):</span>

        <span class="n">x_base_offset</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="n">y_base_offset</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="n">x_offset</span> <span class="o">=</span> <span class="n">x_base_offset</span>
        <span class="n">y_offset</span> <span class="o">=</span> <span class="n">y_base_offset</span>

        <span class="k">for</span> <span class="n">small</span> <span class="ow">in</span> <span class="n">small_images</span><span class="p">:</span>
            <span class="n">small</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="n">small</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">small</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">small</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dstack</span><span class="p">((</span><span class="n">small</span><span class="p">,</span> <span class="n">small</span><span class="p">,</span> <span class="n">small</span><span class="p">))</span>

            <span class="n">img</span><span class="p">[</span><span class="n">y_offset</span><span class="p">:</span> <span class="n">y_offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_offset</span><span class="p">:</span> <span class="n">x_offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">small</span>

            <span class="n">x_offset</span> <span class="o">+=</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_base_offset</span>

        <span class="k">return</span> <span class="n">img</span>

</code></pre></div></div>

<p>Let’s modify the <code class="language-plaintext highlighter-rouge">display_image()</code> function:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">display_image</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Main loop to process and display the latest frame.</span><span class="sh">"""</span>
        <span class="c1"># Create a single OpenCV window
</span>        <span class="n">cv2</span><span class="p">.</span><span class="nf">namedWindow</span><span class="p">(</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
        <span class="n">cv2</span><span class="p">.</span><span class="nf">resizeWindow</span><span class="p">(</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span><span class="mi">600</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">rclpy</span><span class="p">.</span><span class="nf">ok</span><span class="p">():</span>
            <span class="c1"># Check if there is a new frame available
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">latest_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

                <span class="c1"># Process the current image
</span>                <span class="n">mask</span><span class="p">,</span> <span class="n">contour</span><span class="p">,</span> <span class="n">crosshair</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">process_image</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">latest_frame</span><span class="p">)</span>

                <span class="c1"># Add processed images as small images on top of main image
</span>                <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">add_small_pictures</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">latest_frame</span><span class="p">,</span> <span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="n">contour</span><span class="p">,</span> <span class="n">crosshair</span><span class="p">])</span>

                <span class="c1"># Show the latest frame
</span>                <span class="n">cv2</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="sh">"</span><span class="s">frame</span><span class="sh">"</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">latest_frame</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># Clear the frame after displaying
</span>
            <span class="c1"># Check for quit key
</span>            <span class="k">if</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nf">ord</span><span class="p">(</span><span class="sh">'</span><span class="s">q</span><span class="sh">'</span><span class="p">):</span>
                <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">break</span>

        <span class="c1"># Close OpenCV window after quitting
</span>        <span class="n">cv2</span><span class="p">.</span><span class="nf">destroyAllWindows</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>

</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/opencv-2.png" alt="alt text" title="OpenCV"></p>

<p>The last step is to add the following feature to the <code class="language-plaintext highlighter-rouge">process_image()</code> function righ after creating the crosshair image:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="bp">...</span>
            <span class="c1"># Chase the ball
</span>            <span class="k">if</span> <span class="nf">abs</span><span class="p">(</span><span class="n">cols</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">cx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">cols</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="n">cx</span><span class="p">:</span>
                    <span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.2</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.2</span>
                <span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Publish cmd_vel
</span>        <span class="n">self</span><span class="p">.</span><span class="n">publisher</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="bp">...</span>

</code></pre></div></div>

<p>And now the robot is able to follow the red ball in the Gazebo simulation:</p>

<p><a href="https://youtu.be/ELwRqeNR_NA"><img width="800" src="https://raw.githubusercontent.com/mogi-ros/week-5-6-gazebo-sensors/main/./assets/youtube-gazebo-1.png"></a></p>

</div>
            
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">CONTRIBUTING</h3></div>
          <div class="panel-body">
            
              <em>No CONTRIBUTING.md found.</em>
            
          </div>
        </div>

        
        
      
    </div>
  </div>

  <div class="distro distro-noetic">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/week-5-6-gazebo-sensors">week-5-6-gazebo-sensors</a> <small>repository</small></h3>
        <span class="label label-default">python</span> <span class="label label-default">opencv</span> <span class="label label-default">camera</span> <span class="label label-default">gps</span> <span class="label label-default">point-cloud</span> <span class="label label-default">imu</span> <span class="label label-default">lidar</span> <span class="label label-default">gazebo</span> <span class="label label-default">harmonic</span> <span class="label label-default">depth-camera</span> <span class="label label-default">rqt</span> <span class="label label-default">ros2</span> <span class="label label-default">ekf-localization</span> <span class="label label-default">rqt-reconfigure</span> <span class="label label-default">gazebosim</span> <span class="label label-default">fisheye-camera</span> 
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-mogi-ros-week-5-6-gazebo-sensors
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-mogi-ros-week-5-6-gazebo-sensors" role="menuitem" tabindex="-1" href="/r/week-5-6-gazebo-sensors/github-mogi-ros-week-5-6-gazebo-sensors" data="github-mogi-ros-week-5-6-gazebo-sensors">
                    <span class="glyphicon glyphicon-star"></span>
                    github-mogi-ros-week-5-6-gazebo-sensors
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        <div class="alert alert-warning" role="alert">No version for distro <strong>noetic</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-galactic">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/week-5-6-gazebo-sensors">week-5-6-gazebo-sensors</a> <small>repository</small></h3>
        <span class="label label-default">python</span> <span class="label label-default">opencv</span> <span class="label label-default">camera</span> <span class="label label-default">gps</span> <span class="label label-default">point-cloud</span> <span class="label label-default">imu</span> <span class="label label-default">lidar</span> <span class="label label-default">gazebo</span> <span class="label label-default">harmonic</span> <span class="label label-default">depth-camera</span> <span class="label label-default">rqt</span> <span class="label label-default">ros2</span> <span class="label label-default">ekf-localization</span> <span class="label label-default">rqt-reconfigure</span> <span class="label label-default">gazebosim</span> <span class="label label-default">fisheye-camera</span> 
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-mogi-ros-week-5-6-gazebo-sensors
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-mogi-ros-week-5-6-gazebo-sensors" role="menuitem" tabindex="-1" href="/r/week-5-6-gazebo-sensors/github-mogi-ros-week-5-6-gazebo-sensors" data="github-mogi-ros-week-5-6-gazebo-sensors">
                    <span class="glyphicon glyphicon-star"></span>
                    github-mogi-ros-week-5-6-gazebo-sensors
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        <div class="alert alert-warning" role="alert">No version for distro <strong>galactic</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-iron">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/week-5-6-gazebo-sensors">week-5-6-gazebo-sensors</a> <small>repository</small></h3>
        <span class="label label-default">python</span> <span class="label label-default">opencv</span> <span class="label label-default">camera</span> <span class="label label-default">gps</span> <span class="label label-default">point-cloud</span> <span class="label label-default">imu</span> <span class="label label-default">lidar</span> <span class="label label-default">gazebo</span> <span class="label label-default">harmonic</span> <span class="label label-default">depth-camera</span> <span class="label label-default">rqt</span> <span class="label label-default">ros2</span> <span class="label label-default">ekf-localization</span> <span class="label label-default">rqt-reconfigure</span> <span class="label label-default">gazebosim</span> <span class="label label-default">fisheye-camera</span> 
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-mogi-ros-week-5-6-gazebo-sensors
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-mogi-ros-week-5-6-gazebo-sensors" role="menuitem" tabindex="-1" href="/r/week-5-6-gazebo-sensors/github-mogi-ros-week-5-6-gazebo-sensors" data="github-mogi-ros-week-5-6-gazebo-sensors">
                    <span class="glyphicon glyphicon-star"></span>
                    github-mogi-ros-week-5-6-gazebo-sensors
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        <div class="alert alert-warning" role="alert">No version for distro <strong>iron</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-melodic">
    <div class="container-fluid">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/week-5-6-gazebo-sensors">week-5-6-gazebo-sensors</a> <small>repository</small></h3>
        <span class="label label-default">python</span> <span class="label label-default">opencv</span> <span class="label label-default">camera</span> <span class="label label-default">gps</span> <span class="label label-default">point-cloud</span> <span class="label label-default">imu</span> <span class="label label-default">lidar</span> <span class="label label-default">gazebo</span> <span class="label label-default">harmonic</span> <span class="label label-default">depth-camera</span> <span class="label label-default">rqt</span> <span class="label label-default">ros2</span> <span class="label label-default">ekf-localization</span> <span class="label label-default">rqt-reconfigure</span> <span class="label label-default">gazebosim</span> <span class="label label-default">fisheye-camera</span> 
        

      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-mogi-ros-week-5-6-gazebo-sensors
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-mogi-ros-week-5-6-gazebo-sensors" role="menuitem" tabindex="-1" href="/r/week-5-6-gazebo-sensors/github-mogi-ros-week-5-6-gazebo-sensors" data="github-mogi-ros-week-5-6-gazebo-sensors">
                    <span class="glyphicon glyphicon-star"></span>
                    github-mogi-ros-week-5-6-gazebo-sensors
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

      
        <div class="alert alert-warning" role="alert">No version for distro <strong>melodic</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>


<script src=/js/contribution_suggestions.js></script>
<script type="text/javascript">
  $(function() {
    setupContributeListTabLinks();
  });
  $(document).ready(function() {
    setupDistroSwitch("humble");
    setupContributeLists("https://github.com/mogi-ros/week-5-6-gazebo-sensors.git");
  });
</script>

      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="container-fluid">
      <div style="float:left;">
        
          <a href="https://github.com/rkent/rosindex" title="Find rosindex in Github">
          <span class="icon  icon--github">
            <svg viewBox="0 0 16 16">
              <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
            </svg>
          </span>

          <span class="username">rkent/rosindex</span>
        </a>
        <em class="hidden-xs">| generated on 2025-05-05</em>
      
      </div>
      <div style="float:right;">
        <p class="text"><span class="hidden-xs">a community-maintained index of robotics software
 | </span><a href="/privacy.txt">privacy</a></p>
      </div>
    </div>
  </div>

</footer>


  </body>

</html>
