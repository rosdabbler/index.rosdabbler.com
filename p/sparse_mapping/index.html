<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>ROS Package: sparse_mapping</title>
    <meta name="description" content="a community-maintained index of robotics software
">

    
    <link rel="canonical" href="http://index.rosdabbler.com/p/sparse_mapping/">
    
    
    <link rel="icon" sizes="any" type="image/svg+xml" href="/assets/rosindex_logo.svg">

    

    <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/css/main.css">
    

    

    <script type="text/javascript" src=/js/jquery.js></script>
    <script src=/bootstrap/js/bootstrap.min.js type="text/javascript"></script>
    <script src=/js/jquery-cookie.js type="text/javascript"></script>
    
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EVD5Z6G6NH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EVD5Z6G6NH');
</script>

    <script type="text/javascript" src=/js/toc.js></script>

    <script src=/js/distro_switch.js></script>
  </head>

  <body>

    <header class="site-header">

  <div class="wrapper">
    <div class="container-fluid" style="margin-bottom: 10px">
      <div class="row">
        <!-- title -->
        <div class="col-xs-3" style="white-space:nowrap">
          <a class="site-title" href="/">
            <img src="/assets/rosindex_logo.svg" width="26" height="26" alt="ROS index logo" style="padding-bottom: 3px"/>
            ROS Index</a>
        </div>
        <!-- main internal links -->
        <div class="col-xs-6 text-center" style="padding:0px">
          <div class="btn-group hidden-xs" role="group" aria-label="..." style="padding: 6px">
            <div class="btn-group" role="group">
              <a href="/?search_packages=true" class="btn btn-default" role="button">Package List</a>
            </div>
            <div class="btn-group" role="group">
              <a href="/?search_repos=true" class="btn btn-default" role="button">Repository List</a>
            </div>
            <div class="btn-group" role="group">
              <a href="/search_deps" class="btn btn-default" role="button">System Dependencies</a>
            </div>
          </div>
          <div class="hidden-lg hidden-md hidden-sm">
            <button id="hLabel" class="btn btn-link dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Lists <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" aria-labelledby="hLabel">
              <li><a href="/?search_packages=true">Package List</a></li>
              <li><a href="/?search_repos=true">Repository List</a></li>
              <li><a href="/search_deps">System Dependencies</a></li>
            </ul>
          </div>
        </div>
        <!-- additional links -->
        <div class="col-xs-3 text-right" style="white-space:nowrap; padding:0px">
          <ul class="list-inline" style="margin-bottom:0px;">
            <li class="dropdown hidden-xs hidden-sm">
              <button id="rLabel" class="btn btn-link" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                ROS Resources <span class="caret"></span>
              </button>
              <ul class="dropdown-menu" role="menu" aria-labelledby="rLabel">
                <li><a href="http://docs.ros.org/">Documentation</a></li>
                <li><a href="http://wiki.ros.org/Support">Support</a></li>
                <li><a href="http://discourse.ros.org/">Discussion Forum</a></li>
                <li><a href="http://status.ros.org/">Service Status</a></li>
                <li><a href="https://robotics.stackexchange.com/questions/tagged/ros">ros @ Robotics Stack Exchange</a></li>
                <li><a href="https://docs.ros.org/en/ros2_packages/">Package API</a></li>
              </ul>
            </li>
            <li class="dropdown hidden-xs hidden-sm">
              <button id="aLabel" class="btn btn-link" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                About <span class="caret"></span>
              </button>
              <ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="aLabel">
                <li><a href="/about">About </a></li>
                <li><a href="/contribute">Contribute</a></li>
                <li><a href="/help">Help</a></li>
                <li><a href="/stats">Stats</a></li>
              </ul>
            </li>
            <li class="dropdown hidden-md hidden-lg">
              <button id="qLabel" class="btn btn-link" type="button"
                      data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Resources <span class="caret"></span>
              </button>
              <ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="qLabel">
                <li><a href="/about">About </a></li>
                <li><a href="/contribute">Contribute</a></li>
                <li><a href="/help">Help</a></li>
                <li><a href="/stats">Stats</a></li>
                <hr style="margin:7px" />
                <li><a href="http://docs.ros.org/">Documentation</a></li>
                <li><a href="http://wiki.ros.org/Support">Support</a></li>
                <li><a href="http://discourse.ros.org/">Discussion Forum</a></li>
                <li><a href="http://status.ros.org/">Service Status</a></li>
                <li><a href="https://robotics.stackexchange.com/questions/tagged/ros">ros @ Robotics Stack Exchange</a></li>
                <li><a href="https://docs.ros.org/en/ros2_packages/">Package API</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="container-fluid" style="margin-top: 20px">
  <div class="container-fluid">
    <div class="row">
      <ol class="breadcrumb">
        <li><a href="/">Home</a></li>
        <li><a href="/?search_packages=true">Packages</a></li>
        <li class="active">sparse_mapping</li>
      </ol>
    </div>
    <div class="row">
      

<div id="distro-switch" class="btn-group btn-group-justified" data-toggle="buttons">
  
    <label id="humble-option" class="distro-button btn btn-xs btn-default" href="#humble" data="humble">
      <input type="radio" name="options" id="humble-radio" autocomplete="off"> humble
    </label>
  
    <label id="jazzy-option" class="distro-button btn btn-xs btn-default" href="#jazzy" data="jazzy">
      <input type="radio" name="options" id="jazzy-radio" autocomplete="off"> jazzy
    </label>
  
    <label id="kilted-option" class="distro-button btn btn-xs btn-default" href="#kilted" data="kilted">
      <input type="radio" name="options" id="kilted-radio" autocomplete="off"> kilted
    </label>
  
    <label id="rolling-option" class="distro-button btn btn-xs btn-default" href="#rolling" data="rolling">
      <input type="radio" name="options" id="rolling-radio" autocomplete="off"> rolling
    </label>
  
    <label id="github-option" class="distro-button btn btn-xs btn-default" href="#github" data="github">
      <input type="radio" name="options" id="github-radio" autocomplete="off"> github
    </label>
  
    <label id="noetic-option" class="distro-button btn btn-xs btn-primary" href="#noetic" data="noetic">
      <input type="radio" name="options" id="noetic-radio" autocomplete="off"> noetic
    </label>
  

  <!-- Older distros -->
  <div class="btn-group dropdown">
    <label type="button" class="btn btn-xs dropdown-toggle btn-primary" data-toggle="dropdown" id="older-distro-button">
        <input type="radio" name="options" autocomplete="off">
      <span id="older-label">Older</span>
      <span class="caret"></span>
    </label>
    <ul class="dropdown-menu" role="menu">
      
        <li data="galactic" id="galactic-option" class="disabled older-distro-option"  href="#galactic">
          <a href="#galactic" data="galactic" id="galactic-button">galactic</a>
        </li>
      
        <li data="iron" id="iron-option" class="disabled older-distro-option"  href="#iron">
          <a href="#iron" data="iron" id="iron-button">iron</a>
        </li>
      
        <li data="melodic" id="melodic-option" class=" older-distro-option"  href="#melodic">
          <a href="#melodic" data="melodic" id="melodic-button">melodic</a>
        </li>
      
    </ul>
  </div>
</div>

    </div>
    <div class="row">
      &nbsp;
    </div>
  </div>
</div>


  <div class="distro distro-humble">
    <div class="container-fluid">
      
          <div class="alert alert-warning">No version for distro <strong>humble</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-jazzy">
    <div class="container-fluid">
      
          <div class="alert alert-warning">No version for distro <strong>jazzy</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-kilted">
    <div class="container-fluid">
      
          <div class="alert alert-warning">No version for distro <strong>kilted</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-rolling">
    <div class="container-fluid">
      
          <div class="alert alert-warning">No version for distro <strong>rolling</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-github">
    <div class="container-fluid">
      
          <div class="alert alert-warning">No version for distro <strong>github</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-noetic">
    <div class="container-fluid">
      
        
        
        

        <div class="row">
          <div class="col-md-10">
            

<div class="well well-sm">
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px" src="/assets/package.png">
      </td>
      <td>
        <h3 style="margin-top: 5px">
          <a style="text-decoration:none" href="/p/sparse_mapping">sparse_mapping</a> <small>package from <a style="text-decoration:none" href="/r/astrobee/github-nasa-astrobee">astrobee</a> repo</small>
        </h3>
          
            
            
              <a class="label label-primary pkg-label" href="/p/astrobee">

astrobee
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/arm">

arm
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/dock">

dock
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/light_flow">

light_flow
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/perch">

perch
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/states">

states
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/comms_bridge">

comms_bridge
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/dds_msgs">

dds_msgs
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/dds_ros_bridge">

dds_ros_bridge
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ff_hw_msgs">

ff_hw_msgs
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ff_msgs">

ff_msgs
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ground_dds_ros_bridge">

ground_dds_ros_bridge
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/description">

description
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ctl">

ctl
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/fam">

fam
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/pmc">

pmc
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/eps_driver">

eps_driver
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/epson_imu">

epson_imu
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/fam_cmd_i2c">

fam_cmd_i2c
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ff_serial">

ff_serial
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/flashlight">

flashlight
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/gpio">

gpio
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/i2c">

i2c
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/is_camera">

is_camera
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/laser">

laser
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/perching_arm">

perching_arm
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/pico_driver">

pico_driver
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/pmc_actuator">

pmc_actuator
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/signal_lights">

signal_lights
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/smart_dock">

smart_dock
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/speed_cam">

speed_cam
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/temp_monitor">

temp_monitor
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/vive">

vive
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/camera">

camera
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/depth_odometry">

depth_odometry
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/factor_adders">

factor_adders
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/graph_factors">

graph_factors
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/graph_localizer">

graph_localizer
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/graph_optimizer">

graph_optimizer
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/graph_vio">

graph_vio
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ground_truth_localizer">

ground_truth_localizer
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/handrail_detect">

handrail_detect
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/imu_integration">

imu_integration
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/interest_point">

interest_point
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/lk_optical_flow">

lk_optical_flow
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/localization_common">

localization_common
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/localization_manager">

localization_manager
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/localization_measurements">

localization_measurements
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/localization_node">

localization_node
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/marker_tracking">

marker_tracking
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/node_adders">

node_adders
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/nodes">

nodes
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/optimization_common">

optimization_common
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/optimizers">

optimizers
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/parameter_reader">

parameter_reader
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/point_cloud_common">

point_cloud_common
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ros_graph_localizer">

ros_graph_localizer
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ros_graph_vio">

ros_graph_vio
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ros_pose_extrapolator">

ros_pose_extrapolator
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/sliding_window_graph_optimizer">

sliding_window_graph_optimizer
</a>
            
          
            
            
              <span class="label label-default pkg-label">

sparse_mapping
</span>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/tutorial_examples">

tutorial_examples
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/vision_common">

vision_common
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/vive_localization">

vive_localization
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/access_control">

access_control
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/cpu_mem_monitor">

cpu_mem_monitor
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/data_bagger">

data_bagger
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/disk_monitor">

disk_monitor
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/executive">

executive
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/image_sampler">

image_sampler
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/log_monitor">

log_monitor
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/sys_monitor">

sys_monitor
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/choreographer">

choreographer
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/framestore">

framestore
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/mapper">

mapper
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/mobility">

mobility
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/planner_qp">

planner_qp
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/traj_opt_basic">

traj_opt_basic
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/traj_opt_msgs">

traj_opt_msgs
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/traj_opt_pro">

traj_opt_pro
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/traj_opt_ros">

traj_opt_ros
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/planner_trapezoidal">

planner_trapezoidal
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/config_reader">

config_reader
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ff_common">

ff_common
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ff_util">

ff_util
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/jsonloader">

jsonloader
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/msg_conversions">

msg_conversions
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/astrobee_gazebo">

astrobee_gazebo
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/bag_processing">

bag_processing
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/calibration">

calibration
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/gds_helper">

gds_helper
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/gnc_visualizer">

gnc_visualizer
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/interactive_marker_teleop">

interactive_marker_teleop
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/localization_analysis">

localization_analysis
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/localization_rviz_plugins">

localization_rviz_plugins
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/performance_tester">

performance_tester
</a>
            
          
      </td>
    </tr>
  </table>
</div>

            <div class="visible-xs visible-sm">
              
              
              



<div class="list-group list-group-sm list-group-horizontal list-group-justified">
  <a class="list-group-item text-center"
     target="_blank"
     href="http://docs.ros.org/en/noetic/api/sparse_mapping/html/"
     title="View API documentation on docs.ros.org"
     >
       <span style="margin-right: 5px;" class="glyphicon glyphicon-file"></span>
       <br>
       API Docs
  </a>
  <a class="list-group-item text-center"
     target="_blank"
     href="https://github.com/nasa/astrobee/tree/master/localization/sparse_mapping"
     title="View source code on repository">
       <span class="glyphicon glyphicon-folder-open" style="margin-right:5px;"></span>
       <br>
       Browse Code
  </a>
  
  
  
  
  
  <a class="list-group-item text-center "
     target="_blank"
     href="http://wiki.ros.org/sparse_mapping?distro=noetic"
     title="View this package on wiki.ros.org">
       <span style="margin-right: 5px;" class="glyphicon glyphicon-info-sign"></span>
       <br>
       Wiki
  </a>
  
  
</div>

            </div>
            



<ul class="nav nav-tabs nav-justified" id="noetic-tabs" style="margin-bottom:20px">
  <li class="better-tabs active">
    <a href="#noetic-overview" data-toggle="tab">Overview</a>
  </li>
  <li class="better-tabs">
    
    
    
    
    
    <a href="#noetic-assets" data-toggle="tab"><span class="label label-default">0</span> Assets</a>
  </li>
  <li class="better-tabs">
    
    
    
    
    <a href="#noetic-deps" data-toggle="tab"><span class="label label-primary">9</span> Dependencies</a>
  </li>
  <li class="better-tabs">
    
    <a href="#noetic-tutorials" data-toggle="tab"><span class="label label-default">0</span> Tutorials</a>
  </li>
  <li class="better-tabs">
    <a href="#noetic-questions" data-toggle="tab"><span id="noetic-questions-count" class="label label-primary">0</span> Q & A</a>
  </li>
</ul>

<div class="tab-content">
  <div class="tab-pane active" id="noetic-overview">
    
    <div class="row">
      <div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
        <div class="panel panel-default">
          <div class="panel-heading"><h4 class="panel-title">Package Summary</h4></div>
          <div class="panel-body">
            <table class="table table-condensed">
              <tr>
                <td style="width:100px;" class="text-right"><strong>Tags</strong></td>
                <td>
                  
                  
                    <em>No category tags.</em>
                  
                </td>
              </tr>
              <tr>
                <td class="text-right"><strong>Version</strong></td>
                <td>1.0.0</td>
              </tr>
              <tr>
                <td class="text-right"><strong>License</strong></td>
                <td>
    Apache License, Version 2.0
  </td>
              </tr>
              <tr>
                <td class="text-right"><strong>Build type</strong></td>
                <td>
                  
                    <span class="label label-info">
                  
                    CATKIN</span>
                </td>
              </tr>
              <tr>
                <td class="text-right"><strong>Use</strong></td>
                <td>
                
                  <span class="label label-success">RECOMMENDED</span>
                
                </td>
              </tr>
            </table>
          </div>
          <div class="panel-heading"><h3 class="panel-title">Repository Summary</h3></div>
          <div class="panel-body">
            
            
            
  <link rel="stylesheet" href="/css/ci-status.css">
  <table class="table table-condensed">
    <tr>
      <td class="text-right"><b>Description</b></td>
      <td><span class="label label-default">NASA Astrobee Robot Software</span></td>
    </tr>
    <tr>
      <td style="width:100px;" class="text-right"><b>Checkout URI</b></td>
      <td><a class="label label-default" href="https://github.com/nasa/astrobee.git">https://github.com/nasa/astrobee.git</a></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Type</b></td>
      <td><span class="label label-default">git</span></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Version</b></td>
      <td><span class="label label-default">master</span></td>
    </tr>
    <tr>
      <td style="white-space: nowrap;" class="text-right"><b>Last Updated</b></div>
      <td>
        
          <span class="label label-default"><span class="glyphicon glyphicon-time"></span> 2024-07-03
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Dev Status</b></td>
      <td>
        
          <span class="label label-warning">UNKNOWN
        </span>
      </td>
    </tr>
              <tr>
                <td class="text-right"><b>CI status</b></td>
                <td class="ci-status">
                  
                  
                    <span class="label label-default" title="No CI information available for this package.">No Continuous Integration</span>
                  
                </td>
              </tr>
    <tr>
      <td class="text-right"><b>Released</b></td>
      <td>
        
          <span class="label label-default">UNRELEASED
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Tags</b></td>
      <td>
        
        
          <em>No category tags.</em>
        
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Contributing</b></td>
      <td>
        <a class="label label-primary" href="/r/astrobee/#noetic-contribute-lists-help-wanted">
          Help Wanted (<span class="contribute-lists-help-wanted-count">0</span>)
        </a>
        <br>
        <a class="label label-primary" href="/r/astrobee/#noetic-contribute-lists-good-first-issue">
          Good First Issues (<span class="contribute-lists-good-first-issue-count">0</span>)
        </a>
        <br>
        <a class="label label-primary" href="/r/astrobee/#noetic-contribute-lists-pull-requests">
          Pull Requests to Review (<span class="contribute-lists-pull-requests-count">0</span>)
        </a>
      </td>
    </tr>
  </table>

          </div>
        </div>
      </div>
      <div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">Package Description</h3></div>
          <div class="panel-body">
            
    This package localizes the Astrobee on a map.
  
          </div>
          <div class="panel-heading"><h4 class="panel-title">Additional Links</h4></div>
          <div class="panel-body">
            
            
              <em>No additional links.</em>
            
          </div>
          <div class="panel-heading"><h4 class="panel-title">Maintainers</h4></div>
          <div class="panel-body">
            
            
              <ul class="list-unstyled">
                
                  <li>
    Astrobee Flight Software
  </li>
                
              </ul>
            
          </div>
          <div class="panel-heading"><h4 class="panel-title">Authors</h4></div>
          <div class="panel-body">
            
            
              <ul class="list-unstyled">
                
                  <li>
    Astrobee Flight Software
  </li>
                
              </ul>
            
          </div>
        </div>
      </div>
    </div>
    
      
        <div class="row">
          <div class="col-xs-12">
            <div class="panel panel-default">
              <div class="panel-heading"><span class="glyphicon glyphicon-file"></span><a href="https://github.com/nasa/astrobee/tree/master/localization/sparse_mapping/readme.md" title="Open in git repository">localization/sparse_mapping/readme.md</a></div>
              <div class="panel-body">
                    <div class="rendered-markdown">
<p>\page sparsemapping Sparse mapping</p>

<h1 id="creation-of-sparse-maps-for-robot-localization">Creation of sparse maps for robot localization</h1>

<h2 id="what-is-a-map">What is a map</h2>

<p>A map consists of feature descriptors and associated 3D positions of
the features.  A map may also contain a vocabulary database which
enables fast lookup of similar images.</p>

<h2 id="map-files">Map files</h2>

<p>Maps are stored as protobuf files.</p>

<h2 id="ros-node">ROS node</h2>

<p>The ROS node takes images and a map as input, and outputs visual
features detected in the image and their 3D coordinates.</p>

<h3 id="inputs">Inputs</h3>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">/hw/cam_nav</code>: Camera images The map file. See the \ref
map_building section (towards the bottom) for its assumed location
on the robot.</li>
</ul>

<h3 id="outputs">Outputs</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/localization/mapped_landmarks/features</code></li>
  <li><code class="language-plaintext highlighter-rouge">/localization/mapped_landmarks/registration</code></li>
</ul>

<h2 id="the-environment">The environment</h2>

<p>It will be convenient in this document to set these environmental
variables, pointing to the source and build directories. They may need
to be adjusted given your setup.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export ASTROBEE_SOURCE_PATH=$HOME/astrobee/src
export ASTROBEE_BUILD_PATH=$HOME/astrobee
</code></pre></div></div>

<p>To access many of the localization tools, such as <code class="language-plaintext highlighter-rouge">build_map</code>,
<code class="language-plaintext highlighter-rouge">merge_maps</code>, etc., without specifying a full path, also consider
setting:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export PATH=$ASTROBEE_BUILD_PATH/devel/lib/sparse_mapping:$PATH
</code></pre></div></div>

<h2 id="tools-and-procedures">Tools and procedures</h2>

<h3 id="record-a-bag">Record a bag</h3>

<p>Record on the robot in order to not drop too many frames. Launch the
camera node. Connect to the robot. Create a subdirectory in /data
where the data will be recorded, as the home directory on the robot is
too small.  Move the robot slowly to make sure neighboring images have
enough overlap, and to reduce motion blur. Run:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rosbag record /hw/cam_nav
</code></pre></div></div>

<p>The name of the topic containing the images may differ from /hw/cam_nav.
To see what topics a bag file contains one can use the command</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rosbag info bagfile.bag
</code></pre></div></div>

<h3 id="filter-the-bag">Filter the bag</h3>

<p>Usually the bags are acquired at a very high frame rate, and they are
huge. A preliminary filtering of the bag images while still on the
robot can be done with the command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rosbag filter input.bag output.bag                           \
  "(topic == '/hw/cam_nav') and (float(t.nsecs)/1e+9 &lt;= 0.1)"
</code></pre></div></div>

<p>Here, for every second of recorded data, we keep only the first tenth
of a second. This number may need to be adjusted. Later, a further
selection of the images can be done.</p>

<h3 id="copy-the-bag-from-the-robot">Copy the bag from the robot</h3>

<p>From the local machine, fetch the bag:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rsync -avzP astrobee@10.42.0.32:/data/bagfile.bag .
</code></pre></div></div>

<p>Here, the IP address of P4D was used, which may differ from your
robot’s IP address.</p>

<h3 id="merging-bags">Merging bags</h3>

<p>The bags created on the ISS are likely split into many smaller bags,
for easy and reliability of transfer. Those can be merged into one bag
as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ASTROBEE_BUILD_PATH/devel/lib/localization_node/merge_bags \
  -output_bag &lt;output bag&gt; &lt;input bags&gt;
</code></pre></div></div>

<p>This tool can also save images only in a given time range, and 
filter out some images, for example, by keeping only one image per second.</p>

<p>See \ref merge_bags for the full documentation.</p>

<h3 id="extracting-images">Extracting images</h3>

<p>To extract images from a bag file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ASTROBEE_BUILD_PATH/devel/lib/localization_node/extract_image_bag \
  &lt;bagfile.bag&gt; -use_timestamp_as_image_name                       \
  -image_topic /hw/cam_nav -output_directory &lt;output dir&gt;
</code></pre></div></div>

<p>The above assumes that the software was built with ROS on.</p>

<p>Please check using ‘rosbag info’ the nav cam topic in the bag, as its
name can change.</p>

<h3 id="building-a-map">Building a map</h3>

<p>The <code class="language-plaintext highlighter-rouge">build_map</code> tools is used to construct a map. See \ref
map_building for further details.</p>

<p>See \ref theia_map for how to build a map with the external
Theia package and import it into Astrobee.</p>

<h3 id="visualization">Visualization</h3>

<p>To visualize a map, or just a list of images, use the command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nvm_visualize [ &lt;output.map&gt; ] [ &lt;image1.jpg&gt; &lt;image2.jpg&gt; ... ]
</code></pre></div></div>

<p>In the viewer, press <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">d</code> (or the left and right arrow keys, or
the Ins and Del keys on the num pad) to navigate through the
images. The current image being displayed will be echoed on the
command line. Press <code class="language-plaintext highlighter-rouge">c</code> to show the cameras and triangulated points in
3D. Press <code class="language-plaintext highlighter-rouge">q</code> to exit the viewer. Press ‘Home’ and ‘End’ to go 
to first and last image.</p>

<p>In <code class="language-plaintext highlighter-rouge">c</code> mode, press left and right to visualize the localization
results for the input image <code class="language-plaintext highlighter-rouge">imageN.jpg</code>. If no images are
passed in, the arrow keys display each frame of the map.</p>

<p>Also, in the <code class="language-plaintext highlighter-rouge">c</code> mode, when points and cameras are shown in 3D,
pressing <code class="language-plaintext highlighter-rouge">a</code> will save the current 3D pose to disk, while pressing <code class="language-plaintext highlighter-rouge">b</code>
will read a 3D pose from disk and apply it. This way, when two viewers
are open side by side, they can be made to show the results from the
same perspective.</p>

<p>The viewer can display just a subset of the cameras, using the <code class="language-plaintext highlighter-rouge">-first</code>
and <code class="language-plaintext highlighter-rouge">-last</code> options, and the size of cameras can be set with <code class="language-plaintext highlighter-rouge">-scale</code>.</p>

<p>Only the camera positions can be displayed, without the 3D points, if
the viewer is invoked with <code class="language-plaintext highlighter-rouge">-skip_3d_points</code>. The cameras can be made
to rotate around the center of mass of the cameras, rather than the
origin, using the <code class="language-plaintext highlighter-rouge">d</code> key. When in 3D view, rendering of thumbnails of
the images can be skipped, as that makes the viewer slow, with
‘-skip_3d_images’.</p>

<p>Clicking on an interest point with the middle mouse will display all
images in which that interest point was detected, with the interest
point in each of them shown as a red dot. Clicking back on the
original window with the middle mouse will make these images go away.</p>

<p>Clicking with the left mouse button on an image will print its name
and the pixel coordinates where the mouse hit. This can be useful in
collecting a subset of the images. (After clicking, a bug in OpenCV
disables the arrow keys, then one can navigate with the “Ins” and
“Del” keys on the numpad.)</p>

<p>This tool can be invoked to look at just images, without any map being
built. It can also delete images in this mode, with the ‘x’ key, if
invoked as:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nvm_visualize -enable_image_deletion &lt;image dir&gt;/*jpg
</code></pre></div></div>

<h3 id="localize-a-single-frame">Localize a single frame</h3>

<p>All the commands below assume that the environment was set up, 
as specified in the \ref map_building section.</p>

<p>To test localization of a single frame, use the command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>localize &lt;map.map&gt; &lt;image.jpg&gt; -histogram_equalization
</code></pre></div></div>

<p>If invoked with the option -verbose_localization, it will list the
images most similar to the one being localized. To increase the 
number of similar images, use the -num_similar option. Another
useful flag is –v 2 when it will print more verbose information.
Most of the options of the localize_cams tool (see below)
are also accepted.</p>

<h3 id="testing-localization-using-two-maps">Testing localization using two maps</h3>

<p>To test localization of many images, one can acquire two sets of
images of the same indoor environment, and create two maps ready for
localization. That is, maps are built, registered to the world
coordinate system, rebuilt with BRISK, and then a vocabulary database
is created. Name those maps reference and source.</p>

<p>For each image in the source map, one can localize it against the
reference map, and compare its camera position and orientation after
localization with the “known” position and orientation from the source
map.</p>

<p>This is not a fool-proof test, since neither of the two maps contains
measured ground truth, rather a simulated version of it, yet it can be
useful, assuming that maps are individually accurate enough and
well-registered.</p>

<p>This functionality is implemented in the localize_cams tool. Usage:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>localize_cams -num_similar 20 -ransac_inlier_tolerance 5      \
  -num_ransac_iterations 200 -min_brisk_features 400          \
  -max_brisk_features 800 -min_brisk_threshold 20             \
  -default_brisk_threshold 90 -max_brisk_threshold 110        \
  -detection_retries 5 -num_threads 2                         \
  -early_break_landmarks 100 -histogram_equalization          \
  -reference_map ref.map -source_map source.map
</code></pre></div></div>

<p>Here we use values that are different from</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ASTROBEE_SOURCE_PATH/astrobee/config/localization.config 
</code></pre></div></div>

<p>which are used for localization on the robot, since those are optimized
for speed and here we want more accuracy.</p>

<h3 id="testing-localization-using-a-bag">Testing localization using a bag</h3>

<p>See the \ref ekfbag page for how to study how well a BRISK map
with a vocabulary database does when localizing images from a bag.</p>

<h3 id="extract-sub-maps">Extract sub-maps</h3>

<p>The tool <code class="language-plaintext highlighter-rouge">extract_submap</code> can be used to extract a submap from a map,
containing only a specified list of images, or a given range of
image indices, or images with camera center in a given box. Usage:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>extract_submap -input_map &lt;input map&gt; -output_map &lt;output map&gt; \
  &lt;images to keep&gt;
</code></pre></div></div>

<p>or
    extract_submap -input_map <input map=""> -output_map <output map=""> \
      -image_list <file>
or
    extract_submap -input_map <input map=""> -output_map <output map=""> \
      -exclude <images to="" exclude=""></images></output></file></output></p>

<p>or</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>extract_submap -input_map &lt;input map&gt; -output_map &lt;output map&gt; \
  -cid_range "min_cid max_cid"
</code></pre></div></div>

<p>(here first image has cid = 0, and the range is inclusive at both
ends), or</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>extract_submap -input_map &lt;input map&gt; -output_map &lt;output map&gt; \
  -xyz_box "xmin xmax ymin ymax zmin zmax"
</code></pre></div></div>

<p>If it is desired to not re-adjust the cameras after the submap is
extracted (for example, if the map is already registered), use the
<code class="language-plaintext highlighter-rouge">-skip_bundle_adjustment</code> option.</p>

<p>If the input map has a vocabulary database of features, it will
need to be rebuilt for the extracted submap using</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>build_map -vocab_db
</code></pre></div></div>

<h3 id="merge-maps">Merge maps</h3>

<h4 id="general-usage">General usage</h4>

<p>Given a set of SURF maps, they can be merged using the command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>merge_maps &lt;input maps&gt; -output_map merged.map \
  -num_image_overlaps_at_endpoints 50
</code></pre></div></div>

<p>It is very important to note that only maps with SURF features (see
\ref map_building) can be merged. If a map has BRISK features, it
needs to be rebuilt with SURF features, as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  build_map -rebuild -histogram_equalization       \
    -rebuild_detector SURF -output_map &lt;output map&gt;
</code></pre></div></div>

<p>and then these regenerated maps can be merged.</p>

<p>Merging is more likely to succeed if the images at the endpoints of
one map are similar to images at the endpoints of the second map, and
in particular, if some of the same images show up at the endpoints of
both maps. A larger value of <code class="language-plaintext highlighter-rouge">-num_image_overlaps_at_endpoints</code> may
result in higher success but will take more time.</p>

<h4 id="registration-and-bundle-adjustment">Registration and bundle adjustment</h4>

<p>The input maps to be merged need not be registered, but that may help
improve the success of merging. Also, it may be preferable that
the images at the beginning and end of the maps to merge be close
to points used in registration. The implication here is that the
more geometrically correct the input maps are, and the more similar
to each other, the more likely merging will succeed.</p>

<p>Registration to the real-world coordinate system must be (re-)done
after the maps are merged, as the bundle adjustment done during merging
may move things somewhat.</p>

<p>After a merged map is created and registered, it can be rebuilt with
the BRISK detector to be used on the robot.</p>

<p>When manipulating many submaps, it is suggested that bundle adjustment
be skipped during merging, using the</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-skip_bundle_adjustment
</code></pre></div></div>

<p>option until the final map is computed, as this step can be
time-consuming. Bundle adjustment must happen however eventually,
before any map registration and rebuilding.</p>

<h4 id="keeping-first-map-fixed">Keeping first map fixed</h4>

<p>If there are only two maps to merge, and the first of the two maps to
merge is already registered, it may be desirable to keep that portion
fixed during merging when bundle adjustment happens, to avoid redoing
the registration, and perhaps to keep consistency with other work
already done, such as a dense map product.</p>

<p>Then, use the flag <code class="language-plaintext highlighter-rouge">-fix_first_map</code> when merging the maps. In this case,
if an image shows in both maps, then, once the maps are merged, the
camera poses of the shared images will be replaced with the ones from
the first map, before reoptimizing the remaining camera poses from the
second map.</p>

<h3 id="how-to-build-a-map-efficiently">How to build a map efficiently</h3>

<p>Often times map-building can take a long time, or it can fail. A
cautious way of building a map is to build it in portions (perhaps on
different machines), examine them, and merge them with <code class="language-plaintext highlighter-rouge">merge_maps</code>.</p>

<p>If map-building failed, parts of it could still be salvageable (one
can use nvm_visualize for inspection). Valid submaps can be extracted
with <code class="language-plaintext highlighter-rouge">extract_submap</code>. Then those can be merged with <code class="language-plaintext highlighter-rouge">merge_maps</code>.</p>

<p>When two maps to be merged overlap only in the middle, and they are
both large, the number -num_image_overlaps_at_endpoints will need to
be large which would make merging very slow. A very useful option can
then be the flag <code class="language-plaintext highlighter-rouge">-fast_merge</code> for this tool. It won’t create matches
among the two maps, but will instead identify the shared images among
the two maps thus merging the maps, if shared images exist.</p>

<p>If no such images are available, but the two maps do see the same
physical location in some portions (if from different views), each of
the two maps can be first merged with the same small map of that
shared location, and then the newly merged map which now will have
shared images can be merged with the <code class="language-plaintext highlighter-rouge">-fast_merge</code> flags.</p>

<p>The <code class="language-plaintext highlighter-rouge">-fast_merge</code> option assumes that a decent number of images
are shared among the maps, and that those cover a reasonably large
and representative portion of the desired environment, otherwise
it may not give accurate results. In either case, bundle adjustment
must be applied after the merge operations are done and before
registration, which can be done either with <code class="language-plaintext highlighter-rouge">merge_maps</code> or
<code class="language-plaintext highlighter-rouge">build_map</code>.</p>

<p>To summarize, with careful map surgery (extract submaps and merge
submaps) large maps can be made from smaller or damaged ones within
reasonable time.</p>

<p>All these operations should be applied on maps with SURF features.
Hence, the general approach for building large maps is to create small SURF
maps using the command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>build_map -feature_detection -feature_matching -track_building    \
 -incremental_ba -bundle_adjustment                               \
 -histogram_equalization -num_subsequent_images 100               \
 images/*jpg -output_map &lt;map file&gt;
</code></pre></div></div>

<p>Then, examine the maps individually, merge them as appropriate, and
perform bundle adjustment and registration as per the \ref
map_building section. Only when a good enough map is obtained, a
renamed copy of it should be rebuilt with BRISK features and a
vocabulary database to be used on the robot.</p>

<h3 id="map-strategy-for-the-space-station">Map strategy for the space station</h3>

<p>For the space station, there exists one large SURF map with many
images, and a small BRISK map with fewer images. If new images are
acquired, it is suggested several small maps be assembled from them,
and those be merged to the large SURF map.</p>

<p>The key idea here is to add some well-chosen subsequences of those new
images to the SURF map, but only a few, for which localization failed,
to the BRISK map. This is best illustrated by an example.</p>

<p>Say the large original SURF map had 2000 images, and the smaller BRISK
map had only 1400 images. Say 300 new images have been acquired, and
for 80 of them localization failed. So, things will change as follows:</p>

<ul>
  <li>SURF map goes from  2000 to 2000 + 300 = 2300 images</li>
  <li>BRISK map goes from 1400 to 1400 +  80 = 1480 images</li>
</ul>

<p>The precise details are described in the next section.</p>

<h3 id="growing-a-map-when-more-images-are-acquired">Growing a map when more images are acquired</h3>

<p>Sometimes things in the desired environment change enough, or the
lighting changes, and an existing map may no longer do as well in some
areas. Then, new images should be added to the map. The tool
grow_map.py can help with that.</p>

<p>First, out of the new images a set must be selected from which to
build a new map. We assume that the images in that set are further
broken up into several subsets, with each image in a subset
overlapping with the next one in that subset. For example, there can
exist a subset for the ceiling, one for the walls, etc.</p>

<p>A SURF map can be built for each subset, and those can be merged. (A
very useful option here can be -fast_merge.) Then, the new merged SURF
map can be merged with the earlier SURF map, and the combined map can
be bundle-adjusted and registered. While such a SURF map will be very
reliable, it will contain redundant information, so we will outline
below how to create a BRISK map that starts the same as the BRISK map
that existed before that, with only a minimum of images added for
which localization now fails. The new large SURF map will be used as
the source of the camera poses for the updated BRISK map, but the
latter will have fewer images.</p>

<p>We need some notation. Let prev_brisk_vocab_hist.map be the previous
BRISK map, before new images are added, prev_surf_registered.map be
the previous registered SURF map (that can have more images than
prev_brisk_vocab_hist.map). Let curr_surf_registered.map be the large
SURF map that is obtained from prev_surf_registered.map merged with
the images acquired this time, and curr_brisk_no_prune_hist.map be
obtained from curr_surf_registered.map using the -rebuild and
-histogram_equalization options. The prev_brisk_vocab_hist.map will
already be pruned and have a vocabulary database, but
curr_brisk_no_prune_hist.map is assumed to have none of these. Not
being pruned is very important. And again, all these maps must be
registered.</p>

<p>Let also list1.txt, …, listN.txt contain the images for those
subsets of new images mentioned earlier, such as list_wall.txt,
list_floor.txt, etc., with the order of images in this list be the
same as in the submap for the subset made from that list (which is the
same order as output by build_map -info). We will create a new BRISK
map, named curr_brisk_vocab_hist.map, that will be pruned and with a
vocabulary database (so ready to be used, just like
prev_brisk_vocab_hist.map) that will have only some of the new images
as follows:</p>

<ul>
  <li>Start with prev_brisk_vocab_hist.map</li>
  <li>Add all new images in list1.txt for which localization failed
against prev_brisk_vocab_hist.map, thus getting a map named curr1.map.</li>
  <li>Add all new images in list2.txt for which localization against
curr1.map failed.</li>
  <li>Etc.</li>
</ul>

<p>The logic here is very simple. Don’t add all new images at once. Add
them in batches, and for each batch remember the fact that the
previous batch already made the map better, so don’t add images from a
batch if they are not strictly necessary.</p>

<p>The following Python code implements this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python astrobee/src/localization/sparse_mapping/tools/grow_map.py \
  -histogram_equalization -small_map prev_brisk_vocab_hist.map    \
  -big_map curr_brisk_no_prune_hist.map -work_dir work            \
  -output_map curr_brisk_vocab_hist.map                           \
  list1.txt list2.txt ... listN.txt
</code></pre></div></div>

<p>After this is finished, the work directory can be wiped.</p>

<p>It is very important to never remove like this images from the SURF
map. This can result in this map breaking into disconnected sets when
being bundle adjusted. If desired to make the SURF map smaller, one
should examine the submaps it is made of (typically each submap has
its images in a subdirectory), and then one should carefully study
which submap (or portions of it) are not necessary for the whole map’s
cohesiveness.</p>

<p>Also note that the grow_map.py script takes a lot of other parameters
on input that must be the same as in localization.config.</p>

<h3 id="reducing-the-number-of-images-in-a-map">Reducing the number of images in a map</h3>

<p>Sometimes a map has too many similar images. The tool reduce_map.py
attempts to reduce their number without sacrificing the map quality.</p>

<p>To use this feature, it is very important that the input map is not
pruned. This map should be made of of BRISK features and registered. It
need not have a vocab db.</p>

<p>Usage:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python astrobee/src/localization/sparse_mapping/tools/reduce_map.py \
  -input_map &lt;input map&gt; -min_brisk_threshold &lt;val&gt;                 \
  -default_brisk_threshold &lt;val&gt; -max_brisk_threshold &lt;val&gt;         \
  -localization_error &lt;val&gt; -work_dir &lt;work dir&gt;                    \
  -sample_rate &lt;val&gt; -histogram_equalization
</code></pre></div></div>

<p>The BRISK thresholds here must be as when the map was built (ideally
like in localization.config). The -histogram_equalization flag is
necessary if your map was built with it.</p>

<p>A sequence of ever-smaller output maps are saved in the work
directory. They are pruned maps, with a vocabulary database, unlike
the input unpruned map.</p>

<p>The algorithm is as follows. Randomly remove a fraction (stored in
-sample_rate, typically 1/4th) of images form a map. Localize the
images from the full map against the images of the reduced map. Images
for which localization fails with more than a given error (typically 2
cm) are added back to the reduced map. This is repeated until no more
images need adding.</p>

<p>The reduced map is written to</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;work_dir&gt;/submap_iter0.map
</code></pre></div></div>

<p>Then more images are taken out of the map and all the previous process
is repeated (this is called the outer iteration), each time obtaining
a smaller map named</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;work_dir&gt;/submap_iter&lt;outer iter&gt;.map
</code></pre></div></div>

<p>One should carefully evaluate these output maps. Likely after a couple
of attempts the quality of the map may start degrading. To use
more attempts, set the value of the -attempts variable.</p>

<p>Instead of taking images out of the map randomly, one can start with a
reduced map with a small list of desired images which can be set with
-image_list, and then all images for which localization fails will be
added back to it.</p>

<p>\subpage build_map_from_multiple_bags
\subpage map_building
\subpage total_station
\subpage granite_lab_registration
\subpage faro
\subpage theia_map
\subpage import_map
\subpage export_map
\subpage merge_bags</p>
</div>
              </div>
            </div>
          </div>
        </div>
      
    
    <div class="row">
      <div class="col-xs-12">
        <div class="panel panel-default">
          <div class="panel-heading"><span class="glyphicon glyphicon-list"></span> CHANGELOG</div>
          <div class="panel-body">
            
              <em>No CHANGELOG found.</em>
            
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-pane" id="noetic-tutorials">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Wiki Tutorials</h3>
      </div>
      <div class="panel-body">
        
        <em>This package does not provide any links to tutorials in it's <a href="https://index.ros.org/contribute/metadata/">rosindex metadata</a>.</em>
        <em>You can check on the <a href="http://wiki.ros.org/sparse_mapping/Tutorials" target="_blank">ROS Wiki Tutorials</a> page for the package.</em>
        
      </div>
    </div>
  </div>

  <div class="tab-pane" id="noetic-deps">
    <div class="row">
      <div class="col-sm-6">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Package Dependencies</h3>
          </div>
          <div class="panel-body">
            
              <table class="table table-condensed table-striped">
                <thead>
                  <th class="text-center">Deps</th>
                  <th style="width: 100%">Name</th>
                </thead>
                <tbody>
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/ff_msgs#noetic-deps" >
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/ff_msgs#noetic">ff_msgs  </a></td>
                      </tr>
                    
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/ff_common#noetic-deps" >
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/ff_common#noetic">ff_common  </a></td>
                      </tr>
                    
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/camera#noetic-deps" >
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/camera#noetic">camera  </a></td>
                      </tr>
                    
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/roscpp#noetic-deps" >
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/roscpp#noetic">roscpp  </a></td>
                      </tr>
                    
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/interest_point#noetic-deps" >
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/interest_point#noetic">interest_point  </a></td>
                      </tr>
                    
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/config_reader#noetic-deps" >
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/config_reader#noetic">config_reader  </a></td>
                      </tr>
                    
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/localization_common#noetic-deps" >
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/localization_common#noetic">localization_common  </a></td>
                      </tr>
                    
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/vision_common#noetic-deps" >
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/vision_common#noetic">vision_common  </a></td>
                      </tr>
                    
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/catkin#noetic-deps" class="endoftree">
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/catkin#noetic">catkin  </a></td>
                      </tr>
                    
                  
                </tbody>
              </table>
            
          </div>
          <div class="panel-heading">
            <h3 class="panel-title">System Dependencies</h3>
          </div>
          <div class="panel-body">
            
              <em>No direct system dependencies.</em>
            
          </div>
        </div>
      </div>

      <div class="col-sm-6">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Dependant Packages</h3>
          </div>
          <div class="panel-body">
            
              <table class="table table-condensed table-striped">
                <thead>
                  <th>Name</th>
                  <th class="text-center">Deps</th>
                </thead>
                <tbody>
                  
                    
                    
                    <tr>
                      <td><a href="/p/localization_node#noetic">localization_node</a></td>
                      <td class="text-center">
                        
                        <a href="/p/localization_node#noetic-deps" >
                          <span class="glyphicon glyphicon-arrow-right"></span>
                        </a>
                      </td>
                    </tr>
                    
                  
                </tbody>
              </table>
            
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-pane" id="noetic-assets">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Launch files</h3>
      </div>
      <div class="panel-body">
        
          <em>No launch files found</em>
        
      </div>
    </div>

    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Messages</h3>
      </div>
      <div class="panel-body">
        
          <em>No message files found.</em>
        
      </div>
    </div>

    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Services</h3>
      </div>
      <div class="panel-body">
        
          <em>No service files found</em>
        
      </div>
    </div>

    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Plugins</h3>
      </div>
      <div class="panel-body">
        
          <em>No plugins found.</em>
        
      </div>
    </div>
  </div>

  <div class="tab-pane" id="noetic-questions">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Recent questions tagged <kbd>sparse_mapping</kbd> at <strong><a href="https://robotics.stackexchange.com/" target="_blank">Robotics Stack Exchange</a></strong></h3>      </div>
      <div id="noetic-question-list" class="panel-body" style="display: none;"></div>
      <div id="noetic-no-question-list" class="panel-body" style="display: none;">
        <p>No questions yet, you can ask one <a href="https://robotics.stackexchange.com/questions/tagged/sparse_mapping+noetic">here</a>.</p>
      </div>
      <div id="noetic-get-question-fail" class="panel-body alert alert-warning" style="display: none;">
        <p>Failed to get question list, you can ticket an issue <a href="https://github.com/ros-infrastructure/rosindex/issues/new" target="_blank" class="alert-link">here</a> </p>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript" src="/js/package_body_tabs.js"></script>

<script src=/js/contribution_suggestions.js></script>
<script type="text/javascript">
jQuery(function() {
    // Update the count on the links to the contribution suggestions
    updateContributionSuggestionsCountOnPackage('https://github.com/nasa/astrobee.git');
});
</script>

          </div>
          <div class="col-md-2 hidden-xs hidden-sm">
            
            
            



<div class="list-group list-group-sm ">
  <a class="list-group-item"
     target="_blank"
     href="http://docs.ros.org/en/noetic/api/sparse_mapping/html/"
     title="View API documentation on docs.ros.org"
     >
       <span style="margin-right: 5px;" class="glyphicon glyphicon-file"></span>
       
       API Docs
  </a>
  <a class="list-group-item"
     target="_blank"
     href="https://github.com/nasa/astrobee/tree/master/localization/sparse_mapping"
     title="View source code on repository">
       <span class="glyphicon glyphicon-folder-open" style="margin-right:5px;"></span>
       
       Browse Code
  </a>
  
  
  
  
  
  <a class="list-group-item "
     target="_blank"
     href="http://wiki.ros.org/sparse_mapping?distro=noetic"
     title="View this package on wiki.ros.org">
       <span style="margin-right: 5px;" class="glyphicon glyphicon-info-sign"></span>
       
       Wiki
  </a>
  
  
</div>

          </div>
        </div>
      
    </div>
  </div>

  <div class="distro distro-galactic">
    <div class="container-fluid">
      
          <div class="alert alert-warning">No version for distro <strong>galactic</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-iron">
    <div class="container-fluid">
      
          <div class="alert alert-warning">No version for distro <strong>iron</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-melodic">
    <div class="container-fluid">
      
        
        
        

        <div class="row">
          <div class="col-md-10">
            

<div class="well well-sm">
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px" src="/assets/package.png">
      </td>
      <td>
        <h3 style="margin-top: 5px">
          <a style="text-decoration:none" href="/p/sparse_mapping">sparse_mapping</a> <small>package from <a style="text-decoration:none" href="/r/astrobee/github-nasa-astrobee">astrobee</a> repo</small>
        </h3>
          
            
            
              <a class="label label-primary pkg-label" href="/p/astrobee">

astrobee
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/arm">

arm
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/dock">

dock
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/light_flow">

light_flow
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/perch">

perch
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/states">

states
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/comms_bridge">

comms_bridge
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/dds_msgs">

dds_msgs
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/dds_ros_bridge">

dds_ros_bridge
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ff_hw_msgs">

ff_hw_msgs
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ff_msgs">

ff_msgs
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ground_dds_ros_bridge">

ground_dds_ros_bridge
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/description">

description
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ctl">

ctl
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/fam">

fam
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/pmc">

pmc
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/eps_driver">

eps_driver
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/epson_imu">

epson_imu
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/fam_cmd_i2c">

fam_cmd_i2c
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ff_serial">

ff_serial
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/flashlight">

flashlight
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/gpio">

gpio
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/i2c">

i2c
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/is_camera">

is_camera
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/laser">

laser
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/perching_arm">

perching_arm
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/pico_driver">

pico_driver
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/pmc_actuator">

pmc_actuator
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/signal_lights">

signal_lights
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/smart_dock">

smart_dock
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/speed_cam">

speed_cam
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/temp_monitor">

temp_monitor
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/vive">

vive
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/camera">

camera
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/depth_odometry">

depth_odometry
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/factor_adders">

factor_adders
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/graph_factors">

graph_factors
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/graph_localizer">

graph_localizer
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/graph_optimizer">

graph_optimizer
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/graph_vio">

graph_vio
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ground_truth_localizer">

ground_truth_localizer
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/handrail_detect">

handrail_detect
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/imu_integration">

imu_integration
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/interest_point">

interest_point
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/lk_optical_flow">

lk_optical_flow
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/localization_common">

localization_common
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/localization_manager">

localization_manager
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/localization_measurements">

localization_measurements
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/localization_node">

localization_node
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/marker_tracking">

marker_tracking
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/node_adders">

node_adders
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/nodes">

nodes
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/optimization_common">

optimization_common
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/optimizers">

optimizers
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/parameter_reader">

parameter_reader
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/point_cloud_common">

point_cloud_common
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ros_graph_localizer">

ros_graph_localizer
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ros_graph_vio">

ros_graph_vio
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ros_pose_extrapolator">

ros_pose_extrapolator
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/sliding_window_graph_optimizer">

sliding_window_graph_optimizer
</a>
            
          
            
            
              <span class="label label-default pkg-label">

sparse_mapping
</span>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/tutorial_examples">

tutorial_examples
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/vision_common">

vision_common
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/vive_localization">

vive_localization
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/access_control">

access_control
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/cpu_mem_monitor">

cpu_mem_monitor
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/data_bagger">

data_bagger
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/disk_monitor">

disk_monitor
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/executive">

executive
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/image_sampler">

image_sampler
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/log_monitor">

log_monitor
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/sys_monitor">

sys_monitor
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/choreographer">

choreographer
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/framestore">

framestore
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/mapper">

mapper
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/mobility">

mobility
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/planner_qp">

planner_qp
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/traj_opt_basic">

traj_opt_basic
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/traj_opt_msgs">

traj_opt_msgs
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/traj_opt_pro">

traj_opt_pro
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/traj_opt_ros">

traj_opt_ros
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/planner_trapezoidal">

planner_trapezoidal
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/config_reader">

config_reader
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ff_common">

ff_common
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/ff_util">

ff_util
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/jsonloader">

jsonloader
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/msg_conversions">

msg_conversions
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/astrobee_gazebo">

astrobee_gazebo
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/bag_processing">

bag_processing
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/calibration">

calibration
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/gds_helper">

gds_helper
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/gnc_visualizer">

gnc_visualizer
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/interactive_marker_teleop">

interactive_marker_teleop
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/localization_analysis">

localization_analysis
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/localization_rviz_plugins">

localization_rviz_plugins
</a>
            
          
            
            
              <a class="label label-primary pkg-label" href="/p/performance_tester">

performance_tester
</a>
            
          
      </td>
    </tr>
  </table>
</div>

            <div class="visible-xs visible-sm">
              
              
              



<div class="list-group list-group-sm list-group-horizontal list-group-justified">
  <a class="list-group-item text-center"
     target="_blank"
     href="http://docs.ros.org/en/melodic/api/sparse_mapping/html/"
     title="View API documentation on docs.ros.org"
     >
       <span style="margin-right: 5px;" class="glyphicon glyphicon-file"></span>
       <br>
       API Docs
  </a>
  <a class="list-group-item text-center"
     target="_blank"
     href="https://github.com/nasa/astrobee/tree/master/localization/sparse_mapping"
     title="View source code on repository">
       <span class="glyphicon glyphicon-folder-open" style="margin-right:5px;"></span>
       <br>
       Browse Code
  </a>
  
  
  
  
  
  <a class="list-group-item text-center "
     target="_blank"
     href="http://wiki.ros.org/sparse_mapping?distro=melodic"
     title="View this package on wiki.ros.org">
       <span style="margin-right: 5px;" class="glyphicon glyphicon-info-sign"></span>
       <br>
       Wiki
  </a>
  
  
</div>

            </div>
            



<ul class="nav nav-tabs nav-justified" id="melodic-tabs" style="margin-bottom:20px">
  <li class="better-tabs active">
    <a href="#melodic-overview" data-toggle="tab">Overview</a>
  </li>
  <li class="better-tabs">
    
    
    
    
    
    <a href="#melodic-assets" data-toggle="tab"><span class="label label-default">0</span> Assets</a>
  </li>
  <li class="better-tabs">
    
    
    
    
    <a href="#melodic-deps" data-toggle="tab"><span class="label label-primary">9</span> Dependencies</a>
  </li>
  <li class="better-tabs">
    
    <a href="#melodic-tutorials" data-toggle="tab"><span class="label label-default">0</span> Tutorials</a>
  </li>
  <li class="better-tabs">
    <a href="#melodic-questions" data-toggle="tab"><span id="melodic-questions-count" class="label label-primary">0</span> Q & A</a>
  </li>
</ul>

<div class="tab-content">
  <div class="tab-pane active" id="melodic-overview">
    
    <div class="row">
      <div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
        <div class="panel panel-default">
          <div class="panel-heading"><h4 class="panel-title">Package Summary</h4></div>
          <div class="panel-body">
            <table class="table table-condensed">
              <tr>
                <td style="width:100px;" class="text-right"><strong>Tags</strong></td>
                <td>
                  
                  
                    <em>No category tags.</em>
                  
                </td>
              </tr>
              <tr>
                <td class="text-right"><strong>Version</strong></td>
                <td>1.0.0</td>
              </tr>
              <tr>
                <td class="text-right"><strong>License</strong></td>
                <td>
    Apache License, Version 2.0
  </td>
              </tr>
              <tr>
                <td class="text-right"><strong>Build type</strong></td>
                <td>
                  
                    <span class="label label-info">
                  
                    CATKIN</span>
                </td>
              </tr>
              <tr>
                <td class="text-right"><strong>Use</strong></td>
                <td>
                
                  <span class="label label-success">RECOMMENDED</span>
                
                </td>
              </tr>
            </table>
          </div>
          <div class="panel-heading"><h3 class="panel-title">Repository Summary</h3></div>
          <div class="panel-body">
            
            
            
  <link rel="stylesheet" href="/css/ci-status.css">
  <table class="table table-condensed">
    <tr>
      <td class="text-right"><b>Description</b></td>
      <td><span class="label label-default">NASA Astrobee Robot Software</span></td>
    </tr>
    <tr>
      <td style="width:100px;" class="text-right"><b>Checkout URI</b></td>
      <td><a class="label label-default" href="https://github.com/nasa/astrobee.git">https://github.com/nasa/astrobee.git</a></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Type</b></td>
      <td><span class="label label-default">git</span></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Version</b></td>
      <td><span class="label label-default">master</span></td>
    </tr>
    <tr>
      <td style="white-space: nowrap;" class="text-right"><b>Last Updated</b></div>
      <td>
        
          <span class="label label-default"><span class="glyphicon glyphicon-time"></span> 2024-07-03
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Dev Status</b></td>
      <td>
        
          <span class="label label-warning">UNKNOWN
        </span>
      </td>
    </tr>
              <tr>
                <td class="text-right"><b>CI status</b></td>
                <td class="ci-status">
                  
                  
                    <span class="label label-default" title="No CI information available for this package.">No Continuous Integration</span>
                  
                </td>
              </tr>
    <tr>
      <td class="text-right"><b>Released</b></td>
      <td>
        
          <span class="label label-default">UNRELEASED
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Tags</b></td>
      <td>
        
        
          <em>No category tags.</em>
        
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Contributing</b></td>
      <td>
        <a class="label label-primary" href="/r/astrobee/#melodic-contribute-lists-help-wanted">
          Help Wanted (<span class="contribute-lists-help-wanted-count">0</span>)
        </a>
        <br>
        <a class="label label-primary" href="/r/astrobee/#melodic-contribute-lists-good-first-issue">
          Good First Issues (<span class="contribute-lists-good-first-issue-count">0</span>)
        </a>
        <br>
        <a class="label label-primary" href="/r/astrobee/#melodic-contribute-lists-pull-requests">
          Pull Requests to Review (<span class="contribute-lists-pull-requests-count">0</span>)
        </a>
      </td>
    </tr>
  </table>

          </div>
        </div>
      </div>
      <div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">Package Description</h3></div>
          <div class="panel-body">
            
    This package localizes the Astrobee on a map.
  
          </div>
          <div class="panel-heading"><h4 class="panel-title">Additional Links</h4></div>
          <div class="panel-body">
            
            
              <em>No additional links.</em>
            
          </div>
          <div class="panel-heading"><h4 class="panel-title">Maintainers</h4></div>
          <div class="panel-body">
            
            
              <ul class="list-unstyled">
                
                  <li>
    Astrobee Flight Software
  </li>
                
              </ul>
            
          </div>
          <div class="panel-heading"><h4 class="panel-title">Authors</h4></div>
          <div class="panel-body">
            
            
              <ul class="list-unstyled">
                
                  <li>
    Astrobee Flight Software
  </li>
                
              </ul>
            
          </div>
        </div>
      </div>
    </div>
    
      
        <div class="row">
          <div class="col-xs-12">
            <div class="panel panel-default">
              <div class="panel-heading"><span class="glyphicon glyphicon-file"></span><a href="https://github.com/nasa/astrobee/tree/master/localization/sparse_mapping/readme.md" title="Open in git repository">localization/sparse_mapping/readme.md</a></div>
              <div class="panel-body">
                    <div class="rendered-markdown">
<p>\page sparsemapping Sparse mapping</p>

<h1 id="creation-of-sparse-maps-for-robot-localization">Creation of sparse maps for robot localization</h1>

<h2 id="what-is-a-map">What is a map</h2>

<p>A map consists of feature descriptors and associated 3D positions of
the features.  A map may also contain a vocabulary database which
enables fast lookup of similar images.</p>

<h2 id="map-files">Map files</h2>

<p>Maps are stored as protobuf files.</p>

<h2 id="ros-node">ROS node</h2>

<p>The ROS node takes images and a map as input, and outputs visual
features detected in the image and their 3D coordinates.</p>

<h3 id="inputs">Inputs</h3>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">/hw/cam_nav</code>: Camera images The map file. See the \ref
map_building section (towards the bottom) for its assumed location
on the robot.</li>
</ul>

<h3 id="outputs">Outputs</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/localization/mapped_landmarks/features</code></li>
  <li><code class="language-plaintext highlighter-rouge">/localization/mapped_landmarks/registration</code></li>
</ul>

<h2 id="the-environment">The environment</h2>

<p>It will be convenient in this document to set these environmental
variables, pointing to the source and build directories. They may need
to be adjusted given your setup.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export ASTROBEE_SOURCE_PATH=$HOME/astrobee/src
export ASTROBEE_BUILD_PATH=$HOME/astrobee
</code></pre></div></div>

<p>To access many of the localization tools, such as <code class="language-plaintext highlighter-rouge">build_map</code>,
<code class="language-plaintext highlighter-rouge">merge_maps</code>, etc., without specifying a full path, also consider
setting:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export PATH=$ASTROBEE_BUILD_PATH/devel/lib/sparse_mapping:$PATH
</code></pre></div></div>

<h2 id="tools-and-procedures">Tools and procedures</h2>

<h3 id="record-a-bag">Record a bag</h3>

<p>Record on the robot in order to not drop too many frames. Launch the
camera node. Connect to the robot. Create a subdirectory in /data
where the data will be recorded, as the home directory on the robot is
too small.  Move the robot slowly to make sure neighboring images have
enough overlap, and to reduce motion blur. Run:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rosbag record /hw/cam_nav
</code></pre></div></div>

<p>The name of the topic containing the images may differ from /hw/cam_nav.
To see what topics a bag file contains one can use the command</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rosbag info bagfile.bag
</code></pre></div></div>

<h3 id="filter-the-bag">Filter the bag</h3>

<p>Usually the bags are acquired at a very high frame rate, and they are
huge. A preliminary filtering of the bag images while still on the
robot can be done with the command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rosbag filter input.bag output.bag                           \
  "(topic == '/hw/cam_nav') and (float(t.nsecs)/1e+9 &lt;= 0.1)"
</code></pre></div></div>

<p>Here, for every second of recorded data, we keep only the first tenth
of a second. This number may need to be adjusted. Later, a further
selection of the images can be done.</p>

<h3 id="copy-the-bag-from-the-robot">Copy the bag from the robot</h3>

<p>From the local machine, fetch the bag:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rsync -avzP astrobee@10.42.0.32:/data/bagfile.bag .
</code></pre></div></div>

<p>Here, the IP address of P4D was used, which may differ from your
robot’s IP address.</p>

<h3 id="merging-bags">Merging bags</h3>

<p>The bags created on the ISS are likely split into many smaller bags,
for easy and reliability of transfer. Those can be merged into one bag
as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ASTROBEE_BUILD_PATH/devel/lib/localization_node/merge_bags \
  -output_bag &lt;output bag&gt; &lt;input bags&gt;
</code></pre></div></div>

<p>This tool can also save images only in a given time range, and 
filter out some images, for example, by keeping only one image per second.</p>

<p>See \ref merge_bags for the full documentation.</p>

<h3 id="extracting-images">Extracting images</h3>

<p>To extract images from a bag file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ASTROBEE_BUILD_PATH/devel/lib/localization_node/extract_image_bag \
  &lt;bagfile.bag&gt; -use_timestamp_as_image_name                       \
  -image_topic /hw/cam_nav -output_directory &lt;output dir&gt;
</code></pre></div></div>

<p>The above assumes that the software was built with ROS on.</p>

<p>Please check using ‘rosbag info’ the nav cam topic in the bag, as its
name can change.</p>

<h3 id="building-a-map">Building a map</h3>

<p>The <code class="language-plaintext highlighter-rouge">build_map</code> tools is used to construct a map. See \ref
map_building for further details.</p>

<p>See \ref theia_map for how to build a map with the external
Theia package and import it into Astrobee.</p>

<h3 id="visualization">Visualization</h3>

<p>To visualize a map, or just a list of images, use the command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nvm_visualize [ &lt;output.map&gt; ] [ &lt;image1.jpg&gt; &lt;image2.jpg&gt; ... ]
</code></pre></div></div>

<p>In the viewer, press <code class="language-plaintext highlighter-rouge">a</code> and <code class="language-plaintext highlighter-rouge">d</code> (or the left and right arrow keys, or
the Ins and Del keys on the num pad) to navigate through the
images. The current image being displayed will be echoed on the
command line. Press <code class="language-plaintext highlighter-rouge">c</code> to show the cameras and triangulated points in
3D. Press <code class="language-plaintext highlighter-rouge">q</code> to exit the viewer. Press ‘Home’ and ‘End’ to go 
to first and last image.</p>

<p>In <code class="language-plaintext highlighter-rouge">c</code> mode, press left and right to visualize the localization
results for the input image <code class="language-plaintext highlighter-rouge">imageN.jpg</code>. If no images are
passed in, the arrow keys display each frame of the map.</p>

<p>Also, in the <code class="language-plaintext highlighter-rouge">c</code> mode, when points and cameras are shown in 3D,
pressing <code class="language-plaintext highlighter-rouge">a</code> will save the current 3D pose to disk, while pressing <code class="language-plaintext highlighter-rouge">b</code>
will read a 3D pose from disk and apply it. This way, when two viewers
are open side by side, they can be made to show the results from the
same perspective.</p>

<p>The viewer can display just a subset of the cameras, using the <code class="language-plaintext highlighter-rouge">-first</code>
and <code class="language-plaintext highlighter-rouge">-last</code> options, and the size of cameras can be set with <code class="language-plaintext highlighter-rouge">-scale</code>.</p>

<p>Only the camera positions can be displayed, without the 3D points, if
the viewer is invoked with <code class="language-plaintext highlighter-rouge">-skip_3d_points</code>. The cameras can be made
to rotate around the center of mass of the cameras, rather than the
origin, using the <code class="language-plaintext highlighter-rouge">d</code> key. When in 3D view, rendering of thumbnails of
the images can be skipped, as that makes the viewer slow, with
‘-skip_3d_images’.</p>

<p>Clicking on an interest point with the middle mouse will display all
images in which that interest point was detected, with the interest
point in each of them shown as a red dot. Clicking back on the
original window with the middle mouse will make these images go away.</p>

<p>Clicking with the left mouse button on an image will print its name
and the pixel coordinates where the mouse hit. This can be useful in
collecting a subset of the images. (After clicking, a bug in OpenCV
disables the arrow keys, then one can navigate with the “Ins” and
“Del” keys on the numpad.)</p>

<p>This tool can be invoked to look at just images, without any map being
built. It can also delete images in this mode, with the ‘x’ key, if
invoked as:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nvm_visualize -enable_image_deletion &lt;image dir&gt;/*jpg
</code></pre></div></div>

<h3 id="localize-a-single-frame">Localize a single frame</h3>

<p>All the commands below assume that the environment was set up, 
as specified in the \ref map_building section.</p>

<p>To test localization of a single frame, use the command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>localize &lt;map.map&gt; &lt;image.jpg&gt; -histogram_equalization
</code></pre></div></div>

<p>If invoked with the option -verbose_localization, it will list the
images most similar to the one being localized. To increase the 
number of similar images, use the -num_similar option. Another
useful flag is –v 2 when it will print more verbose information.
Most of the options of the localize_cams tool (see below)
are also accepted.</p>

<h3 id="testing-localization-using-two-maps">Testing localization using two maps</h3>

<p>To test localization of many images, one can acquire two sets of
images of the same indoor environment, and create two maps ready for
localization. That is, maps are built, registered to the world
coordinate system, rebuilt with BRISK, and then a vocabulary database
is created. Name those maps reference and source.</p>

<p>For each image in the source map, one can localize it against the
reference map, and compare its camera position and orientation after
localization with the “known” position and orientation from the source
map.</p>

<p>This is not a fool-proof test, since neither of the two maps contains
measured ground truth, rather a simulated version of it, yet it can be
useful, assuming that maps are individually accurate enough and
well-registered.</p>

<p>This functionality is implemented in the localize_cams tool. Usage:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>localize_cams -num_similar 20 -ransac_inlier_tolerance 5      \
  -num_ransac_iterations 200 -min_brisk_features 400          \
  -max_brisk_features 800 -min_brisk_threshold 20             \
  -default_brisk_threshold 90 -max_brisk_threshold 110        \
  -detection_retries 5 -num_threads 2                         \
  -early_break_landmarks 100 -histogram_equalization          \
  -reference_map ref.map -source_map source.map
</code></pre></div></div>

<p>Here we use values that are different from</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ASTROBEE_SOURCE_PATH/astrobee/config/localization.config 
</code></pre></div></div>

<p>which are used for localization on the robot, since those are optimized
for speed and here we want more accuracy.</p>

<h3 id="testing-localization-using-a-bag">Testing localization using a bag</h3>

<p>See the \ref ekfbag page for how to study how well a BRISK map
with a vocabulary database does when localizing images from a bag.</p>

<h3 id="extract-sub-maps">Extract sub-maps</h3>

<p>The tool <code class="language-plaintext highlighter-rouge">extract_submap</code> can be used to extract a submap from a map,
containing only a specified list of images, or a given range of
image indices, or images with camera center in a given box. Usage:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>extract_submap -input_map &lt;input map&gt; -output_map &lt;output map&gt; \
  &lt;images to keep&gt;
</code></pre></div></div>

<p>or
    extract_submap -input_map <input map=""> -output_map <output map=""> \
      -image_list <file>
or
    extract_submap -input_map <input map=""> -output_map <output map=""> \
      -exclude <images to="" exclude=""></images></output></file></output></p>

<p>or</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>extract_submap -input_map &lt;input map&gt; -output_map &lt;output map&gt; \
  -cid_range "min_cid max_cid"
</code></pre></div></div>

<p>(here first image has cid = 0, and the range is inclusive at both
ends), or</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>extract_submap -input_map &lt;input map&gt; -output_map &lt;output map&gt; \
  -xyz_box "xmin xmax ymin ymax zmin zmax"
</code></pre></div></div>

<p>If it is desired to not re-adjust the cameras after the submap is
extracted (for example, if the map is already registered), use the
<code class="language-plaintext highlighter-rouge">-skip_bundle_adjustment</code> option.</p>

<p>If the input map has a vocabulary database of features, it will
need to be rebuilt for the extracted submap using</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>build_map -vocab_db
</code></pre></div></div>

<h3 id="merge-maps">Merge maps</h3>

<h4 id="general-usage">General usage</h4>

<p>Given a set of SURF maps, they can be merged using the command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>merge_maps &lt;input maps&gt; -output_map merged.map \
  -num_image_overlaps_at_endpoints 50
</code></pre></div></div>

<p>It is very important to note that only maps with SURF features (see
\ref map_building) can be merged. If a map has BRISK features, it
needs to be rebuilt with SURF features, as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  build_map -rebuild -histogram_equalization       \
    -rebuild_detector SURF -output_map &lt;output map&gt;
</code></pre></div></div>

<p>and then these regenerated maps can be merged.</p>

<p>Merging is more likely to succeed if the images at the endpoints of
one map are similar to images at the endpoints of the second map, and
in particular, if some of the same images show up at the endpoints of
both maps. A larger value of <code class="language-plaintext highlighter-rouge">-num_image_overlaps_at_endpoints</code> may
result in higher success but will take more time.</p>

<h4 id="registration-and-bundle-adjustment">Registration and bundle adjustment</h4>

<p>The input maps to be merged need not be registered, but that may help
improve the success of merging. Also, it may be preferable that
the images at the beginning and end of the maps to merge be close
to points used in registration. The implication here is that the
more geometrically correct the input maps are, and the more similar
to each other, the more likely merging will succeed.</p>

<p>Registration to the real-world coordinate system must be (re-)done
after the maps are merged, as the bundle adjustment done during merging
may move things somewhat.</p>

<p>After a merged map is created and registered, it can be rebuilt with
the BRISK detector to be used on the robot.</p>

<p>When manipulating many submaps, it is suggested that bundle adjustment
be skipped during merging, using the</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-skip_bundle_adjustment
</code></pre></div></div>

<p>option until the final map is computed, as this step can be
time-consuming. Bundle adjustment must happen however eventually,
before any map registration and rebuilding.</p>

<h4 id="keeping-first-map-fixed">Keeping first map fixed</h4>

<p>If there are only two maps to merge, and the first of the two maps to
merge is already registered, it may be desirable to keep that portion
fixed during merging when bundle adjustment happens, to avoid redoing
the registration, and perhaps to keep consistency with other work
already done, such as a dense map product.</p>

<p>Then, use the flag <code class="language-plaintext highlighter-rouge">-fix_first_map</code> when merging the maps. In this case,
if an image shows in both maps, then, once the maps are merged, the
camera poses of the shared images will be replaced with the ones from
the first map, before reoptimizing the remaining camera poses from the
second map.</p>

<h3 id="how-to-build-a-map-efficiently">How to build a map efficiently</h3>

<p>Often times map-building can take a long time, or it can fail. A
cautious way of building a map is to build it in portions (perhaps on
different machines), examine them, and merge them with <code class="language-plaintext highlighter-rouge">merge_maps</code>.</p>

<p>If map-building failed, parts of it could still be salvageable (one
can use nvm_visualize for inspection). Valid submaps can be extracted
with <code class="language-plaintext highlighter-rouge">extract_submap</code>. Then those can be merged with <code class="language-plaintext highlighter-rouge">merge_maps</code>.</p>

<p>When two maps to be merged overlap only in the middle, and they are
both large, the number -num_image_overlaps_at_endpoints will need to
be large which would make merging very slow. A very useful option can
then be the flag <code class="language-plaintext highlighter-rouge">-fast_merge</code> for this tool. It won’t create matches
among the two maps, but will instead identify the shared images among
the two maps thus merging the maps, if shared images exist.</p>

<p>If no such images are available, but the two maps do see the same
physical location in some portions (if from different views), each of
the two maps can be first merged with the same small map of that
shared location, and then the newly merged map which now will have
shared images can be merged with the <code class="language-plaintext highlighter-rouge">-fast_merge</code> flags.</p>

<p>The <code class="language-plaintext highlighter-rouge">-fast_merge</code> option assumes that a decent number of images
are shared among the maps, and that those cover a reasonably large
and representative portion of the desired environment, otherwise
it may not give accurate results. In either case, bundle adjustment
must be applied after the merge operations are done and before
registration, which can be done either with <code class="language-plaintext highlighter-rouge">merge_maps</code> or
<code class="language-plaintext highlighter-rouge">build_map</code>.</p>

<p>To summarize, with careful map surgery (extract submaps and merge
submaps) large maps can be made from smaller or damaged ones within
reasonable time.</p>

<p>All these operations should be applied on maps with SURF features.
Hence, the general approach for building large maps is to create small SURF
maps using the command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>build_map -feature_detection -feature_matching -track_building    \
 -incremental_ba -bundle_adjustment                               \
 -histogram_equalization -num_subsequent_images 100               \
 images/*jpg -output_map &lt;map file&gt;
</code></pre></div></div>

<p>Then, examine the maps individually, merge them as appropriate, and
perform bundle adjustment and registration as per the \ref
map_building section. Only when a good enough map is obtained, a
renamed copy of it should be rebuilt with BRISK features and a
vocabulary database to be used on the robot.</p>

<h3 id="map-strategy-for-the-space-station">Map strategy for the space station</h3>

<p>For the space station, there exists one large SURF map with many
images, and a small BRISK map with fewer images. If new images are
acquired, it is suggested several small maps be assembled from them,
and those be merged to the large SURF map.</p>

<p>The key idea here is to add some well-chosen subsequences of those new
images to the SURF map, but only a few, for which localization failed,
to the BRISK map. This is best illustrated by an example.</p>

<p>Say the large original SURF map had 2000 images, and the smaller BRISK
map had only 1400 images. Say 300 new images have been acquired, and
for 80 of them localization failed. So, things will change as follows:</p>

<ul>
  <li>SURF map goes from  2000 to 2000 + 300 = 2300 images</li>
  <li>BRISK map goes from 1400 to 1400 +  80 = 1480 images</li>
</ul>

<p>The precise details are described in the next section.</p>

<h3 id="growing-a-map-when-more-images-are-acquired">Growing a map when more images are acquired</h3>

<p>Sometimes things in the desired environment change enough, or the
lighting changes, and an existing map may no longer do as well in some
areas. Then, new images should be added to the map. The tool
grow_map.py can help with that.</p>

<p>First, out of the new images a set must be selected from which to
build a new map. We assume that the images in that set are further
broken up into several subsets, with each image in a subset
overlapping with the next one in that subset. For example, there can
exist a subset for the ceiling, one for the walls, etc.</p>

<p>A SURF map can be built for each subset, and those can be merged. (A
very useful option here can be -fast_merge.) Then, the new merged SURF
map can be merged with the earlier SURF map, and the combined map can
be bundle-adjusted and registered. While such a SURF map will be very
reliable, it will contain redundant information, so we will outline
below how to create a BRISK map that starts the same as the BRISK map
that existed before that, with only a minimum of images added for
which localization now fails. The new large SURF map will be used as
the source of the camera poses for the updated BRISK map, but the
latter will have fewer images.</p>

<p>We need some notation. Let prev_brisk_vocab_hist.map be the previous
BRISK map, before new images are added, prev_surf_registered.map be
the previous registered SURF map (that can have more images than
prev_brisk_vocab_hist.map). Let curr_surf_registered.map be the large
SURF map that is obtained from prev_surf_registered.map merged with
the images acquired this time, and curr_brisk_no_prune_hist.map be
obtained from curr_surf_registered.map using the -rebuild and
-histogram_equalization options. The prev_brisk_vocab_hist.map will
already be pruned and have a vocabulary database, but
curr_brisk_no_prune_hist.map is assumed to have none of these. Not
being pruned is very important. And again, all these maps must be
registered.</p>

<p>Let also list1.txt, …, listN.txt contain the images for those
subsets of new images mentioned earlier, such as list_wall.txt,
list_floor.txt, etc., with the order of images in this list be the
same as in the submap for the subset made from that list (which is the
same order as output by build_map -info). We will create a new BRISK
map, named curr_brisk_vocab_hist.map, that will be pruned and with a
vocabulary database (so ready to be used, just like
prev_brisk_vocab_hist.map) that will have only some of the new images
as follows:</p>

<ul>
  <li>Start with prev_brisk_vocab_hist.map</li>
  <li>Add all new images in list1.txt for which localization failed
against prev_brisk_vocab_hist.map, thus getting a map named curr1.map.</li>
  <li>Add all new images in list2.txt for which localization against
curr1.map failed.</li>
  <li>Etc.</li>
</ul>

<p>The logic here is very simple. Don’t add all new images at once. Add
them in batches, and for each batch remember the fact that the
previous batch already made the map better, so don’t add images from a
batch if they are not strictly necessary.</p>

<p>The following Python code implements this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python astrobee/src/localization/sparse_mapping/tools/grow_map.py \
  -histogram_equalization -small_map prev_brisk_vocab_hist.map    \
  -big_map curr_brisk_no_prune_hist.map -work_dir work            \
  -output_map curr_brisk_vocab_hist.map                           \
  list1.txt list2.txt ... listN.txt
</code></pre></div></div>

<p>After this is finished, the work directory can be wiped.</p>

<p>It is very important to never remove like this images from the SURF
map. This can result in this map breaking into disconnected sets when
being bundle adjusted. If desired to make the SURF map smaller, one
should examine the submaps it is made of (typically each submap has
its images in a subdirectory), and then one should carefully study
which submap (or portions of it) are not necessary for the whole map’s
cohesiveness.</p>

<p>Also note that the grow_map.py script takes a lot of other parameters
on input that must be the same as in localization.config.</p>

<h3 id="reducing-the-number-of-images-in-a-map">Reducing the number of images in a map</h3>

<p>Sometimes a map has too many similar images. The tool reduce_map.py
attempts to reduce their number without sacrificing the map quality.</p>

<p>To use this feature, it is very important that the input map is not
pruned. This map should be made of of BRISK features and registered. It
need not have a vocab db.</p>

<p>Usage:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python astrobee/src/localization/sparse_mapping/tools/reduce_map.py \
  -input_map &lt;input map&gt; -min_brisk_threshold &lt;val&gt;                 \
  -default_brisk_threshold &lt;val&gt; -max_brisk_threshold &lt;val&gt;         \
  -localization_error &lt;val&gt; -work_dir &lt;work dir&gt;                    \
  -sample_rate &lt;val&gt; -histogram_equalization
</code></pre></div></div>

<p>The BRISK thresholds here must be as when the map was built (ideally
like in localization.config). The -histogram_equalization flag is
necessary if your map was built with it.</p>

<p>A sequence of ever-smaller output maps are saved in the work
directory. They are pruned maps, with a vocabulary database, unlike
the input unpruned map.</p>

<p>The algorithm is as follows. Randomly remove a fraction (stored in
-sample_rate, typically 1/4th) of images form a map. Localize the
images from the full map against the images of the reduced map. Images
for which localization fails with more than a given error (typically 2
cm) are added back to the reduced map. This is repeated until no more
images need adding.</p>

<p>The reduced map is written to</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;work_dir&gt;/submap_iter0.map
</code></pre></div></div>

<p>Then more images are taken out of the map and all the previous process
is repeated (this is called the outer iteration), each time obtaining
a smaller map named</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;work_dir&gt;/submap_iter&lt;outer iter&gt;.map
</code></pre></div></div>

<p>One should carefully evaluate these output maps. Likely after a couple
of attempts the quality of the map may start degrading. To use
more attempts, set the value of the -attempts variable.</p>

<p>Instead of taking images out of the map randomly, one can start with a
reduced map with a small list of desired images which can be set with
-image_list, and then all images for which localization fails will be
added back to it.</p>

<p>\subpage build_map_from_multiple_bags
\subpage map_building
\subpage total_station
\subpage granite_lab_registration
\subpage faro
\subpage theia_map
\subpage import_map
\subpage export_map
\subpage merge_bags</p>
</div>
              </div>
            </div>
          </div>
        </div>
      
    
    <div class="row">
      <div class="col-xs-12">
        <div class="panel panel-default">
          <div class="panel-heading"><span class="glyphicon glyphicon-list"></span> CHANGELOG</div>
          <div class="panel-body">
            
              <em>No CHANGELOG found.</em>
            
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-pane" id="melodic-tutorials">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Wiki Tutorials</h3>
      </div>
      <div class="panel-body">
        
        <em>This package does not provide any links to tutorials in it's <a href="https://index.ros.org/contribute/metadata/">rosindex metadata</a>.</em>
        <em>You can check on the <a href="http://wiki.ros.org/sparse_mapping/Tutorials" target="_blank">ROS Wiki Tutorials</a> page for the package.</em>
        
      </div>
    </div>
  </div>

  <div class="tab-pane" id="melodic-deps">
    <div class="row">
      <div class="col-sm-6">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Package Dependencies</h3>
          </div>
          <div class="panel-body">
            
              <table class="table table-condensed table-striped">
                <thead>
                  <th class="text-center">Deps</th>
                  <th style="width: 100%">Name</th>
                </thead>
                <tbody>
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/ff_msgs#melodic-deps" >
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/ff_msgs#melodic">ff_msgs  </a></td>
                      </tr>
                    
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/ff_common#melodic-deps" >
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/ff_common#melodic">ff_common  </a></td>
                      </tr>
                    
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/camera#melodic-deps" >
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/camera#melodic">camera  </a></td>
                      </tr>
                    
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/roscpp#melodic-deps" >
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/roscpp#melodic">roscpp  </a></td>
                      </tr>
                    
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/interest_point#melodic-deps" >
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/interest_point#melodic">interest_point  </a></td>
                      </tr>
                    
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/config_reader#melodic-deps" >
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/config_reader#melodic">config_reader  </a></td>
                      </tr>
                    
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/localization_common#melodic-deps" >
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/localization_common#melodic">localization_common  </a></td>
                      </tr>
                    
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/vision_common#melodic-deps" >
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/vision_common#melodic">vision_common  </a></td>
                      </tr>
                    
                  
                    
                    
                      <tr>
                        <td class="text-center">
                          
                          <a href="/p/catkin#melodic-deps" class="endoftree">
                            <span class="glyphicon glyphicon-arrow-left" title="Package dependencies"></span>
                          </a>
                        </td>
                        <td><a href="/p/catkin#melodic">catkin  </a></td>
                      </tr>
                    
                  
                </tbody>
              </table>
            
          </div>
          <div class="panel-heading">
            <h3 class="panel-title">System Dependencies</h3>
          </div>
          <div class="panel-body">
            
              <em>No direct system dependencies.</em>
            
          </div>
        </div>
      </div>

      <div class="col-sm-6">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Dependant Packages</h3>
          </div>
          <div class="panel-body">
            
              <table class="table table-condensed table-striped">
                <thead>
                  <th>Name</th>
                  <th class="text-center">Deps</th>
                </thead>
                <tbody>
                  
                    
                    
                    <tr>
                      <td><a href="/p/localization_node#melodic">localization_node</a></td>
                      <td class="text-center">
                        
                        <a href="/p/localization_node#melodic-deps" >
                          <span class="glyphicon glyphicon-arrow-right"></span>
                        </a>
                      </td>
                    </tr>
                    
                  
                </tbody>
              </table>
            
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-pane" id="melodic-assets">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Launch files</h3>
      </div>
      <div class="panel-body">
        
          <em>No launch files found</em>
        
      </div>
    </div>

    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Messages</h3>
      </div>
      <div class="panel-body">
        
          <em>No message files found.</em>
        
      </div>
    </div>

    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Services</h3>
      </div>
      <div class="panel-body">
        
          <em>No service files found</em>
        
      </div>
    </div>

    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Plugins</h3>
      </div>
      <div class="panel-body">
        
          <em>No plugins found.</em>
        
      </div>
    </div>
  </div>

  <div class="tab-pane" id="melodic-questions">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Recent questions tagged <kbd>sparse_mapping</kbd> at <strong><a href="https://robotics.stackexchange.com/" target="_blank">Robotics Stack Exchange</a></strong></h3>      </div>
      <div id="melodic-question-list" class="panel-body" style="display: none;"></div>
      <div id="melodic-no-question-list" class="panel-body" style="display: none;">
        <p>No questions yet, you can ask one <a href="https://robotics.stackexchange.com/questions/tagged/sparse_mapping+melodic">here</a>.</p>
      </div>
      <div id="melodic-get-question-fail" class="panel-body alert alert-warning" style="display: none;">
        <p>Failed to get question list, you can ticket an issue <a href="https://github.com/ros-infrastructure/rosindex/issues/new" target="_blank" class="alert-link">here</a> </p>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript" src="/js/package_body_tabs.js"></script>

<script src=/js/contribution_suggestions.js></script>
<script type="text/javascript">
jQuery(function() {
    // Update the count on the links to the contribution suggestions
    updateContributionSuggestionsCountOnPackage('https://github.com/nasa/astrobee.git');
});
</script>

          </div>
          <div class="col-md-2 hidden-xs hidden-sm">
            
            
            



<div class="list-group list-group-sm ">
  <a class="list-group-item"
     target="_blank"
     href="http://docs.ros.org/en/melodic/api/sparse_mapping/html/"
     title="View API documentation on docs.ros.org"
     >
       <span style="margin-right: 5px;" class="glyphicon glyphicon-file"></span>
       
       API Docs
  </a>
  <a class="list-group-item"
     target="_blank"
     href="https://github.com/nasa/astrobee/tree/master/localization/sparse_mapping"
     title="View source code on repository">
       <span class="glyphicon glyphicon-folder-open" style="margin-right:5px;"></span>
       
       Browse Code
  </a>
  
  
  
  
  
  <a class="list-group-item "
     target="_blank"
     href="http://wiki.ros.org/sparse_mapping?distro=melodic"
     title="View this package on wiki.ros.org">
       <span style="margin-right: 5px;" class="glyphicon glyphicon-info-sign"></span>
       
       Wiki
  </a>
  
  
</div>

          </div>
        </div>
      
    </div>
  </div>



<script id="question-list-template" type="text/html">
  <p>
    Browse <a href="https://robotics.stackexchange.com/questions/tagged/sparse_mapping?tab=Newest">recent questions</a>
    or see the <a href="https://robotics.stackexchange.com/questions/tagged/sparse_mapping?tab=Votes">highest voted ones</a>.
  </p>
  
  <table class="table table-striped">
    <thead>
      <tr>
        <th scope="col">Title</th>
        <th scope="col">Answered?</th>
        <th scope="col">Created</th>
        <th scope="col">Active</th>
      </tr>
    </thead>
    <tbody>
      {{#questions}}
      <tr>
        <th scope="row"><a href="{{link}}">{{title}}</a><br><small>Tags: {{strtags}}</small></th>
        <th>{{answered}}</th>
        <th>{{created}}</th>
        <th>{{active}}</th>
      </tr>
      {{/questions}}
    </tbody>
  </table>
  {{#has_more}}
  <hr>
  <h4>Additional questions are available at
    <a href="https://robotics.stackexchange.com/questions/tagged/{{name}}?tab=Newest">Robotics Stack Exchange</a>
  </h4>
  {{/has_more}}
  
</script>

<script type="text/javascript" src="/js/mustache.js"></script>
<script type="text/javascript">
  jQuery(function() {
    jQuery.getJSON(url="https://api.stackexchange.com/2.3/questions?order=desc&site=robotics" +
                       "&tagged=sparse_mapping&pagesize=50&sort=activity")
    .done(function(feed) {
      if (feed.items.length > 0) {
        var question_count_str = (feed.has_more ? '>' : '') + String(feed.items.length)
        const questions = feed.items.map(
          function(question) {
            question.id = Math.round(Math.random() * 99999.0);
            question.created = (new Date(question.creation_date * 1000)).toDateString()
            question.active = (new Date(question.last_activity_date * 1000)).toDateString()
            question.answered = question.is_answered ? "Yes" : "No"
            question.strtags = question.tags.join(' ')
            return question;
          });
        const template = jQuery("#question-list-template").text();
        Mustache.parse(template);
        var rendered = Mustache.render(
          template, 
          { questions: questions,
            has_more: feed.has_more,
            name: "sparse_mapping"
          }
        );
      }
      //   TODO(tfoote) Resolve images
      //   jQuery("#-question-list img").each(function() {
      //     if (jQuery(this).attr("src").startsWith("/upfiles")) {
      //        jQuery(this).attr("src", "https://answers.ros.org" + jQuery(this).attr("src"));
      //     }
      //   });
      
      if (feed.items.length > 0) {
        jQuery("#humble-question-list").html(rendered);
        jQuery("#humble-question-list").show();
      } else {
        jQuery("#humble-no-question-list").show();
      }
      jQuery("#humble-questions-count").text(question_count_str);
      
      if (feed.items.length > 0) {
        jQuery("#jazzy-question-list").html(rendered);
        jQuery("#jazzy-question-list").show();
      } else {
        jQuery("#jazzy-no-question-list").show();
      }
      jQuery("#jazzy-questions-count").text(question_count_str);
      
      if (feed.items.length > 0) {
        jQuery("#kilted-question-list").html(rendered);
        jQuery("#kilted-question-list").show();
      } else {
        jQuery("#kilted-no-question-list").show();
      }
      jQuery("#kilted-questions-count").text(question_count_str);
      
      if (feed.items.length > 0) {
        jQuery("#rolling-question-list").html(rendered);
        jQuery("#rolling-question-list").show();
      } else {
        jQuery("#rolling-no-question-list").show();
      }
      jQuery("#rolling-questions-count").text(question_count_str);
      
      if (feed.items.length > 0) {
        jQuery("#github-question-list").html(rendered);
        jQuery("#github-question-list").show();
      } else {
        jQuery("#github-no-question-list").show();
      }
      jQuery("#github-questions-count").text(question_count_str);
      
      if (feed.items.length > 0) {
        jQuery("#noetic-question-list").html(rendered);
        jQuery("#noetic-question-list").show();
      } else {
        jQuery("#noetic-no-question-list").show();
      }
      jQuery("#noetic-questions-count").text(question_count_str);
      
      if (feed.items.length > 0) {
        jQuery("#galactic-question-list").html(rendered);
        jQuery("#galactic-question-list").show();
      } else {
        jQuery("#galactic-no-question-list").show();
      }
      jQuery("#galactic-questions-count").text(question_count_str);
      
      if (feed.items.length > 0) {
        jQuery("#iron-question-list").html(rendered);
        jQuery("#iron-question-list").show();
      } else {
        jQuery("#iron-no-question-list").show();
      }
      jQuery("#iron-questions-count").text(question_count_str);
      
      if (feed.items.length > 0) {
        jQuery("#melodic-question-list").html(rendered);
        jQuery("#melodic-question-list").show();
      } else {
        jQuery("#melodic-no-question-list").show();
      }
      jQuery("#melodic-questions-count").text(question_count_str);
      
    })
    .fail(function(jqxhr, textStatus, error) {
      console.error("Failed to get question data: " + jqxhr.responseText);
      
      jQuery("#humble-get-question-fail").show();
      
      jQuery("#jazzy-get-question-fail").show();
      
      jQuery("#kilted-get-question-fail").show();
      
      jQuery("#rolling-get-question-fail").show();
      
      jQuery("#github-get-question-fail").show();
      
      jQuery("#noetic-get-question-fail").show();
      
      jQuery("#galactic-get-question-fail").show();
      
      jQuery("#iron-get-question-fail").show();
      
      jQuery("#melodic-get-question-fail").show();
      
    });
  });
</script>


<script type="text/javascript">
  $(document).ready(function() {
    setupDistroSwitch("humble");
  });
</script>

      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="container-fluid">
      <div style="float:left;">
        
          <a href="https://github.com/rkent/rosindex" title="Find rosindex in Github">
          <span class="icon  icon--github">
            <svg viewBox="0 0 16 16">
              <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
            </svg>
          </span>

          <span class="username">rkent/rosindex</span>
        </a>
        <em class="hidden-xs">| generated on 2025-05-05</em>
      
      </div>
      <div style="float:right;">
        <p class="text"><span class="hidden-xs">a community-maintained index of robotics software
 | </span><a href="/privacy.txt">privacy</a></p>
      </div>
    </div>
  </div>

</footer>


  </body>

</html>
